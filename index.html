<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TQIMS ‚Äî Quality Inspection Management System</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap');

:root{
  /* ‚îÄ‚îÄ Core Palette ‚îÄ‚îÄ */
  --bg:#f0f2f5;
  --surf:#ffffff;
  --surf2:#f7f8fa;
  --surf3:#eef0f4;
  --border:#dde1e8;
  --border2:#c8cdd8;

  /* ‚îÄ‚îÄ Brand Blue ‚îÄ‚îÄ */
  --blue:#1a56db;
  --blue2:#2563eb;
  --blue-lt:#dbeafe;
  --blue-mid:#93c5fd;

  /* ‚îÄ‚îÄ Status Colors ‚îÄ‚îÄ */
  --green:#16a34a;
  --green-lt:#dcfce7;
  --amber:#b45309;
  --amber-lt:#fef3c7;
  --red:#dc2626;
  --red-lt:#fee2e2;
  --purple:#7c3aed;
  --purple-lt:#ede9fe;
  --cyan:#0891b2;
  --cyan-lt:#cffafe;
  --sky:#0284c7;

  /* ‚îÄ‚îÄ Text ‚îÄ‚îÄ */
  --text:#111827;
  --text2:#374151;
  --text3:#6b7280;
  --text4:#9ca3af;
  --textinv:#ffffff;

  /* ‚îÄ‚îÄ Shadows ‚îÄ‚îÄ */
  --shadow-sm:0 1px 3px rgba(0,0,0,.08),0 1px 2px rgba(0,0,0,.05);
  --shadow:0 4px 6px rgba(0,0,0,.07),0 2px 4px rgba(0,0,0,.05);
  --shadow-lg:0 10px 25px rgba(0,0,0,.1),0 4px 10px rgba(0,0,0,.06);
}

*{box-sizing:border-box;margin:0;padding:0;}
html{scroll-behavior:smooth;}
body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);font-size:14px;line-height:1.6;}

/* ‚îÄ‚îÄ SCREENS ‚îÄ‚îÄ */
.scr{display:none;}
.scr.on{display:block;}

/* ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ */
#scr-auth{min-height:100vh;display:none;align-items:center;justify-content:center;padding:24px 16px;background:linear-gradient(135deg,#1e3a5f 0%,#1a56db 50%,#0891b2 100%);}
#scr-auth.on{display:flex;}
.acard{background:var(--surf);border:none;width:100%;max-width:460px;padding:36px 32px;position:relative;margin:auto;border-radius:12px;box-shadow:var(--shadow-lg);}
.acard::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:linear-gradient(90deg,var(--blue),var(--cyan));border-radius:12px 12px 0 0;}
.logo-big{font-family:'Inter',sans-serif;font-size:32px;font-weight:700;letter-spacing:3px;color:var(--blue2);margin-bottom:2px;}
.logo-sub{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text3);letter-spacing:2px;text-transform:uppercase;margin-bottom:28px;}
.atabs{display:flex;background:var(--surf2);border-radius:8px;padding:3px;margin-bottom:24px;gap:2px;}
.atab{flex:1;padding:9px;text-align:center;cursor:pointer;font-family:'Inter',sans-serif;font-size:12px;font-weight:600;letter-spacing:.5px;text-transform:uppercase;color:var(--text3);transition:all .2s;border:none;background:none;border-radius:6px;}
.atab.on{background:var(--surf);color:var(--blue2);box-shadow:var(--shadow-sm);}
.aform{display:none;flex-direction:column;gap:14px;}
.aform.on{display:flex;}
.lbl{font-size:11px;font-weight:600;color:var(--text2);letter-spacing:.3px;display:block;margin-bottom:5px;}
input,select,textarea{width:100%;background:var(--surf2);border:1.5px solid var(--border);color:var(--text);padding:10px 12px;font-family:'Inter',sans-serif;font-size:13px;outline:none;transition:all .2s;border-radius:7px;}
input:focus,select:focus,textarea:focus{border-color:var(--blue2);background:var(--surf);box-shadow:0 0 0 3px rgba(37,99,235,.12);}
select option{background:var(--surf);}
textarea{resize:vertical;min-height:64px;}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.span2{grid-column:1/-1;}
.rchips{display:flex;gap:8px;flex-wrap:wrap;}
.rchip{flex:1;padding:9px 10px;text-align:center;border:1.5px solid var(--border);color:var(--text3);background:var(--surf2);cursor:pointer;font-family:'Inter',sans-serif;font-size:12px;font-weight:600;letter-spacing:.3px;text-transform:uppercase;transition:all .2s;border-radius:7px;}
.rchip.on{border-color:var(--blue2);background:var(--blue-lt);color:var(--blue2);}
.btn{padding:11px 22px;font-family:'Inter',sans-serif;font-size:13px;font-weight:600;letter-spacing:.3px;cursor:pointer;border:none;transition:all .2s;border-radius:8px;display:inline-block;}
.btn-w{width:100%;}
.btn-blue{background:var(--blue2);color:#fff;box-shadow:0 2px 6px rgba(37,99,235,.3);}
.btn-blue:hover{background:var(--blue);box-shadow:0 4px 12px rgba(37,99,235,.4);}
.btn-green{background:var(--green);color:#fff;}
.btn-red{background:var(--red);color:#fff;}
.btn-amber{background:var(--amber);color:#fff;}
.btn-ghost{background:none;border:1.5px solid var(--border2);color:var(--text2);}
.btn-ghost:hover{border-color:var(--blue2);color:var(--blue2);background:var(--blue-lt);}
.alink{text-align:center;font-size:12px;color:var(--text3);margin-top:4px;}
.alink a{color:var(--blue2);cursor:pointer;text-decoration:none;font-weight:500;}
.alink a:hover{text-decoration:underline;}
.msg{font-size:12px;padding:10px 14px;border:1.5px solid;border-radius:7px;font-weight:500;}
.msg-err{color:#991b1b;border-color:#fca5a5;background:#fee2e2;}
.msg-ok{color:#166534;border-color:#86efac;background:#dcfce7;}
.msg-warn{color:#92400e;border-color:#fcd34d;background:#fef3c7;}
.credit{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--text4);text-align:center;margin-top:20px;letter-spacing:1px;}

/* ‚îÄ‚îÄ APP SHELL ‚îÄ‚îÄ */
#scr-app{display:none;min-height:100vh;flex-direction:column;}
#scr-app.on{display:flex;}
.topbar{display:flex;align-items:center;justify-content:space-between;background:var(--surf);border-bottom:1px solid var(--border);padding:0 20px;height:56px;position:sticky;top:0;z-index:300;flex-shrink:0;box-shadow:var(--shadow-sm);}
.tb-left{display:flex;align-items:center;gap:14px;}
.tb-logo{font-family:'Inter',sans-serif;font-size:18px;font-weight:700;letter-spacing:2px;color:var(--blue2);}
.tb-logo span{color:var(--text3);font-weight:400;font-size:11px;letter-spacing:1px;margin-left:4px;vertical-align:middle;}
.ham{background:none;border:none;color:var(--text3);font-size:20px;cursor:pointer;padding:6px;display:none;border-radius:6px;}
.ham:hover{background:var(--surf2);}
.tb-right{display:flex;align-items:center;gap:10px;}
.rpill{font-family:'Inter',sans-serif;font-size:10px;font-weight:600;padding:4px 10px;border:1.5px solid;letter-spacing:.5px;text-transform:uppercase;border-radius:20px;}
.rp-admin{color:#92400e;border-color:#f59e0b;background:#fef3c7;}
.rp-production{color:#1e40af;border-color:#60a5fa;background:#dbeafe;}
.rp-quality{color:#166534;border-color:#4ade80;background:#dcfce7;}
.rp-manager{color:#5b21b6;border-color:#a78bfa;background:#ede9fe;}
.tb-user{font-family:'Inter',sans-serif;font-size:12px;font-weight:500;color:var(--text2);}
.tb-logout{background:none;border:1.5px solid var(--border);color:var(--text3);padding:6px 14px;font-family:'Inter',sans-serif;font-size:11px;font-weight:600;letter-spacing:.3px;cursor:pointer;border-radius:7px;transition:all .2s;}
.tb-logout:hover{border-color:var(--red);color:var(--red);background:var(--red-lt);}

/* ‚îÄ‚îÄ BODY LAYOUT ‚îÄ‚îÄ */
.app-body{display:flex;flex:1;}
.sidebar{width:230px;background:var(--surf);border-right:1px solid var(--border);padding:16px 8px;flex-shrink:0;position:sticky;top:56px;height:calc(100vh - 56px);overflow-y:auto;transition:transform .3s;box-shadow:none;}
.sg-lbl{font-family:'Inter',sans-serif;font-size:10px;font-weight:700;color:var(--text4);letter-spacing:1px;text-transform:uppercase;padding:12px 12px 6px;}
.nitem{display:flex;align-items:center;gap:10px;padding:9px 12px;cursor:pointer;color:var(--text3);font-size:13px;font-weight:500;transition:all .15s;border-radius:8px;margin:1px 0;}
.nitem:hover{background:var(--surf2);color:var(--text2);}
.nitem.on{background:var(--blue-lt);color:var(--blue2);font-weight:600;}
.nitem .ni{font-size:16px;width:20px;text-align:center;}
.nbadge{margin-left:auto;background:var(--amber);color:#fff;font-family:'Inter',sans-serif;font-size:9px;padding:2px 6px;font-weight:700;border-radius:10px;min-width:18px;text-align:center;}
.sov{display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:299;}

/* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
.main{flex:1;padding:24px;min-width:0;overflow-x:hidden;}

/* ‚îÄ‚îÄ PAGES ‚îÄ‚îÄ */
.pg{display:none;}
.pg.on{display:block;}
.pgh{margin-bottom:22px;padding-bottom:16px;border-bottom:1px solid var(--border);}
.pgt{font-family:'Inter',sans-serif;font-size:20px;font-weight:700;color:var(--text);}
.pgs{font-size:12px;color:var(--text3);margin-top:3px;}

/* ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ */
.card{background:var(--surf);border:1px solid var(--border);padding:18px;margin-bottom:16px;border-radius:10px;box-shadow:var(--shadow-sm);}
.chead{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap;gap:8px;}
.ctitle{font-family:'Inter',sans-serif;font-size:13px;font-weight:700;letter-spacing:.3px;text-transform:uppercase;color:var(--text2);}

/* ‚îÄ‚îÄ STATS ‚îÄ‚îÄ */
.sgrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:12px;margin-bottom:20px;}
.sbox{background:var(--surf);border:1px solid var(--border);padding:16px;position:relative;border-radius:10px;overflow:hidden;box-shadow:var(--shadow-sm);}
.sbox::before{content:'';position:absolute;top:0;left:0;bottom:0;width:4px;border-radius:10px 0 0 10px;}
.sb-blue::before{background:var(--blue2);}
.sb-green::before{background:var(--green);}
.sb-amber::before{background:var(--amber);}
.sb-red::before{background:var(--red);}
.sb-grey::before{background:var(--text4);}
.sbox::after{display:none;}
.snum{font-family:'Inter',sans-serif;font-size:30px;font-weight:700;line-height:1;margin-bottom:4px;padding-left:6px;}
.slbl{font-family:'Inter',sans-serif;font-size:10px;font-weight:600;color:var(--text3);letter-spacing:.5px;text-transform:uppercase;padding-left:6px;}

/* ‚îÄ‚îÄ PROGRESS ‚îÄ‚îÄ */
.pbar{width:100%;height:5px;background:var(--surf3);border-radius:4px;overflow:hidden;}
.pfill{height:100%;background:linear-gradient(90deg,var(--blue2),var(--cyan));transition:width .4s;border-radius:4px;}

/* ‚îÄ‚îÄ PROJECT BAR ‚îÄ‚îÄ */
.projbar{display:flex;flex-wrap:wrap;gap:20px;background:var(--surf);border:1px solid var(--border);padding:14px 18px;margin-bottom:20px;border-radius:10px;box-shadow:var(--shadow-sm);}
.pf-lbl{font-size:10px;font-weight:600;color:var(--text4);letter-spacing:.5px;text-transform:uppercase;}
.pf-val{font-family:'Inter',sans-serif;font-size:14px;font-weight:600;color:var(--blue2);margin-top:1px;}

/* ‚îÄ‚îÄ SECTION TABS ‚îÄ‚îÄ */
.stabs{display:flex;border-bottom:2px solid var(--border);flex-wrap:wrap;margin-bottom:18px;gap:0;overflow-x:auto;}
.stab{padding:9px 18px;cursor:pointer;font-family:'Inter',sans-serif;font-size:12px;font-weight:600;letter-spacing:.3px;text-transform:uppercase;color:var(--text3);border-bottom:2px solid transparent;margin-bottom:-2px;white-space:nowrap;transition:all .2s;}
.stab:hover{color:var(--text2);}
.stab.on{color:var(--blue2);border-bottom-color:var(--blue2);}

/* ‚îÄ‚îÄ DASHBOARD SEAM GRID ‚îÄ‚îÄ */
.dash-section{margin-bottom:26px;}
.dash-sec-title{font-family:'Inter',sans-serif;font-size:14px;font-weight:700;letter-spacing:.5px;text-transform:uppercase;color:var(--text2);padding:8px 0;border-bottom:2px solid var(--border);margin-bottom:14px;display:flex;align-items:center;justify-content:space-between;}
.seam-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(170px,1fr));gap:10px;}
.seam-tile{background:var(--surf);border:1.5px solid var(--border);padding:14px;cursor:pointer;transition:all .2s;border-radius:10px;position:relative;box-shadow:var(--shadow-sm);}
.seam-tile:hover{border-color:var(--blue2);box-shadow:var(--shadow);transform:translateY(-1px);}
.seam-tile.st-done{border-left:4px solid var(--green);}
.seam-tile.st-active{border-left:4px solid var(--amber);}
.seam-tile.st-rejected{border-left:4px solid var(--red);}
.seam-tile.st-pending{border-left:4px solid var(--border2);}
.st-seam-num{font-family:'JetBrains Mono',monospace;font-size:11px;font-weight:500;color:var(--blue2);margin-bottom:4px;}
.st-seam-desc{font-size:11px;color:var(--text3);margin-bottom:8px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.st-seam-pct{font-family:'Inter',sans-serif;font-size:20px;font-weight:700;color:var(--text);}
.st-seam-meta{font-size:10px;color:var(--text4);margin-top:2px;}
.ncr-dot{position:absolute;top:8px;right:8px;width:8px;height:8px;background:var(--red);border-radius:50%;box-shadow:0 0 0 2px var(--red-lt);}

/* ‚îÄ‚îÄ INSPECTION / SEAM DETAIL ‚îÄ‚îÄ */
.seam-detail-card{background:var(--surf);border:1px solid var(--border);margin-bottom:14px;border-radius:10px;overflow:hidden;box-shadow:var(--shadow-sm);}
.sdh{padding:14px 18px;background:var(--surf2);border-bottom:1px solid var(--border);display:flex;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;gap:8px;}
.sd-num{font-family:'JetBrains Mono',monospace;font-size:13px;color:var(--blue2);font-weight:600;}
.sd-desc{font-size:12px;color:var(--text2);margin-top:2px;}
.sd-meta{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--text3);margin-top:4px;}
.stage-row{display:flex;align-items:flex-start;gap:12px;padding:12px 18px;border-bottom:1px solid var(--border);}
.stage-row:last-child{border-bottom:none;}
.sr-num{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text4);width:20px;flex-shrink:0;padding-top:2px;font-weight:600;}
.sr-info{flex:1;min-width:0;}
.sr-name{font-size:13px;font-weight:600;color:var(--text);}
.sr-detail{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--text3);margin-top:4px;line-height:1.7;}
.sr-remark{font-size:11px;margin-top:4px;padding:4px 8px;border-radius:4px;}
.sr-actions{flex-shrink:0;display:flex;flex-direction:column;align-items:flex-end;gap:5px;}

/* ‚îÄ‚îÄ CHIPS ‚îÄ‚îÄ */
.chip{display:inline-flex;align-items:center;gap:3px;padding:3px 8px;font-family:'Inter',sans-serif;font-size:10px;font-weight:600;letter-spacing:.3px;border:1.5px solid;text-transform:uppercase;border-radius:20px;white-space:nowrap;}
.ch-pend{color:var(--text3);border-color:var(--border2);background:var(--surf3);}
.ch-off{color:var(--amber);border-color:#f59e0b;background:var(--amber-lt);}
.ch-acc{color:var(--green);border-color:#4ade80;background:var(--green-lt);}
.ch-rej{color:var(--red);border-color:#f87171;background:var(--red-lt);}
.ch-lock{color:var(--text3);border-color:var(--border2);background:var(--surf3);}
.ch-ret{color:var(--sky);border-color:#7dd3fc;background:var(--cyan-lt);}
.ch-ncr{color:var(--purple);border-color:#a78bfa;background:var(--purple-lt);}

/* ‚îÄ‚îÄ ACTION BTNS ‚îÄ‚îÄ */
.abtn{padding:5px 12px;font-family:'Inter',sans-serif;font-size:11px;font-weight:600;letter-spacing:.3px;border:1.5px solid;background:none;cursor:pointer;transition:all .2s;white-space:nowrap;text-transform:uppercase;border-radius:6px;}
.ab-blue{color:var(--blue2);border-color:var(--blue2);}
.ab-blue:hover{background:var(--blue-lt);}
.ab-green{color:var(--green);border-color:var(--green);}
.ab-green:hover{background:var(--green-lt);}
.ab-red{color:var(--red);border-color:var(--red);}
.ab-red:hover{background:var(--red-lt);}
.ab-amber{color:var(--amber);border-color:var(--amber);}
.ab-amber:hover{background:var(--amber-lt);}
.ab-ghost{color:var(--text3);border-color:var(--border);}
.ab-ghost:hover{color:var(--text2);border-color:var(--border2);background:var(--surf2);}

/* ‚îÄ‚îÄ TABLES ‚îÄ‚îÄ */
.tbl-wrap{overflow-x:auto;}
table{width:100%;border-collapse:collapse;font-size:12px;min-width:400px;}
th{background:var(--surf2);padding:10px 14px;text-align:left;font-family:'Inter',sans-serif;font-size:10px;font-weight:700;letter-spacing:.5px;text-transform:uppercase;color:var(--text3);border-bottom:2px solid var(--border);white-space:nowrap;}
td{padding:10px 14px;border-bottom:1px solid var(--border);vertical-align:middle;font-size:13px;}
tr:hover td{background:var(--surf2);}

/* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
.mbg{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:500;align-items:flex-start;justify-content:center;padding:20px;overflow-y:auto;backdrop-filter:blur(4px);}
.mbg.on{display:flex;}
.modal{background:var(--surf);border:1px solid var(--border);width:100%;max-width:520px;position:relative;border-radius:12px;margin:auto;box-shadow:var(--shadow-lg);}
.modal::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:linear-gradient(90deg,var(--blue2),var(--cyan));border-radius:12px 12px 0 0;}
.mhead{padding:18px 22px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;}
.mtitle{font-family:'Inter',sans-serif;font-size:16px;font-weight:700;letter-spacing:.3px;}
.mclose{background:none;border:none;color:var(--text3);font-size:20px;cursor:pointer;line-height:1;padding:2px 6px;border-radius:5px;transition:all .2s;}
.mclose:hover{background:var(--surf2);color:var(--red);}
.mbody{padding:22px;}
.mfoot{padding:14px 22px;border-top:1px solid var(--border);display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap;background:var(--surf2);border-radius:0 0 12px 12px;}
.ir{display:flex;justify-content:space-between;align-items:flex-start;padding:7px 0;border-bottom:1px solid var(--border);gap:10px;}
.ir:last-child{border-bottom:none;}
.ir-k{font-size:11px;font-weight:600;color:var(--text3);letter-spacing:.3px;flex-shrink:0;min-width:110px;}
.ir-v{font-size:13px;font-weight:500;text-align:right;color:var(--text);}

/* ‚îÄ‚îÄ FILTER CHIPS ‚îÄ‚îÄ */
.fchip{padding:5px 14px;font-family:'Inter',sans-serif;font-size:11px;font-weight:600;letter-spacing:.3px;border:1.5px solid var(--border);background:var(--surf);color:var(--text3);cursor:pointer;transition:all .2s;border-radius:20px;white-space:nowrap;}
.fchip:hover{border-color:var(--blue2);color:var(--blue2);background:var(--blue-lt);}
.fchip.on{background:var(--blue-lt);border-color:var(--blue2);color:var(--blue2);}

/* ‚îÄ‚îÄ BACK BUTTON ‚îÄ‚îÄ */
.back-btn{display:inline-flex;align-items:center;gap:6px;font-size:12px;font-weight:600;color:var(--text3);cursor:pointer;margin-bottom:18px;transition:color .2s;padding:6px 12px;border-radius:6px;background:var(--surf);border:1px solid var(--border);}
.back-btn:hover{color:var(--blue2);border-color:var(--blue2);background:var(--blue-lt);}

/* ‚îÄ‚îÄ LOG ‚îÄ‚îÄ */
.log-row{padding:10px 0;border-bottom:1px solid var(--border);}
.log-row:last-child{border-bottom:none;}
.log-time{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text4);}
.log-msg{font-size:12px;color:var(--text2);margin-top:3px;line-height:1.5;}

/* ‚îÄ‚îÄ STAGE MANAGER (ADMIN) ‚îÄ‚îÄ */
.stage-list-item{display:flex;align-items:center;gap:8px;padding:10px 14px;background:var(--surf2);border:1px solid var(--border);margin-bottom:6px;border-radius:8px;}
.sli-handle{color:var(--text4);cursor:grab;font-size:16px;}
.sli-name{flex:1;font-size:13px;}
.sli-actions{display:flex;gap:4px;}

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(90px);background:var(--text);color:#fff;border-left:4px solid var(--blue2);padding:12px 20px;font-family:'Inter',sans-serif;font-size:12px;font-weight:500;z-index:9999;transition:transform .3s;max-width:90vw;box-shadow:var(--shadow-lg);border-radius:8px;}
.toast.on{transform:translateX(-50%) translateY(0);}

/* ‚îÄ‚îÄ PROFILE ROWS ‚îÄ‚îÄ */
.profile-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;}

/* ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ */
@media(max-width:720px){
  .ham{display:block;}
  .sidebar{position:fixed;top:56px;left:0;height:calc(100vh - 56px);z-index:300;transform:translateX(-100%);width:250px;box-shadow:var(--shadow-lg);}
  .sidebar.open{transform:translateX(0);}
  .sov.on{display:block;}
  .main{padding:14px;}
  .grid2{grid-template-columns:1fr;}
  .seam-grid{grid-template-columns:repeat(auto-fill,minmax(140px,1fr));}
  .tb-user{display:none;}
  .profile-grid{grid-template-columns:1fr;}
}
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     AUTH SCREEN
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="scr-auth">
  <div class="acard">
    <div class="logo-big">TQIMS</div>
    <div class="logo-sub">Quality Inspection Management System</div>

    <div class="atabs">
      <button class="atab on" id="tab-login" onclick="showTab('login')">LOGIN</button>
      <button class="atab" id="tab-reg" onclick="showTab('reg')">REGISTER</button>
    </div>

    <!-- LOGIN -->
    <div class="aform on" id="form-login">
      <div><label class="lbl">Mobile Number</label><input id="l-mob" type="tel" placeholder="e.g. 9876543210"></div>
      <div><label class="lbl">Password</label><input id="l-pw" type="password" placeholder="Your password"></div>
      <div id="l-err"></div>
      <button class="btn btn-blue btn-w" onclick="doLogin()">LOGIN ‚Üí</button>
      <div class="alink"><a onclick="showTab('reg')">Create new account</a> &nbsp;|&nbsp; <a onclick="showTab('admin-reg')" style="color:var(--text3);font-size:10px;">Admin registration</a></div>
    </div>

    <!-- REGISTER -->
    <div class="aform" id="form-reg">
      <div class="grid2">
        <div><label class="lbl">Full Name</label><input id="r-name" placeholder="Your full name"></div>
        <div><label class="lbl">Mobile</label><input id="r-mob" type="tel" placeholder="10-digit number"></div>
        <div><label class="lbl">Company / Contractor</label><input id="r-co" placeholder="Company name"></div>
        <div><label class="lbl">Designation</label><input id="r-desig" placeholder="e.g. QC Engineer"></div>
        <div class="span2"><label class="lbl">Email (optional)</label><input id="r-email" type="email" placeholder="email@example.com"></div>
        <div class="span2"><label class="lbl">Role</label>
          <div class="rchips">
            <div class="rchip" data-r="production" onclick="pickRole(this)">Production</div>
            <div class="rchip" data-r="quality" onclick="pickRole(this)">Quality Eng.</div>
            <div class="rchip" data-r="manager" onclick="pickRole(this)">Manager</div>
          </div>
        </div>
        <div class="span2"><label class="lbl">Project</label><select id="r-proj"></select></div>
        <div><label class="lbl">Password</label><input id="r-pw" type="password" placeholder="Min 6 characters"></div>
        <div><label class="lbl">Confirm Password</label><input id="r-pw2" type="password" placeholder="Repeat password"></div>
      </div>
      <div id="r-err"></div>
      <button class="btn btn-blue btn-w" onclick="doRegister()">CREATE ACCOUNT ‚Üí</button>
      <div class="alink"><a onclick="showTab('login')">‚Üê Back to login</a></div>
    </div>

    <!-- ADMIN REGISTER -->
    <div class="aform" id="form-admin-reg">
      <div class="msg msg-warn">üîê Admin registration requires a secret authorization key. Only authorized personnel can create admin accounts.</div>
      <div class="grid2">
        <div><label class="lbl">Full Name</label><input id="ar-name" placeholder="Your full name"></div>
        <div><label class="lbl">Mobile</label><input id="ar-mob" type="tel" placeholder="10-digit number"></div>
        <div><label class="lbl">Company</label><input id="ar-co" placeholder="Company name"></div>
        <div><label class="lbl">Designation</label><input id="ar-desig" placeholder="e.g. QA Manager"></div>
        <div class="span2"><label class="lbl">Project</label><select id="ar-proj"></select></div>
        <div><label class="lbl">Password</label><input id="ar-pw" type="password" placeholder="Min 6 characters"></div>
        <div><label class="lbl">Confirm Password</label><input id="ar-pw2" type="password" placeholder="Repeat password"></div>
        <div class="span2">
          <label class="lbl">üîë Admin Secret Key</label>
          <input id="ar-key" type="password" placeholder="Enter admin secret key">
          <div style="font-family:'JetBrains Mono',monospace;font-size:8px;color:var(--text3);margin-top:4px;">Default: TQIMS@Admin2024 (change after first login)</div>
        </div>
      </div>
      <div id="ar-err"></div>
      <button class="btn btn-amber btn-w" onclick="doAdminReg()">CREATE ADMIN ACCOUNT ‚Üí</button>
      <div class="alink"><a onclick="showTab('login')">‚Üê Back to login</a></div>
    </div>

    <div class="credit">¬© TQIMS ¬∑ Designed by Ujval Dharawaparmar</div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     APP SCREEN
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="scr-app">
  <!-- TOPBAR -->
  <div class="topbar">
    <div class="tb-left">
      <button class="ham" onclick="toggleSidebar()">‚ò∞</button>
      <div class="tb-logo">TQIMS <span>Quality Inspection</span></div>
    </div>
    <div class="tb-right">
      <span class="rpill" id="hdr-role"></span>
      <span class="tb-user" id="hdr-name"></span>
      <button class="tb-logout" onclick="doLogout()">LOGOUT</button>
    </div>
  </div>

  <div class="app-body">
    <div class="sov" id="sov" onclick="closeSidebar()"></div>

    <!-- SIDEBAR -->
    <div class="sidebar" id="sidebar">
      <div>
        <div class="sg-lbl">Main</div>
        <div class="nitem on" id="ni-dashboard" onclick="goPage('dashboard')"><span class="ni">üè†</span>Dashboard</div>
        <div class="nitem" id="ni-inspection" onclick="goPage('inspection')"><span class="ni">üî¨</span>Inspection<span class="nbadge" id="nb" style="display:none">0</span></div>
        <div class="nitem" id="ni-log" onclick="goPage('log')"><span class="ni">üìã</span>Activity Log</div>
      </div>
      <div id="admin-nav" style="display:none">
        <div class="sg-lbl">Admin Tools</div>
        <div class="nitem" id="ni-projects" onclick="goPage('projects')"><span class="ni">üìÅ</span>Projects & Seams</div>
        <div class="nitem" id="ni-stages" onclick="goPage('stages')"><span class="ni">‚öôÔ∏è</span>Stage Templates</div>
        <div class="nitem" id="ni-users" onclick="goPage('users')"><span class="ni">üë•</span>Users</div>
        <div class="nitem" id="ni-backup" onclick="goPage('backup')"><span class="ni">üíæ</span>Backup & Restore</div>
      </div>
      <div id="manager-nav" style="display:none">
        <div class="sg-lbl">Manager</div>
        <div class="nitem" id="ni-approvals" onclick="goPage('approvals')"><span class="ni">‚úÖ</span>Approvals<span class="nbadge" id="nb-approvals" style="display:none">0</span></div>
      </div>
      <div>
        <div class="sg-lbl">Reports</div>
        <div class="nitem" id="ni-summary" onclick="goPage('summary')"><span class="ni">üìÑ</span>Print Summary</div>
        <div class="sg-lbl">Account</div>
        <div class="nitem" id="ni-profile" onclick="goPage('profile')"><span class="ni">üë§</span>My Profile</div>
      </div>
      <div class="credit" style="padding:12px 16px;margin-top:8px;">Designed by<br>Ujval Dharawaparmar</div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="main">

      <!-- ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ -->
      <div class="pg on" id="pg-dashboard">
        <div class="pgh"><div class="pgt">Dashboard</div><div class="pgs" id="dash-sub">Project Overview</div></div>

        <!-- DATA INTEGRITY WARNING -->
        <div id="storage-warning" style="margin-bottom:20px;border-radius:10px;overflow:hidden;border:1.5px solid #f87171;box-shadow:0 2px 8px rgba(220,38,38,.1);">
          <!-- Header -->
          <div style="background:#dc2626;padding:11px 18px;display:flex;align-items:center;gap:10px;">
            <span style="font-size:18px;line-height:1;">‚ö†Ô∏è</span>
            <div style="font-family:'Inter',sans-serif;font-size:13px;font-weight:700;color:#fff;letter-spacing:.3px;">IMPORTANT ‚Äî DATA INTEGRITY &amp; USER RESPONSIBILITY NOTICE</div>
          </div>
          <!-- Body -->
          <div style="background:#fff5f5;padding:14px 18px;display:flex;align-items:flex-start;gap:18px;flex-wrap:wrap;">
            <div style="flex:1;min-width:260px;">
              <p style="font-size:13px;color:#1f2937;line-height:1.75;margin-bottom:10px;">
                All data entered in this system is <strong style="color:#1a56db;">shared across all devices and visible to all team members in real time.</strong>
                Any addition, edit, or deletion made by one user will immediately reflect for everyone on the project.
              </p>
              <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:8px;">
                <div style="background:#fee2e2;border:1px solid #fca5a5;border-radius:7px;padding:9px 12px;display:flex;gap:9px;align-items:flex-start;">
                  <span style="font-size:16px;line-height:1.2;">üö´</span>
                  <div>
                    <div style="font-size:11px;font-weight:700;color:#991b1b;text-transform:uppercase;letter-spacing:.3px;margin-bottom:2px;">Strict Data Accuracy Required</div>
                    <div style="font-size:12px;color:#7f1d1d;line-height:1.5;">Entering false, incorrect, or fabricated inspection data is a serious violation of quality standards and project integrity.</div>
                  </div>
                </div>
                <div style="background:#fee2e2;border:1px solid #fca5a5;border-radius:7px;padding:9px 12px;display:flex;gap:9px;align-items:flex-start;">
                  <span style="font-size:16px;line-height:1.2;">üîí</span>
                  <div>
                    <div style="font-size:11px;font-weight:700;color:#991b1b;text-transform:uppercase;letter-spacing:.3px;margin-bottom:2px;">Access Revocation Policy</div>
                    <div style="font-size:12px;color:#7f1d1d;line-height:1.5;">Any user found submitting false data, making unauthorized edits, or attempting to delete records without approval <strong>will have their read and write access permanently revoked</strong> from this system.</div>
                  </div>
                </div>
                <div style="background:#fef3c7;border:1px solid #fcd34d;border-radius:7px;padding:9px 12px;display:flex;gap:9px;align-items:flex-start;">
                  <span style="font-size:16px;line-height:1.2;">üìå</span>
                  <div>
                    <div style="font-size:11px;font-weight:700;color:#92400e;text-transform:uppercase;letter-spacing:.3px;margin-bottom:2px;">All Actions Are Logged</div>
                    <div style="font-size:12px;color:#78350f;line-height:1.5;">Every action ‚Äî offer, inspect, edit, delete ‚Äî is recorded with your name, role, company, and timestamp. There is a complete audit trail.</div>
                  </div>
                </div>
                <div style="background:#dbeafe;border:1px solid #93c5fd;border-radius:7px;padding:9px 12px;display:flex;gap:9px;align-items:flex-start;">
                  <span style="font-size:16px;line-height:1.2;">üíæ</span>
                  <div>
                    <div style="font-size:11px;font-weight:700;color:#1e40af;text-transform:uppercase;letter-spacing:.3px;margin-bottom:2px;">Regular Backup Required</div>
                    <div style="font-size:12px;color:#1e3a8a;line-height:1.5;">Admin must regularly export and share the backup file. Data is stored locally ‚Äî clearing browser cache will erase all records permanently.</div>
                  </div>
                </div>
              </div>
            </div>
            <div id="storage-warn-admin" style="display:none;flex-shrink:0;display:flex;flex-direction:column;gap:8px;align-items:stretch;">
              <button class="btn btn-red" style="width:auto;padding:9px 18px;font-size:12px;" onclick="goPage('backup')">üíæ Export Backup Now</button>
            </div>
          </div>
        </div>

        <div class="projbar" id="projbar"></div>
        <div class="sgrid" id="stat-grid"></div>
        <div id="dash-sections"></div>
      </div>

      <!-- ‚îÄ‚îÄ SEAM DETAIL (from dashboard click) ‚îÄ‚îÄ -->
      <div class="pg" id="pg-seam">
        <div class="back-btn" onclick="goPage('dashboard')">‚Üê Back to Dashboard</div>
        <div class="pgh"><div class="pgt" id="seam-detail-title">Seam Detail</div><div class="pgs" id="seam-detail-sub"></div></div>
        <div id="seam-detail-content"></div>
      </div>

      <!-- ‚îÄ‚îÄ INSPECTION ‚îÄ‚îÄ -->
      <div class="pg" id="pg-inspection">
        <div class="pgh"><div class="pgt">Inspection Stages</div><div class="pgs" id="insp-hint">Select a section, then offer or inspect stages</div></div>

        <!-- FILTER BAR -->
        <div style="display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-bottom:14px;padding:10px 14px;background:var(--surf);border:1px solid var(--border2);border-radius:3px;">
          <span style="font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--text3);letter-spacing:1px;text-transform:uppercase;flex-shrink:0;">Filter:</span>
          <div id="stage-filter-chips" style="display:flex;flex-wrap:wrap;gap:6px;flex:1;">
            <button class="fchip on" data-f="all" onclick="setStageFilter('all',this)">All Stages</button>
            <button class="fchip" data-f="pending" onclick="setStageFilter('pending',this)">‚óã Pending</button>
            <button class="fchip" data-f="offered" onclick="setStageFilter('offered',this)">‚¨Ü Offered / Awaiting QC</button>
            <button class="fchip" data-f="accepted" onclick="setStageFilter('accepted',this)">‚úì Accepted</button>
            <button class="fchip" data-f="rejected" onclick="setStageFilter('rejected',this)">‚úó Rejected / NCR</button>
            <button class="fchip" data-f="returned" onclick="setStageFilter('returned',this)">‚Ü© Returned</button>
          </div>
          <select id="stage-name-filter" onchange="renderInspSeams()" style="padding:5px 9px;font-size:11px;background:var(--surf2);border:1px solid var(--border2);color:var(--text);border-radius:2px;max-width:220px;">
            <option value="">All Stage Types</option>
          </select>
        </div>

        <div class="stabs" id="insp-tabs"></div>
        <div id="insp-seams"></div>
      </div>

      <!-- ‚îÄ‚îÄ ADMIN: PROJECTS & SEAMS ‚îÄ‚îÄ -->
      <div class="pg" id="pg-projects">
        <div class="pgh"><div class="pgt">Projects & Seams</div><div class="pgs">All changes require Manager approval before taking effect</div></div>
        <div style="background:#fef3c7;border:1.5px solid #f59e0b;padding:11px 16px;margin-bottom:16px;font-size:12px;color:#92400e;border-radius:8px;display:flex;align-items:center;gap:8px;">
          <span style="font-size:16px;">‚ö†Ô∏è</span> <strong>Note:</strong> All add, edit, and delete actions are submitted to the Manager for approval. No changes take effect until the Manager approves.
        </div>

        <div class="card">
          <div class="chead">
            <div class="ctitle">Projects</div>
            <button class="abtn ab-blue" onclick="openModal('m-add-proj')">+ ADD PROJECT</button>
          </div>
          <div id="proj-list"></div>
        </div>

        <div class="card">
          <div class="chead"><div class="ctitle">Add Seam / Joint</div></div>
          <div class="grid2">
            <div><label class="lbl">Project</label><select id="ns-proj" onchange="refreshNsSections()"></select></div>
            <div><label class="lbl">Section</label><select id="ns-sec"></select></div>
            <div><label class="lbl">Seam / Joint Number</label><input id="ns-num" placeholder="Circ. Seam No: 101"></div>
            <div><label class="lbl">Description</label><input id="ns-desc" placeholder="Nozzle Neck fit-up with Flange"></div>
            <div><label class="lbl">Joint Type</label>
              <select id="ns-type"><option>Butt Joint</option><option>Fillet Joint</option><option>Nozzle Weld</option><option>Corner Joint</option><option>T-Joint</option><option>Lap Joint</option></select>
            </div>
            <div><label class="lbl">Material</label><input id="ns-mat" placeholder="SA516 Gr.70"></div>
            <div><label class="lbl">Thickness (mm)</label><input id="ns-thk" placeholder="20"></div>
            <div><label class="lbl">WPS No.</label><input id="ns-wps" placeholder="WPS-001"></div>
            <div><label class="lbl">Stage Template</label><select id="ns-tmpl"></select></div>
            <div class="span2" style="display:flex;gap:8px;justify-content:flex-end;margin-top:4px;">
              <button class="abtn ab-blue" style="padding:8px 20px;font-size:11px;" onclick="addSeam()">+ ADD SEAM</button>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="chead">
            <div class="ctitle">All Seams</div>
            <select id="fp" onchange="renderAdminSeams()" style="padding:5px 8px;font-size:11px;background:var(--surf2);border:1px solid var(--border2);color:var(--text);border-radius:2px;"></select>
          </div>
          <div class="tbl-wrap">
            <table><thead><tr><th>Section</th><th>Seam #</th><th>Description</th><th>Type</th><th>Material</th><th>THK</th><th>WPS</th><th>Stages</th><th>Progress</th><th>Actions</th></tr></thead>
            <tbody id="seam-tbody"></tbody></table>
          </div>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ ADMIN: STAGE TEMPLATES ‚îÄ‚îÄ -->
      <div class="pg" id="pg-stages">
        <div class="pgh"><div class="pgt">Stage Templates</div><div class="pgs">Define, edit and manage inspection stage templates for seams</div></div>

        <div class="card">
          <div class="chead">
            <div class="ctitle">Templates</div>
            <button class="abtn ab-blue" onclick="addTemplate()">+ NEW TEMPLATE</button>
          </div>
          <div id="tmpl-list"></div>
        </div>

        <div class="card" id="stage-editor-card" style="display:none;">
          <div class="chead">
            <div class="ctitle" id="stage-editor-title">Edit Stages</div>
            <div style="display:flex;gap:6px;">
              <button class="abtn ab-green" onclick="addStageLine()">+ ADD STAGE</button>
              <button class="abtn ab-ghost" onclick="closeStageEditor()">CLOSE</button>
            </div>
          </div>
          <div id="stage-lines"></div>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ ADMIN: USERS ‚îÄ‚îÄ -->
      <div class="pg" id="pg-users">
        <div class="pgh"><div class="pgt">Users</div><div class="pgs">Manage registered accounts, roles and permissions</div></div>
        <div class="card">
          <div class="chead">
            <div class="ctitle">All Users</div>
            <button class="abtn ab-blue" onclick="openModal('m-add-user')">+ ADD USER</button>
          </div>
          <div class="tbl-wrap">
            <table><thead><tr><th>Name</th><th>Mobile</th><th>Company</th><th>Designation</th><th>Role</th><th>Project</th><th>Status</th><th>Actions</th></tr></thead>
            <tbody id="user-tbody"></tbody></table>
          </div>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ LOG ‚îÄ‚îÄ -->
      <div class="pg" id="pg-log">
        <div class="pgh"><div class="pgt">Activity Log</div><div class="pgs">Full inspection history and complete audit trail</div></div>
        <div style="display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-bottom:14px;padding:10px 14px;background:var(--surf);border:1px solid var(--border2);border-radius:3px;">
          <span style="font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--text3);letter-spacing:1px;text-transform:uppercase;flex-shrink:0;">Filter by:</span>
          <div style="display:flex;flex-wrap:wrap;gap:6px;flex:1;">
            <button class="fchip on" data-lf="all" onclick="setLogFilter('all',this)">All Activity</button>
            <button class="fchip" data-lf="offered" onclick="setLogFilter('offered',this)">‚¨Ü Offers</button>
            <button class="fchip" data-lf="accepted" onclick="setLogFilter('accepted',this)">‚úì Accepted</button>
            <button class="fchip" data-lf="rejected" onclick="setLogFilter('rejected',this)">‚úó Rejected</button>
            <button class="fchip" data-lf="pending" onclick="setLogFilter('pending',this)">üìã Approvals</button>
            <button class="fchip" data-lf="user" onclick="setLogFilter('user',this)">üë§ Users</button>
          </div>
          <select id="log-role-filter" onchange="renderLog()" style="padding:5px 9px;font-size:11px;background:var(--surf2);border:1px solid var(--border2);color:var(--text);border-radius:2px;">
            <option value="">All Roles</option>
            <option value="production">Production</option>
            <option value="quality">Quality</option>
            <option value="manager">Manager</option>
            <option value="admin">Admin</option>
          </select>
        </div>
        <div class="card"><div id="log-body"></div></div>
      </div>

      <!-- ‚îÄ‚îÄ SUMMARY ‚îÄ‚îÄ -->
      <div class="pg" id="pg-summary">
        <div class="pgh"><div class="pgt">Print Summary</div><div class="pgs">Generate printable inspection report with signature blocks</div></div>
        <div class="card">
          <div class="grid2" style="max-width:480px;">
            <div><label class="lbl">Project</label><select id="print-proj" onchange="refreshPrintSecs()"></select></div>
            <div><label class="lbl">Section Filter</label><select id="print-sec"><option value="">All Sections</option></select></div>
            <div class="span2">
              <button class="btn btn-blue" style="width:auto;padding:10px 24px;" onclick="doPrint()">üñ®Ô∏è PRINT / SAVE AS PDF</button>
            </div>
          </div>
        </div>
        <div class="card" id="print-preview"></div>
      </div>

      <!-- ‚îÄ‚îÄ PROFILE ‚îÄ‚îÄ -->
      <div class="pg" id="pg-profile">
        <div class="pgh"><div class="pgt">My Profile</div><div class="pgs">View your account details and change your password</div></div>
        <div style="max-width:520px;">
          <div class="card">
            <div class="chead"><div class="ctitle">Account Details</div></div>
            <div id="profile-rows"></div>
          </div>
          <div class="card">
            <div class="chead"><div class="ctitle">Change Password</div></div>
            <div class="fl" style="max-width:360px;gap:12px;display:flex;flex-direction:column;">
              <div><label class="lbl">Current Password</label><input id="cp-cur" type="password" placeholder="Enter current password"></div>
              <div><label class="lbl">New Password</label><input id="cp-new" type="password" placeholder="Min 6 characters"></div>
              <div><label class="lbl">Confirm New Password</label><input id="cp-cnf" type="password" placeholder="Repeat new password"></div>
              <div id="cp-msg"></div>
              <button class="btn btn-blue" style="width:auto;padding:10px 22px;" onclick="changePassword()">UPDATE PASSWORD ‚Üí</button>
            </div>
          </div>
          <div class="card" id="secret-key-card" style="display:none;">
            <div class="chead"><div class="ctitle">üîë Admin Secret Key</div></div>
            <div style="font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--text3);margin-bottom:12px;">Required for new admin registrations. Keep confidential.</div>
            <div class="fl" style="max-width:360px;gap:12px;display:flex;flex-direction:column;">
              <div><label class="lbl">Current Key</label><input id="sk-cur" type="password" placeholder="Current secret key"></div>
              <div><label class="lbl">New Key (min 8 chars)</label><input id="sk-new" type="password" placeholder="New secret key"></div>
              <div><label class="lbl">Confirm New Key</label><input id="sk-cnf" type="password" placeholder="Repeat new key"></div>
              <div id="sk-msg"></div>
              <button class="btn btn-amber" style="width:auto;padding:10px 22px;" onclick="changeSecretKey()">UPDATE SECRET KEY ‚Üí</button>
            </div>
          </div>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ BACKUP & RESTORE ‚îÄ‚îÄ -->
      <div class="pg" id="pg-backup">
        <div class="pgh"><div class="pgt">Backup & Restore</div><div class="pgs">Export your data regularly ‚Äî required for multi-device sync</div></div>

        <!-- STORAGE EXPLAINER -->
        <div style="background:#fef3c7;border:1.5px solid #f59e0b;padding:16px 18px;margin-bottom:18px;border-radius:10px;">
          <div style="font-family:'Inter',sans-serif;font-size:14px;font-weight:700;color:#92400e;margin-bottom:8px;">‚ö†Ô∏è Important ‚Äî Read Before Proceeding</div>
          <div style="font-size:13px;color:#78350f;line-height:1.8;">
            <strong>Why data must be exported regularly:</strong> This system stores all data in your browser's local storage ‚Äî it only exists on the device and browser you are currently using.<br>
            <strong>Risk:</strong> Clearing browser cache, reinstalling the browser, or switching devices will <strong>permanently erase all data</strong>.<br>
            <strong>Solution:</strong> Export a backup after every significant update and share it with the team via WhatsApp, Email or Google Drive.
          </div>
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
          <!-- EXPORT -->
          <div class="card" style="border-top:4px solid var(--green);">
            <div class="chead"><div class="ctitle" style="color:var(--green);">üì§ Export Backup</div></div>
            <div style="font-size:13px;color:var(--text2);margin-bottom:16px;line-height:1.6;">Download all project data, seams, inspection records, users and logs as a <strong>.json</strong> file. Save it somewhere safe ‚Äî Google Drive, email, or WhatsApp to the team.</div>
            <div id="backup-stats" style="font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text3);margin-bottom:14px;line-height:1.8;"></div>
            <button class="btn btn-green btn-w" onclick="exportBackup()">‚¨á Download Backup File</button>
            <div style="font-size:10px;color:var(--text4);margin-top:8px;text-align:center;" id="last-backup-time"></div>
          </div>

          <!-- IMPORT -->
          <div class="card" style="border-top:4px solid var(--blue2);">
            <div class="chead"><div class="ctitle" style="color:var(--blue2);">üì• Import / Restore</div></div>
            <div style="font-size:13px;color:var(--text2);margin-bottom:16px;line-height:1.6;">Load a previously exported <strong>.json</strong> backup file to restore data on this device. <strong style="color:var(--red);">This will replace all current data on this device.</strong></div>
            <div style="background:var(--red-lt);border:1.5px solid #fca5a5;padding:9px 12px;font-size:12px;color:#991b1b;margin-bottom:14px;border-radius:7px;">
              ‚ö†Ô∏è Current unsaved data will be overwritten. Export first if needed.
            </div>
            <label style="display:block;background:var(--blue2);color:#fff;padding:11px 20px;text-align:center;cursor:pointer;font-family:'Inter',sans-serif;font-size:13px;font-weight:600;border-radius:8px;">
              ‚¨Ü Select Backup File
              <input type="file" id="import-file" accept=".json" onchange="importBackup(this)" style="display:none;">
            </label>
            <div id="import-msg" style="margin-top:10px;"></div>
          </div>
        </div>

        <!-- DEVICE SYNC INSTRUCTIONS -->
        <div class="card" style="margin-top:4px;">
          <div class="chead"><div class="ctitle">üì± How to Sync Across Devices</div></div>
          <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px;">
            ${[
              ['1Ô∏è‚É£','Export Backup','Admin opens TQIMS ‚Üí Backup & Restore ‚Üí Download Backup File'],
              ['2Ô∏è‚É£','Share the File','Send the .json file via WhatsApp, Email, or Google Drive to team members'],
              ['3Ô∏è‚É£','Others Import','Each member opens TQIMS ‚Üí Backup & Restore ‚Üí Select Backup File ‚Üí Import'],
              ['4Ô∏è‚É£','Repeat Regularly','After every update (new seams, inspections), Admin exports and re-shares'],
            ].map(([n,t,d])=>`<div style="padding:12px;background:var(--surf2);border-radius:8px;border:1px solid var(--border);">
              <div style="font-size:22px;margin-bottom:6px;">${n}</div>
              <div style="font-weight:600;font-size:13px;margin-bottom:4px;color:var(--text);">${t}</div>
              <div style="font-size:12px;color:var(--text3);">${d}</div>
            </div>`).join('')}
          </div>
        </div>

        <!-- DANGER ZONE -->
        <div class="card" style="border:1.5px solid #fca5a5;margin-top:4px;">
          <div class="chead"><div class="ctitle" style="color:var(--red);">üóëÔ∏è Danger Zone</div></div>
          <div style="font-size:13px;color:var(--text2);margin-bottom:14px;">Reset all data on this device back to demo defaults. This cannot be undone. Export a backup first.</div>
          <button class="btn btn-red" style="width:auto;padding:9px 22px;" onclick="resetAllData()">Reset to Defaults (Danger)</button>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ APPROVALS (Manager) ‚îÄ‚îÄ -->
      <div class="pg" id="pg-approvals">
        <div class="pgh"><div class="pgt">Pending Approvals</div><div class="pgs">Review and action pending Admin requests</div></div>
        <div class="card" id="approvals-body"></div>
      </div>

    </div><!-- /main -->
  </div><!-- /app-body -->
</div><!-- /scr-app -->

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MODALS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

<!-- Offer Modal -->
<div class="mbg" id="m-offer">
  <div class="modal">
    <div class="mhead"><div class="mtitle">üì§ Offer for Inspection</div><button class="mclose" onclick="closeModal('m-offer')">‚úï</button></div>
    <div class="mbody">
      <div id="offer-info"></div>
      <div class="grid2" style="margin-top:14px;">
        <div><label class="lbl">Location / Position</label><input id="of-loc" placeholder="Bay-3, Grid B-4, Bottom NW"></div>
        <div><label class="lbl">Drawing / Ref. No.</label><input id="of-drw" placeholder="DRG-1242-001"></div>
        <div class="span2"><label class="lbl">Production Remarks</label><textarea id="of-rem" placeholder="e.g. Pre-heat done, joint cleaned..."></textarea></div>
      </div>
    </div>
    <div class="mfoot">
      <button class="btn btn-ghost" style="width:auto;padding:9px 16px;" onclick="closeModal('m-offer')">Cancel</button>
      <button class="btn btn-blue" style="width:auto;padding:9px 16px;" onclick="confirmOffer()">OFFER STAGE ‚Üë</button>
    </div>
  </div>
</div>

<!-- Inspect Modal -->
<div class="mbg" id="m-inspect">
  <div class="modal">
    <div class="mhead"><div class="mtitle">üîç Quality Inspection</div><button class="mclose" onclick="closeModal('m-inspect')">‚úï</button></div>
    <div class="mbody">
      <div id="inspect-info"></div>
      <div style="margin-top:14px;">
        <label class="lbl">Quality Remarks</label>
        <textarea id="ins-rem" placeholder="Enter remarks or HOLD reason..."></textarea>
      </div>
      <div id="ncr-field" style="display:none;margin-top:10px;">
        <label class="lbl" style="color:var(--red);">‚ö† NCR Number <span style="color:var(--red);">*</span> (Required for Rejection)</label>
        <input id="ins-ncr" placeholder="e.g. NCR-2024-001" style="border-color:var(--red);">
        <div style="font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--text3);margin-top:4px;">NCR number is mandatory. Re-offer will require Manager approval.</div>
      </div>
    </div>
    <div class="mfoot">
      <button class="btn btn-ghost" style="width:auto;padding:9px 16px;" onclick="closeModal('m-inspect')">Cancel</button>
      <button class="btn btn-amber" style="width:auto;padding:9px 16px;" onclick="submitInspect('returned')" title="Return without NCR ‚Äî Production can re-offer directly">‚Ü© RETURN</button>
      <button class="btn btn-red" style="width:auto;padding:9px 16px;" onclick="prepareReject()">‚úó REJECT (NCR)</button>
      <button class="btn btn-green" style="width:auto;padding:9px 16px;" onclick="submitInspect('accepted')">‚úì ACCEPT</button>
    </div>
  </div>
</div>

<!-- Add Project Modal -->
<div class="mbg" id="m-add-proj">
  <div class="modal">
    <div class="mhead"><div class="mtitle">+ New Project</div><button class="mclose" onclick="closeModal('m-add-proj')">‚úï</button></div>
    <div class="mbody">
      <div class="grid2">
        <div><label class="lbl">Project Number</label><input id="np-num" placeholder="1242"></div>
        <div><label class="lbl">Equipment Name</label><input id="np-eq" placeholder="Heat Exchanger"></div>
        <div><label class="lbl">Client</label><input id="np-cl" placeholder="IOCL"></div>
        <div><label class="lbl">Process</label><input id="np-pr" placeholder="Fabrication"></div>
        <div class="span2"><label class="lbl">Sections (comma separated)</label><input id="np-secs" placeholder="Pre-Fabrication, Head Assembly, Shell Side, Channel Side, Tube Bundle Assembly"></div>
        <div class="span2"><label class="lbl">Code / Standard</label><input id="np-code" placeholder="ASME Sec VIII Div.1"></div>
      </div>
    </div>
    <div class="mfoot">
      <button class="btn btn-ghost" style="width:auto;padding:9px 16px;" onclick="closeModal('m-add-proj')">Cancel</button>
      <button class="btn btn-blue" style="width:auto;padding:9px 16px;" onclick="confirmAddProj()">CREATE PROJECT</button>
    </div>
  </div>
</div>

<!-- Edit Seam Modal -->
<div class="mbg" id="m-edit-seam">
  <div class="modal">
    <div class="mhead"><div class="mtitle">‚úèÔ∏è Edit Seam</div><button class="mclose" onclick="closeModal('m-edit-seam')">‚úï</button></div>
    <div class="mbody">
      <input type="hidden" id="es-id">
      <div class="grid2">
        <div><label class="lbl">Section</label><select id="es-sec"></select></div>
        <div><label class="lbl">Seam Number</label><input id="es-num"></div>
        <div class="span2"><label class="lbl">Description</label><input id="es-desc"></div>
        <div><label class="lbl">Joint Type</label><select id="es-type"><option>Butt Joint</option><option>Fillet Joint</option><option>Nozzle Weld</option><option>Corner Joint</option><option>T-Joint</option><option>Lap Joint</option></select></div>
        <div><label class="lbl">Material</label><input id="es-mat"></div>
        <div><label class="lbl">Thickness (mm)</label><input id="es-thk"></div>
        <div><label class="lbl">WPS No.</label><input id="es-wps"></div>
      </div>
    </div>
    <div class="mfoot">
      <button class="btn btn-ghost" style="width:auto;padding:9px 16px;" onclick="closeModal('m-edit-seam')">Cancel</button>
      <button class="btn btn-blue" style="width:auto;padding:9px 16px;" onclick="saveSeamEdit()">SAVE CHANGES</button>
    </div>
  </div>
</div>

<!-- NCR Re-Offer Modal (rejected seam ‚Äî needs Manager approval) -->
<div class="mbg" id="m-ncr-offer">
  <div class="modal">
    <div class="mhead"><div class="mtitle" style="color:var(--red);">üî¥ NCR Re-Offer (Manager Approval Required)</div><button class="mclose" onclick="closeModal('m-ncr-offer')">‚úï</button></div>
    <div class="mbody">
      <div style="background:rgba(248,81,73,.07);border:1px solid rgba(248,81,73,.3);padding:10px 14px;border-radius:3px;margin-bottom:14px;">
        <div style="font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--red);letter-spacing:1px;font-weight:700;margin-bottom:4px;">‚ö† REJECTED / NCR STAGE ‚Äî MANAGER APPROVAL REQUIRED</div>
        <div style="font-size:12px;color:var(--text2);">This stage was previously rejected with an NCR. Re-offer will be sent to the Manager for approval before QC inspection can proceed.</div>
      </div>
      <div id="ncr-offer-info"></div>
      <div class="grid2" style="margin-top:14px;">
        <div><label class="lbl">Location / Position</label><input id="ncr-of-loc" placeholder="Bay-3, Grid B-4"></div>
        <div><label class="lbl">Drawing / Ref. No.</label><input id="ncr-of-drw" placeholder="DRG-1242-001"></div>
        <div class="span2">
          <label class="lbl" style="color:var(--purple);">NCR Number <span style="color:var(--red);">*</span></label>
          <input id="ncr-of-ncr" placeholder="e.g. NCR-2024-001 (must match original NCR)" style="border-color:var(--purple);">
        </div>
        <div class="span2"><label class="lbl">Corrective Action Taken / Production Remarks</label><textarea id="ncr-of-rem" placeholder="Describe corrective action taken to address NCR..."></textarea></div>
      </div>
    </div>
    <div class="mfoot">
      <button class="btn btn-ghost" style="width:auto;padding:9px 16px;" onclick="closeModal('m-ncr-offer')">Cancel</button>
      <button class="btn btn-amber" style="width:auto;padding:9px 16px;" onclick="confirmNcrOffer()">üìã SUBMIT FOR MANAGER APPROVAL</button>
    </div>
  </div>
</div>

<!-- Per-Seam Stage Editor Modal (Admin only) -->
<div class="mbg" id="m-seam-stages">
  <div class="modal" style="max-width:600px;">
    <div class="mhead"><div class="mtitle">üîß Edit Stages for Seam</div><button class="mclose" onclick="closeModal('m-seam-stages')">‚úï</button></div>
    <div class="mbody">
      <div style="font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--amber);margin-bottom:12px;">‚ö† Only stages with PENDING status can be added/removed. Accepted/Offered stages are locked.</div>
      <input type="hidden" id="ss-seam-id">
      <div id="seam-stage-lines"></div>
      <div style="margin-top:12px;display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
        <input id="ss-new-stage" placeholder="New stage name..." style="flex:1;min-width:160px;">
        <button class="abtn ab-green" onclick="addSeamStageLine()">+ ADD STAGE</button>
      </div>
    </div>
    <div class="mfoot">
      <button class="btn btn-ghost" style="width:auto;padding:9px 16px;" onclick="closeModal('m-seam-stages')">Close</button>
    </div>
  </div>
</div>

<!-- Add User Modal -->
<div class="mbg" id="m-add-user">
  <div class="modal">
    <div class="mhead"><div class="mtitle">+ Add User</div><button class="mclose" onclick="closeModal('m-add-user')">‚úï</button></div>
    <div class="mbody">
      <div class="grid2">
        <div><label class="lbl">Full Name</label><input id="au-name" placeholder="Full name"></div>
        <div><label class="lbl">Mobile</label><input id="au-mob" type="tel" placeholder="Mobile number"></div>
        <div><label class="lbl">Company</label><input id="au-co" placeholder="Company name"></div>
        <div><label class="lbl">Designation</label><input id="au-desig" placeholder="e.g. QC Engineer"></div>
        <div><label class="lbl">Role</label>
          <select id="au-role"><option value="production">Production</option><option value="quality">Quality Engineer</option><option value="manager">Manager</option><option value="admin">Admin</option></select>
        </div>
        <div><label class="lbl">Project</label><select id="au-proj"></select></div>
        <div class="span2"><label class="lbl">Password</label><input id="au-pw" type="password" placeholder="Set password"></div>
      </div>
    </div>
    <div class="mfoot">
      <button class="btn btn-ghost" style="width:auto;padding:9px 16px;" onclick="closeModal('m-add-user')">Cancel</button>
      <button class="btn btn-blue" style="width:auto;padding:9px 16px;" onclick="adminAddUser()">CREATE USER</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DATABASE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const DEFAULT_STAGES = ['WEP PT/MT','Fit-up Inspection','Root Run / Back Chip PT/MT','Complete Weld Dimension Inspection','Complete Weld PT/MT','Hardness Test','RT (Radiographic Test)','UT (Ultrasonic Test)'];

function mkStages(names) {
  return (names||DEFAULT_STAGES).map(n=>({name:n,status:'pending',offeredBy:'',offeredByMob:'',offeredByCo:'',offeredAt:'',location:'',drawing:'',prodRem:'',inspectedBy:'',inspectedAt:'',qeRem:'',ncrNumber:'',returnRem:''}));
}

function defaultDB() {
  return {
    projects:[{id:'p1',number:'1242',equipment:'Heat Exchanger',client:'IOCL',process:'Fabrication',code:'ASME Sec VIII Div.1',sections:['Pre-Fabrication','Head Assembly','Shell Side','Channel Side','Tube Bundle Assembly']}],
    seams:[
      {id:'s1',pid:'p1',sec:'Pre-Fabrication',num:'Circ. Seam No: 101',desc:'Nozzle Neck fit-up with Flange',type:'Butt Joint',mat:'SA516 Gr.70',thk:'20',wps:'WPS-001',stages:mkStages()},
      {id:'s2',pid:'p1',sec:'Pre-Fabrication',num:'Circ. Seam No: 102',desc:'Shell Plate to End Plate',type:'Butt Joint',mat:'SA516 Gr.70',thk:'25',wps:'WPS-001',stages:mkStages()},
      {id:'s3',pid:'p1',sec:'Head Assembly',num:'Circ. Seam No: 201',desc:'Ellipsoidal Head to Shell',type:'Butt Joint',mat:'SA516 Gr.70',thk:'22',wps:'WPS-002',stages:mkStages()},
      {id:'s4',pid:'p1',sec:'Shell Side',num:'Circ. Seam No: 301',desc:'Shell Longitudinal Seam',type:'Butt Joint',mat:'SA516 Gr.70',thk:'18',wps:'WPS-001',stages:mkStages()},
      {id:'s5',pid:'p1',sec:'Channel Side',num:'Circ. Seam No: 401',desc:'Channel Cover to Flange',type:'Butt Joint',mat:'SA516 Gr.70',thk:'30',wps:'WPS-003',stages:mkStages()},
      {id:'s6',pid:'p1',sec:'Tube Bundle Assembly',num:'Circ. Seam No: 501',desc:'Tube to Tubesheet Welding',type:'Fillet Joint',mat:'SA179',thk:'3',wps:'WPS-004',stages:mkStages()}
    ],
    users:[{id:'u0',name:'Admin User',mob:'0000000000',email:'',co:'TQIMS',desig:'System Admin',role:'admin',pid:'p1',pw:'admin123',approved:true}],
    templates:[{id:'t1',name:'Standard Weld Inspection',stages:DEFAULT_STAGES.slice()}],
    log:[],
    pendingActions:[],
    secretKey:'TQIMS@Admin2024'
  };
}

let DB = (()=>{try{const d=localStorage.getItem('tqims3');if(d){const p=JSON.parse(d);if(!p.templates)p.templates=[{id:'t1',name:'Standard Weld Inspection',stages:DEFAULT_STAGES.slice()}];if(!p.secretKey)p.secretKey='TQIMS@Admin2024';if(!p.pendingActions)p.pendingActions=[];return p;}}catch(e){}return defaultDB();})();
function save(){try{localStorage.setItem('tqims3',JSON.stringify(DB));}catch(e){}}

let CU = null; // current user
let activeSeamId = null; // for seam detail view
let inspTarget = null;
let offerTarget = null;
let editTmplId = null;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const $ = id => document.getElementById(id);
const now = () => new Date().toLocaleString('en-IN',{day:'2-digit',month:'short',year:'2-digit',hour:'2-digit',minute:'2-digit',hour12:false});
function log(msg){DB.log.unshift({t:now(),user:CU?CU.name:'System',role:CU?CU.role:'system',co:CU?CU.co:'',msg});save();}
function getProj(id){return DB.projects.find(p=>p.id===id);}
function getSeam(id){return DB.seams.find(s=>s.id===id);}
function getSections(pid){const p=getProj(pid);return p?p.sections:[];}
function getSeams(pid,sec){return DB.seams.filter(s=>s.pid===pid&&(!sec||s.sec===sec));}
function stageStats(seam){const t=seam.stages.length,a=seam.stages.filter(s=>s.status==='accepted').length,o=seam.stages.filter(s=>s.status==='offered').length,r=seam.stages.filter(s=>s.status==='rejected').length,ret=seam.stages.filter(s=>s.status==='returned').length;return{t,a,o,r,ret,pct:t?Math.round(a/t*100):0};}
function hasNCR(seam){return seam.stages.some(s=>s.ncrNumber||(s.qeRem&&s.qeRem.toLowerCase().includes('ncr')));}
function overallStats(pid){let t=0,a=0,o=0,r=0,ret=0;getSeams(pid).forEach(s=>s.stages.forEach(st=>{t++;if(st.status==='accepted')a++;else if(st.status==='offered')o++;else if(st.status==='rejected')r++;else if(st.status==='returned')ret++;}));return{t,a,o,r,ret,p:t?Math.round(a/t*100):0,seams:getSeams(pid).length};}
function updateBadge(){const seams=getSeams(CU?CU.pid:'');let o=0;seams.forEach(s=>s.stages.forEach(st=>{if(st.status==='offered')o++;}));const nb=$('nb');if(nb){nb.style.display=o>0?'inline':'none';nb.textContent=o;}}
function empty(t){return`<div style="text-align:center;padding:36px;font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text3);">${t}</div>`;}

function toast(msg,type){
  const el=$('toast');
  el.textContent=msg;
  el.style.borderLeftColor=type==='err'?'var(--red)':type==='ok'?'var(--green)':'var(--blue)';
  el.classList.add('on');
  setTimeout(()=>el.classList.remove('on'),3000);
}

function openModal(id){$(id).classList.add('on');}
function closeModal(id){$(id).classList.remove('on');}
document.querySelectorAll('.mbg').forEach(b=>b.addEventListener('click',e=>{if(e.target===b)b.classList.remove('on');}));
document.addEventListener('keydown',e=>{if(e.key==='Escape')document.querySelectorAll('.mbg.on').forEach(m=>m.classList.remove('on'));});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUTH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showTab(t){
  ['login','reg','admin-reg'].forEach(id=>{
    $('tab-'+id)&&$('tab-'+id).classList.toggle('on',id===t);
    $('form-'+id).classList.toggle('on',id===t);
  });
  // populate project dropdowns
  const opts=DB.projects.map(p=>`<option value="${p.id}">Project #${p.number} ‚Äî ${p.equipment}</option>`).join('');
  ['r-proj','ar-proj'].forEach(id=>{const el=$(id);if(el)el.innerHTML=opts;});
}

function pickRole(el){document.querySelectorAll('.rchip').forEach(c=>c.classList.remove('on'));el.classList.add('on');}

function doLogin(){
  const mob=$('l-mob').value.trim();
  const pw=$('l-pw').value;
  const u=DB.users.find(u=>u.mob===mob&&u.pw===pw);
  if(!u){$('l-err').innerHTML='<div class="msg msg-err">Invalid mobile or password.</div>';return;}
  if(!u.approved){$('l-err').innerHTML='<div class="msg msg-err">Account pending admin approval.</div>';return;}
  loginAs(u);
}

function doRegister(){
  const name=$('r-name').value.trim();
  const mob=$('r-mob').value.trim();
  const co=$('r-co').value.trim();
  const desig=$('r-desig').value.trim();
  const email=$('r-email').value.trim();
  const pw=$('r-pw').value;
  const pw2=$('r-pw2').value;
  const pid=$('r-proj').value;
  const roleEl=document.querySelector('.rchip.on');
  const role=roleEl?roleEl.dataset.r:'';
  const err=$('r-err');
  if(!name||!mob||!co||!pw||!pid||!role){err.innerHTML='<div class="msg msg-err">Please fill all required fields and select a role.</div>';return;}
  if(pw!==pw2){err.innerHTML='<div class="msg msg-err">Passwords do not match.</div>';return;}
  if(pw.length<6){err.innerHTML='<div class="msg msg-err">Password must be at least 6 characters.</div>';return;}
  if(DB.users.find(u=>u.mob===mob)){err.innerHTML='<div class="msg msg-err">Mobile number already registered.</div>';return;}
  DB.users.push({id:'u'+Date.now(),name,mob,email,co,desig,role,pid,pw,approved:false});
  save();
  err.innerHTML='<div class="msg msg-ok">‚úì Account created! Awaiting admin approval.</div>';
  toast('Registration submitted');
}

function doAdminReg(){
  const name=$('ar-name').value.trim();
  const mob=$('ar-mob').value.trim();
  const co=$('ar-co').value.trim();
  const desig=$('ar-desig').value.trim();
  const pid=$('ar-proj').value;
  const pw=$('ar-pw').value;
  const pw2=$('ar-pw2').value;
  const key=$('ar-key').value;
  const err=$('ar-err');
  if(!name||!mob||!pw||!pid||!key){err.innerHTML='<div class="msg msg-err">Please fill all required fields.</div>';return;}
  if(key!==DB.secretKey){err.innerHTML='<div class="msg msg-err">‚ùå Invalid admin secret key. Access denied.</div>';$('ar-key').value='';return;}
  if(pw!==pw2){err.innerHTML='<div class="msg msg-err">Passwords do not match.</div>';return;}
  if(pw.length<6){err.innerHTML='<div class="msg msg-err">Password must be at least 6 characters.</div>';return;}
  if(DB.users.find(u=>u.mob===mob)){err.innerHTML='<div class="msg msg-err">Mobile already registered.</div>';return;}
  DB.users.push({id:'u'+Date.now(),name,mob,email:'',co:co||'TQIMS',desig:desig||'Admin',role:'admin',pid,pw,approved:true});
  save();
  err.innerHTML='<div class="msg msg-ok">‚úì Admin account created! You can now login.</div>';
  $('ar-pw').value='';$('ar-pw2').value='';$('ar-key').value='';
  setTimeout(()=>showTab('login'),2000);
}

function loginAs(u){
  CU=u;
  $('scr-auth').classList.remove('on');
  $('scr-app').classList.add('on');
  $('hdr-role').className='rpill rp-'+u.role;
  $('hdr-role').textContent=u.role.toUpperCase();
  $('hdr-name').textContent=u.name;
  $('admin-nav').style.display=u.role==='admin'?'block':'none';
  $('manager-nav').style.display=u.role==='manager'?'block':'none';
  // Show backup button on dashboard warning only for admin
  const warnBtn=$('storage-warn-admin');
  if(warnBtn) warnBtn.style.display=u.role==='admin'?'block':'none';
  populateSelects();
  updateApprovalBadge();
  goPage('dashboard');
}

function doLogout(){
  CU=null;
  $('scr-app').classList.remove('on');
  $('scr-auth').classList.add('on');
  $('l-mob').value='';$('l-pw').value='';$('l-err').innerHTML='';
  $('hdr-role').className='rpill';
  $('admin-nav').style.display='none';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function goPage(pg){
  document.querySelectorAll('.pg').forEach(p=>p.classList.remove('on'));
  document.querySelectorAll('.nitem').forEach(n=>n.classList.remove('on'));
  $('pg-'+pg).classList.add('on');
  const ni=$('ni-'+pg);if(ni)ni.classList.add('on');
  closeSidebar();
  if(pg==='dashboard')renderDashboard();
  else if(pg==='inspection'){renderInspection();updateBadge();}
  else if(pg==='log')renderLog();
  else if(pg==='projects')renderProjectsPage();
  else if(pg==='stages')renderStagesPage();
  else if(pg==='users')renderUsers();
  else if(pg==='summary')renderSummaryPage();
  else if(pg==='profile')renderProfile();
  else if(pg==='approvals')renderApprovals();
  else if(pg==='backup'){renderBackupPage();}
}

function toggleSidebar(){$('sidebar').classList.toggle('open');$('sov').classList.toggle('on');}
function closeSidebar(){$('sidebar').classList.remove('open');$('sov').classList.remove('on');}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// POPULATE SELECTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function populateSelects(){
  const opts=DB.projects.map(p=>`<option value="${p.id}">Project #${p.number} ‚Äî ${p.equipment}</option>`).join('');
  ['fp','print-proj','au-proj'].forEach(id=>{const el=$(id);if(el)el.innerHTML=opts;});
  refreshNsSections();
  refreshPrintSecs();
  refreshTmplSelect();
}

function refreshNsSections(){
  const pid=$('ns-proj')&&$('ns-proj').value;
  const secs=getSections(pid);
  const el=$('ns-sec');if(el)el.innerHTML=secs.map(s=>`<option>${s}</option>`).join('');
}

function refreshPrintSecs(){
  const pid=$('print-proj')&&$('print-proj').value||DB.projects[0]&&DB.projects[0].id;
  const secs=getSections(pid);
  const el=$('print-sec');if(el)el.innerHTML='<option value="">All Sections</option>'+secs.map(s=>`<option>${s}</option>`).join('');
}

function refreshTmplSelect(){
  const el=$('ns-tmpl');if(!el)return;
  el.innerHTML=DB.templates.map(t=>`<option value="${t.id}">${t.name}</option>`).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DASHBOARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderDashboard(){
  if(!CU)return;
  const pid=CU.pid;
  const p=getProj(pid);
  if(!p){$('dash-sections').innerHTML=empty('No project assigned. Contact admin.');return;}

  $('dash-sub').textContent=`Project #${p.number} ‚Äî ${p.equipment}`;
  $('projbar').innerHTML=`
    <div><div class="pf-lbl">Project No.</div><div class="pf-val">${p.number}</div></div>
    <div><div class="pf-lbl">Equipment</div><div class="pf-val">${p.equipment}</div></div>
    <div><div class="pf-lbl">Client</div><div class="pf-val">${p.client||'‚Äî'}</div></div>
    <div><div class="pf-lbl">Process</div><div class="pf-val">${p.process||'‚Äî'}</div></div>
    <div><div class="pf-lbl">Code</div><div class="pf-val">${p.code||'‚Äî'}</div></div>
  `;

  const st=overallStats(pid);
  $('stat-grid').innerHTML=`
    <div class="sbox sb-blue"><div class="snum" style="color:var(--blue2)">${st.seams}</div><div class="slbl">Total Seams</div></div>
    <div class="sbox sb-green"><div class="snum" style="color:var(--green)">${st.a}</div><div class="slbl">Accepted</div></div>
    <div class="sbox sb-amber"><div class="snum" style="color:var(--amber)">${st.o}</div><div class="slbl">Awaiting QC</div></div>
    <div class="sbox sb-red"><div class="snum" style="color:var(--red)">${st.r}</div><div class="slbl">Rejected/NCR</div></div>
    <div class="sbox sb-grey"><div class="snum" style="color:#79c0ff">${st.ret||0}</div><div class="slbl">Returned</div></div>
    <div class="sbox sb-green"><div class="snum" style="color:var(--cyan)">${st.p}%</div><div class="slbl">Completion</div></div>
  `;

  // Seam tiles per section
  const sections=getSections(pid);
  let html='';
  sections.forEach(sec=>{
    const seams=getSeams(pid,sec);
    if(!seams.length)return;
    const secTotal=seams.reduce((a,s)=>a+s.stages.length,0);
    const secDone=seams.reduce((a,s)=>a+s.stages.filter(st=>st.status==='accepted').length,0);
    const secPct=secTotal?Math.round(secDone/secTotal*100):0;
    html+=`<div class="dash-section">
      <div class="dash-sec-title">
        <span>${sec}</span>
        <span style="font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text3);">${secDone}/${secTotal} stages ¬∑ ${secPct}%</span>
      </div>
      <div class="seam-grid">`;
    seams.forEach(seam=>{
      const ss=stageStats(seam);
      const ncr=hasNCR(seam);
      const hasOff=seam.stages.some(s=>s.status==='offered');
      const hasRej=seam.stages.some(s=>s.status==='rejected');
      const hasRet=seam.stages.some(s=>s.status==='returned');
      const tileClass=ss.pct===100?'st-done':hasOff?'st-active':hasRej?'st-rejected':'st-pending';
      html+=`<div class="seam-tile ${tileClass}" onclick="openSeamDetail('${seam.id}')">
        ${ncr?'<div class="ncr-dot" title="NCR Raised"></div>':''}
        <div class="st-seam-num">${seam.num}</div>
        <div class="st-seam-desc" title="${seam.desc}">${seam.desc}</div>
        <div class="st-seam-pct">${ss.pct}%</div>
        <div class="st-seam-meta">${ss.a}/${ss.t} stages</div>
        <div class="pbar" style="margin-top:5px;"><div class="pfill" style="width:${ss.pct}%"></div></div>
        ${hasOff?'<div style="font-family:\'JetBrains Mono\',monospace;font-size:8px;color:var(--amber);margin-top:4px;">‚óè AWAITING QC</div>':''}
        ${!hasOff&&hasRet?'<div style="font-family:\'JetBrains Mono\',monospace;font-size:8px;color:#79c0ff;margin-top:4px;">‚Ü© RETURNED</div>':''}
        ${hasRej?'<div style="font-family:\'JetBrains Mono\',monospace;font-size:8px;color:var(--red);margin-top:4px;">üî¥ NCR</div>':''}
      </div>`;
    });
    html+='</div></div>';
  });
  $('dash-sections').innerHTML=html||empty('No seams added yet. Admin can add from Projects & Seams.');
  updateBadge();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SEAM DETAIL VIEW (click from dashboard)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openSeamDetail(seamId){
  activeSeamId=seamId;
  const seam=getSeam(seamId);
  $('seam-detail-title').textContent=seam.num;
  $('seam-detail-sub').textContent=`${seam.sec} ¬∑ ${seam.desc} ¬∑ ${seam.type} ¬∑ ${seam.mat} ¬∑ ${seam.thk}mm ¬∑ WPS: ${seam.wps||'‚Äî'}`;
  renderSeamDetailContent(seamId);
  goPage('seam');
  $('ni-dashboard').classList.add('on');
}

function renderSeamDetailContent(seamId){
  const seam=getSeam(seamId);
  $('seam-detail-content').innerHTML=renderSeamCard(seam,true);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INSPECTION PAGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let activeSec=null;
function renderInspection(){
  if(!CU)return;
  const pid=CU.pid;
  const secs=getSections(pid);
  if(!activeSec||!secs.includes(activeSec))activeSec=secs[0]||null;
  const hint = CU.role==='production' ? '// You can offer stages for inspection'
    : CU.role==='quality' ? '// You can accept or reject offered stages'
    : 'View only ‚Äî inspection actions are role-restricted';
  const hintEl=$('insp-hint');if(hintEl)hintEl.textContent=hint;
  $('insp-tabs').innerHTML=secs.map(s=>`<div class="stab ${s===activeSec?'on':''}" onclick="switchSec('${s}')">${s}</div>`).join('');
  populateStageNameFilter();
  renderInspSeams();
}
function switchSec(s){activeSec=s;renderInspection();}

function renderInspSeams(){
  const seams=getSeams(CU.pid,activeSec);
  const stageNameF=$('stage-name-filter')?$('stage-name-filter').value:'';

  // For each seam, filter stages by status and name
  let html='';
  seams.forEach(seam=>{
    const filteredStages=seam.stages.map((st,i)=>({...st,_i:i})).filter(st=>{
      const statusMatch = activeStageFilter==='all' || st.status===activeStageFilter;
      const nameMatch = !stageNameF || st.name===stageNameF;
      return statusMatch&&nameMatch;
    });

    // Only show seam if it has matching stages (or show all seams if filter is 'all' and no name filter)
    if(filteredStages.length===0 && (activeStageFilter!=='all' || stageNameF)) return;

    const ss=stageStats(seam);
    const ncr=hasNCR(seam);
    html+=`<div class="seam-detail-card">
      <div class="sdh">
        <div>
          <div class="sd-num">${seam.num}${ncr?' <span class="chip ch-rej" style="font-size:8px;">NCR</span>':''}</div>
          <div class="sd-desc">${seam.desc}</div>
          <div class="sd-meta">${seam.type} ¬∑ ${seam.mat} ¬∑ ${seam.thk}mm ¬∑ WPS: ${seam.wps||'‚Äî'}</div>
        </div>
        <div style="text-align:right;">
          <div style="font-family:'Barlow Condensed',sans-serif;font-size:22px;font-weight:800;color:var(--cyan);">${ss.pct}%</div>
          <div style="font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--text3);">${ss.a}/${ss.t} stages</div>
          <div class="pbar" style="width:100px;margin-top:4px;"><div class="pfill" style="width:${ss.pct}%"></div></div>
        </div>
      </div>`;

    // Render only the matching stages (or all if no filter)
    const stagesToShow = (activeStageFilter==='all' && !stageNameF) ? seam.stages.map((st,i)=>({...st,_i:i})) : filteredStages;
    stagesToShow.forEach(st=>{
      const i=st._i;
      const prev=i===0||seam.stages[i-1].status==='accepted';
      const locked=!prev&&st.status==='pending';
      const canOffer=CU.role==='production';
      const canInspect=CU.role==='quality';
      let chip='',action='';
      if(locked)chip='<span class="chip ch-lock">üîí LOCKED</span>';
      else if(st.status==='pending')chip='<span class="chip ch-pend">‚óã PENDING</span>';
      else if(st.status==='offered')chip='<span class="chip ch-off">‚¨Ü OFFERED</span>';
      else if(st.status==='accepted')chip='<span class="chip ch-acc">‚úì ACCEPTED</span>';
      else if(st.status==='rejected')chip=`<span class="chip ch-rej">‚úó REJECTED${st.ncrNumber?' ¬∑ '+st.ncrNumber:''}</span>`;
      else if(st.status==='returned')chip='<span class="chip ch-ret">‚Ü© RETURNED</span>';
      // Offer button logic
      if(canOffer&&!locked&&st.status==='pending')
        action=`<button class="abtn ab-blue" onclick="openOfferModal('${seam.id}',${i})">OFFER ‚Üë</button>`;
      else if(canOffer&&!locked&&st.status==='returned')
        action=`<button class="abtn ab-blue" onclick="openOfferModal('${seam.id}',${i})">RE-OFFER ‚Üë</button>`;
      else if(canOffer&&!locked&&st.status==='rejected')
        action=`<button class="abtn ab-amber" onclick="openNcrOfferModal('${seam.id}',${i})">üî¥ NCR RE-OFFER ‚Üë</button>`;
      if(canInspect&&st.status==='offered')
        action=`<button class="abtn ab-green" onclick="openInspectModal('${seam.id}',${i})">INSPECT ‚ñ∏</button>`;
      let detail='';
      if(st.offeredAt)detail+=`Offered: ${st.offeredBy} (${st.offeredByCo}) @ ${st.offeredAt}`;
      if(st.location)detail+=` | üìç ${st.location}`;
      if(st.drawing)detail+=` | DRG: ${st.drawing}`;
      if(st.inspectedAt)detail+=`\nInspected: ${st.inspectedBy} @ ${st.inspectedAt}`;
      if(st.ncrNumber)detail+=`\nüî¥ NCR: ${st.ncrNumber}`;
      html+=`<div class="stage-row">
        <div class="sr-num">${String(i+1).padStart(2,'0')}</div>
        <div class="sr-info">
          <div class="sr-name">${st.name}</div>
          ${detail?`<div class="sr-detail">${detail.replace(/\n/g,'<br>')}</div>`:''}
          ${st.prodRem?`<div class="sr-remark" style="color:var(--blue2)">üîµ Prod: ${st.prodRem}</div>`:''}
          ${st.qeRem?`<div class="sr-remark" style="color:${st.status==='rejected'?'var(--red)':st.status==='returned'?'#79c0ff':'var(--amber)'}">üîç QE: ${st.qeRem}</div>`:''}
        </div>
        <div class="sr-actions">${chip}${action}</div>
      </div>`;
    });
    html+='</div>';
  });

  $('insp-seams').innerHTML=html||empty(activeStageFilter==='all'&&!stageNameF?'No seams in this section.':'No stages match this filter.');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SEAM CARD RENDERER (shared by inspection page and seam detail)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderSeamCard(seam,standalone){
  const ss=stageStats(seam);
  const ncr=hasNCR(seam);
  let html=`<div class="seam-detail-card">
    <div class="sdh">
      <div>
        <div class="sd-num">${seam.num}${ncr?' <span class="chip ch-rej" style="font-size:8px;">NCR</span>':''}</div>
        <div class="sd-desc">${seam.desc}</div>
        <div class="sd-meta">${seam.type} ¬∑ ${seam.mat} ¬∑ ${seam.thk}mm ¬∑ WPS: ${seam.wps||'‚Äî'}</div>
      </div>
      <div style="text-align:right;">
        <div style="font-family:'Barlow Condensed',sans-serif;font-size:22px;font-weight:800;color:var(--cyan);">${ss.pct}%</div>
        <div style="font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--text3);">${ss.a}/${ss.t} stages</div>
        <div class="pbar" style="width:100px;margin-top:4px;"><div class="pfill" style="width:${ss.pct}%"></div></div>
      </div>
    </div>`;

  seam.stages.forEach((st,i)=>{
    const prev=i===0||seam.stages[i-1].status==='accepted';
    const locked=!prev&&st.status==='pending';
    // STRICT ROLE PERMISSIONS
    const canOffer = CU.role==='production';           // ONLY production can offer
    const canInspect = CU.role==='quality';            // ONLY quality can inspect/accept/reject

    let chip='',action='';
    if(locked)chip='<span class="chip ch-lock">üîí LOCKED</span>';
    else if(st.status==='pending')chip='<span class="chip ch-pend">‚óã PENDING</span>';
    else if(st.status==='offered')chip='<span class="chip ch-off">‚¨Ü OFFERED</span>';
    else if(st.status==='accepted')chip='<span class="chip ch-acc">‚úì ACCEPTED</span>';
    else if(st.status==='rejected')chip=`<span class="chip ch-rej">‚úó REJECTED${st.ncrNumber?' ¬∑ '+st.ncrNumber:''}</span>`;
    else if(st.status==='returned')chip='<span class="chip ch-ret">‚Ü© RETURNED</span>';

    if(canOffer&&!locked&&st.status==='pending')
      action=`<button class="abtn ab-blue" onclick="openOfferModal('${seam.id}',${i})">OFFER ‚Üë</button>`;
    else if(canOffer&&!locked&&st.status==='returned')
      action=`<button class="abtn ab-blue" onclick="openOfferModal('${seam.id}',${i})">RE-OFFER ‚Üë</button>`;
    else if(canOffer&&!locked&&st.status==='rejected')
      action=`<button class="abtn ab-amber" onclick="openNcrOfferModal('${seam.id}',${i})">üî¥ NCR RE-OFFER ‚Üë</button>`;
    if(canInspect&&st.status==='offered')
      action=`<button class="abtn ab-green" onclick="openInspectModal('${seam.id}',${i})">INSPECT ‚ñ∏</button>`;

    let detail='';
    if(st.offeredAt)detail+=`Offered: ${st.offeredBy} (${st.offeredByCo}) @ ${st.offeredAt}`;
    if(st.location)detail+=` | üìç ${st.location}`;
    if(st.drawing)detail+=` | DRG: ${st.drawing}`;
    if(st.inspectedAt)detail+=`\nInspected: ${st.inspectedBy} @ ${st.inspectedAt}`;
    if(st.ncrNumber)detail+=`\nüî¥ NCR: ${st.ncrNumber}`;

    html+=`<div class="stage-row">
      <div class="sr-num">${String(i+1).padStart(2,'0')}</div>
      <div class="sr-info">
        <div class="sr-name">${st.name}</div>
        ${detail?`<div class="sr-detail">${detail.replace(/\n/g,'<br>')}</div>`:''}
        ${st.prodRem?`<div class="sr-remark" style="color:var(--blue2)">üîµ Prod: ${st.prodRem}</div>`:''}
        ${st.qeRem?`<div class="sr-remark" style="color:${st.status==='rejected'?'var(--red)':st.status==='returned'?'#79c0ff':'var(--amber)'}">üîç QE: ${st.qeRem}</div>`:''}
      </div>
      <div class="sr-actions">${chip}${action}</div>
    </div>`;
  });

  html+='</div>';
  return html;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// OFFER FLOW
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openOfferModal(seamId,idx){
  const seam=getSeam(seamId);const st=seam.stages[idx];
  offerTarget={seamId,idx};
  $('of-loc').value='';$('of-drw').value='';$('of-rem').value='';
  $('offer-info').innerHTML=`
    <div class="ir"><span class="ir-k">Seam / Joint</span><span class="ir-v">${seam.num}</span></div>
    <div class="ir"><span class="ir-k">Description</span><span class="ir-v">${seam.desc}</span></div>
    <div class="ir"><span class="ir-k">Stage</span><span class="ir-v" style="color:var(--amber)">${st.name}</span></div>
    <div class="ir"><span class="ir-k">Section</span><span class="ir-v">${seam.sec}</span></div>
    <div class="ir"><span class="ir-k">Offered By</span><span class="ir-v">${CU.name} ¬∑ ${CU.co}</span></div>
  `;
  openModal('m-offer');
}

function confirmOffer(){
  if(!offerTarget)return;
  const{seamId,idx}=offerTarget;
  const seam=getSeam(seamId);const st=seam.stages[idx];
  st.status='offered';st.offeredBy=CU.name;st.offeredByMob=CU.mob;st.offeredByCo=CU.co;
  st.offeredAt=now();st.location=$('of-loc').value.trim();st.drawing=$('of-drw').value.trim();
  st.prodRem=$('of-rem').value.trim();st.inspectedBy='';st.inspectedAt='';st.qeRem='';
  log(`üîµ OFFERED ‚Äî ${seam.num} ¬∑ ${st.name}${st.location?' üìç'+st.location:''} by ${CU.name} (${CU.co})`);
  save();closeModal('m-offer');
  refreshCurrentView();
  toast('Stage offered for inspection','ok');
  sendWA(seamId,idx);
}

// ‚îÄ‚îÄ NCR RE-OFFER (rejected ‚Üí re-offer with Manager approval) ‚îÄ‚îÄ
function openNcrOfferModal(seamId,idx){
  const seam=getSeam(seamId);const st=seam.stages[idx];
  offerTarget={seamId,idx};
  $('ncr-of-loc').value='';$('ncr-of-drw').value='';$('ncr-of-rem').value='';
  $('ncr-of-ncr').value=st.ncrNumber||'';
  $('ncr-offer-info').innerHTML=`
    <div class="ir"><span class="ir-k">Seam / Joint</span><span class="ir-v">${seam.num}</span></div>
    <div class="ir"><span class="ir-k">Description</span><span class="ir-v">${seam.desc}</span></div>
    <div class="ir"><span class="ir-k">Stage</span><span class="ir-v" style="color:var(--amber)">${st.name}</span></div>
    <div class="ir"><span class="ir-k">Previous NCR</span><span class="ir-v" style="color:var(--red)">${st.ncrNumber||'‚Äî'}</span></div>
    <div class="ir"><span class="ir-k">Rejection Remarks</span><span class="ir-v">${st.qeRem||'‚Äî'}</span></div>
    <div class="ir"><span class="ir-k">Re-Offered By</span><span class="ir-v">${CU.name} ¬∑ ${CU.co}</span></div>
  `;
  openModal('m-ncr-offer');
}

function confirmNcrOffer(){
  if(!offerTarget)return;
  const ncrNum=$('ncr-of-ncr').value.trim();
  if(!ncrNum){$('ncr-of-ncr').style.borderColor='var(--red)';toast('NCR Number is required','err');return;}
  const{seamId,idx}=offerTarget;
  const seam=getSeam(seamId);const st=seam.stages[idx];
  // Build pending action for Manager approval
  const actionData={
    seamId,idx,
    loc:$('ncr-of-loc').value.trim(),
    drw:$('ncr-of-drw').value.trim(),
    rem:$('ncr-of-rem').value.trim(),
    ncrNumber:ncrNum,
    offeredBy:CU.name,offeredByMob:CU.mob,offeredByCo:CU.co,offeredAt:now()
  };
  DB.pendingActions.push({
    id:'pa'+Date.now(),
    type:'ncr_reoffer',
    data:actionData,
    requestedBy:CU.name,
    requestedAt:now(),
    desc:`NCR Re-Offer: ${seam.num} ¬∑ ${st.name} ¬∑ NCR: ${ncrNum} (${CU.co})`
  });
  log(`üî¥ NCR RE-OFFER PENDING ‚Äî ${seam.num} ¬∑ ${st.name} ¬∑ NCR: ${ncrNum} by ${CU.name} (${CU.co}) ‚Äî Awaiting Manager Approval`);
  save();closeModal('m-ncr-offer');
  updateApprovalBadge();
  refreshCurrentView();
  toast('NCR Re-offer submitted ‚Äî awaiting Manager approval','ok');
}

function sendWA(seamId,idx){
  const seam=getSeam(seamId);const st=seam.stages[idx];
  const qcList=DB.users.filter(u=>u.role==='quality'&&u.pid===CU.pid&&u.approved);
  if(!qcList.length)return;
  const p=getProj(CU.pid);
  const msg=encodeURIComponent(`üîî *TQIMS Inspection Offer*\nProject: #${p.number} ‚Äî ${p.equipment}\nSection: ${seam.sec}\nSeam: ${seam.num}\nStage: ${st.name}\nLocation: ${st.location||'‚Äî'}\nOffered By: ${CU.name} (${CU.co})\nTime: ${st.offeredAt}\n\nPlease inspect and update TQIMS.`);
  const mob=qcList[0].mob.replace(/\D/g,'');
  if(confirm(`Send WhatsApp notification to QC: ${qcList[0].name} (${qcList[0].mob})?`))
    window.open(`https://wa.me/${mob}?text=${msg}`,'_blank');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INSPECT FLOW
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openInspectModal(seamId,idx){
  const seam=getSeam(seamId);const st=seam.stages[idx];
  inspTarget={seamId,idx};$('ins-rem').value='';$('ins-ncr').value='';
  $('ncr-field').style.display='none';
  $('inspect-info').innerHTML=`
    <div class="ir"><span class="ir-k">Seam / Joint</span><span class="ir-v">${seam.num}</span></div>
    <div class="ir"><span class="ir-k">Description</span><span class="ir-v">${seam.desc}</span></div>
    <div class="ir"><span class="ir-k">Stage</span><span class="ir-v" style="color:var(--amber)">${st.name}</span></div>
    <div class="ir"><span class="ir-k">Section</span><span class="ir-v">${seam.sec}</span></div>
    <div class="ir"><span class="ir-k">Offered By</span><span class="ir-v">${st.offeredBy} (${st.offeredByCo})</span></div>
    <div class="ir"><span class="ir-k">Offered At</span><span class="ir-v">${st.offeredAt}</span></div>
    ${st.location?`<div class="ir"><span class="ir-k">Location</span><span class="ir-v">üìç ${st.location}</span></div>`:''}
    ${st.drawing?`<div class="ir"><span class="ir-k">Drawing Ref.</span><span class="ir-v">${st.drawing}</span></div>`:''}
    ${st.prodRem?`<div class="ir"><span class="ir-k">Prod. Remarks</span><span class="ir-v">${st.prodRem}</span></div>`:''}
    <div class="ir"><span class="ir-k">Material</span><span class="ir-v">${seam.mat} ¬∑ ${seam.thk}mm ¬∑ ${seam.type}</span></div>
  `;
  openModal('m-inspect');
}

function prepareReject(){
  // Show NCR field, user must fill NCR number before confirming reject
  $('ncr-field').style.display='block';
  $('ins-ncr').focus();
  // Replace reject button with confirm step
  const ncrVal=$('ins-ncr').value.trim();
  submitReject();
}

function submitReject(){
  const ncrVal=$('ins-ncr').value.trim();
  if(!ncrVal){
    $('ncr-field').style.display='block';
    $('ins-ncr').style.borderColor='var(--red)';
    $('ins-ncr').focus();
    toast('NCR Number is required to reject a stage','err');
    return;
  }
  submitInspect('rejected',ncrVal);
}

function submitInspect(result,ncrNumber){
  if(!inspTarget)return;
  // If reject clicked directly (not via submitReject), show NCR field first
  if(result==='rejected'&&!ncrNumber){
    $('ncr-field').style.display='block';
    $('ins-ncr').focus();
    toast('Please enter NCR number then click REJECT again','err');
    return;
  }
  const{seamId,idx}=inspTarget;
  const seam=getSeam(seamId);const st=seam.stages[idx];
  st.status=result;
  st.inspectedBy=CU.name;st.inspectedAt=now();
  st.qeRem=$('ins-rem').value.trim();
  if(result==='rejected'){
    st.ncrNumber=ncrNumber||$('ins-ncr').value.trim();
    log(`‚ùå REJECTED (NCR: ${st.ncrNumber}) ‚Äî ${seam.num} ¬∑ ${st.name} by ${CU.name}${st.qeRem?' ‚Äî '+st.qeRem:''}`);
  } else if(result==='returned'){
    st.ncrNumber='';
    log(`‚Ü© RETURNED ‚Äî ${seam.num} ¬∑ ${st.name} by ${CU.name}${st.qeRem?' ‚Äî '+st.qeRem:''}`);
  } else {
    log(`‚úÖ ACCEPTED ‚Äî ${seam.num} ¬∑ ${st.name} by ${CU.name}${st.qeRem?' ‚Äî '+st.qeRem:''}`);
  }
  save();closeModal('m-inspect');
  refreshCurrentView();
  const resultLabel=result==='returned'?'Stage returned to production':result==='rejected'?'Stage rejected with NCR':'Stage accepted';
  toast(resultLabel,'ok');
}

function refreshCurrentView(){
  const activePg=document.querySelector('.pg.on');
  if(!activePg)return;
  const id=activePg.id;
  if(id==='pg-dashboard')renderDashboard();
  else if(id==='pg-inspection')renderInspection();
  else if(id==='pg-seam')renderSeamDetailContent(activeSeamId);
  updateBadge();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ADMIN ‚Äî PROJECTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderProjectsPage(){
  $('proj-list').innerHTML=DB.projects.map(p=>`
    <div style="display:flex;align-items:flex-start;justify-content:space-between;padding:10px 0;border-bottom:1px solid rgba(33,38,45,.7);flex-wrap:wrap;gap:8px;">
      <div>
        <div style="font-family:'Barlow Condensed',sans-serif;font-size:15px;font-weight:700;color:var(--blue2);">Project #${p.number} ‚Äî ${p.equipment}</div>
        <div style="font-size:12px;color:var(--text2);margin-top:2px;">${p.client||'‚Äî'} ¬∑ ${p.process||'‚Äî'} ¬∑ ${p.code||'‚Äî'}</div>
        <div style="font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--text3);margin-top:3px;">${p.sections.join(' | ')}</div>
      </div>
      <div style="display:flex;gap:6px;">
        <button class="abtn ab-amber" onclick="editProj('${p.id}')">EDIT</button>
        <button class="abtn ab-red" onclick="delProj('${p.id}')">DEL</button>
      </div>
    </div>`).join('')||empty('No projects yet.');
  populateSelects();
  renderAdminSeams();
}

function confirmAddProj(){
  const num=$('np-num').value.trim(),eq=$('np-eq').value.trim();
  if(!num||!eq){toast('Project number and equipment required','err');return;}
  const secs=$('np-secs').value.split(',').map(s=>s.trim()).filter(Boolean);
  const newProj={id:'p'+Date.now(),number:num,equipment:eq,client:$('np-cl').value.trim(),process:$('np-pr').value.trim(),sections:secs.length?secs:['General'],code:$('np-code').value.trim()};
  DB.pendingActions.push({id:'pa'+Date.now(),type:'add_proj',data:newProj,requestedBy:CU.name,requestedAt:now(),desc:`Add Project: #${num} ‚Äî ${eq}`});
  log(`üìã PENDING APPROVAL ‚Äî Add Project #${num} requested by ${CU.name}`);save();
  closeModal('m-add-proj');renderProjectsPage();
  toast('‚úì Project add request sent to Manager for approval','ok');
}

function editProj(id){
  const p=getProj(id);
  const num=prompt('Project Number:',p.number);if(!num)return;
  const eq=prompt('Equipment Name:',p.equipment)||p.equipment;
  const cl=prompt('Client:',p.client)||p.client;
  const secs=prompt('Sections (comma separated):',p.sections.join(', '));
  const updated={id,number:num,equipment:eq,client:cl,sections:secs?secs.split(',').map(s=>s.trim()).filter(Boolean):p.sections,code:p.code,process:p.process};
  DB.pendingActions.push({id:'pa'+Date.now(),type:'edit_proj',data:updated,requestedBy:CU.name,requestedAt:now(),desc:`Edit Project: #${p.number} ‚Üí #${num} ${eq}`});
  log(`üìã PENDING APPROVAL ‚Äî Edit Project #${p.number} requested by ${CU.name}`);save();
  renderProjectsPage();toast('‚úì Project edit request sent to Manager for approval','ok');
}

function delProj(id){
  if(!confirm('Request deletion of this project? Manager must approve.'))return;
  const p=getProj(id);
  DB.pendingActions.push({id:'pa'+Date.now(),type:'del_proj',data:{id},requestedBy:CU.name,requestedAt:now(),desc:`Delete Project: #${p.number} ‚Äî ${p.equipment}`});
  log(`üìã PENDING APPROVAL ‚Äî Delete Project #${p.number} requested by ${CU.name}`);save();
  renderProjectsPage();toast('‚úì Deletion request sent to Manager for approval','ok');
}

function renderAdminSeams(){
  const pid=$('fp')&&$('fp').value||DB.projects[0]&&DB.projects[0].id;
  const seams=DB.seams.filter(s=>s.pid===pid);
  $('seam-tbody').innerHTML=seams.map(s=>{
    const ss=stageStats(s);
    return`<tr>
      <td>${s.sec}</td>
      <td style="font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--blue2);">${s.num}</td>
      <td>${s.desc}</td>
      <td style="font-size:11px;">${s.type}</td>
      <td style="font-size:11px;">${s.mat}</td>
      <td style="font-family:'JetBrains Mono',monospace;font-size:11px;">${s.thk}</td>
      <td style="font-family:'JetBrains Mono',monospace;font-size:11px;">${s.wps||'‚Äî'}</td>
      <td style="font-family:'JetBrains Mono',monospace;font-size:10px;">${s.stages.length} stages</td>
      <td style="min-width:80px;">
        <div style="font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--cyan);">${ss.a}/${ss.t}</div>
        <div class="pbar"><div class="pfill" style="width:${ss.pct}%"></div></div>
      </td>
      <td>
        <div style="display:flex;gap:4px;flex-wrap:wrap;">
          <button class="abtn ab-amber" onclick="openEditSeam('${s.id}')">EDIT</button>
          <button class="abtn ab-blue" onclick="dupeSeam('${s.id}')" title="Duplicate seam">DUPE</button>
          <button class="abtn ab-ghost" onclick="openSeamStageEditor('${s.id}')" title="Customize stages for this seam">STAGES</button>
          <button class="abtn ab-red" onclick="delSeam('${s.id}')">DEL</button>
        </div>
      </td>
    </tr>`;
  }).join('')||`<tr><td colspan="10" style="text-align:center;padding:20px;color:var(--text3);">No seams</td></tr>`;
}

function addSeam(){
  const pid=$('ns-proj').value,sec=$('ns-sec').value,num=$('ns-num').value.trim(),desc=$('ns-desc').value.trim();
  if(!num||!desc){toast('Seam number and description required','err');return;}
  const tmplId=$('ns-tmpl').value;
  const tmpl=DB.templates.find(t=>t.id===tmplId);
  const stages=mkStages(tmpl?tmpl.stages.slice():DEFAULT_STAGES.slice());
  const newSeam={id:'s'+Date.now(),pid,sec,num,desc,type:$('ns-type').value,mat:$('ns-mat').value.trim()||'N/A',thk:$('ns-thk').value.trim()||'N/A',wps:$('ns-wps').value.trim()||'‚Äî',stages};
  // Submit for Manager approval
  DB.pendingActions.push({id:'pa'+Date.now(),type:'add_seam',data:newSeam,requestedBy:CU.name,requestedAt:now(),desc:`Add Seam: ${num} ‚Äî ${desc} in ${sec}`});
  log(`üìã PENDING APPROVAL ‚Äî Add Seam: ${num} requested by ${CU.name}`);save();
  ['ns-num','ns-desc','ns-mat','ns-thk','ns-wps'].forEach(id=>$(id).value='');
  renderAdminSeams();
  toast('‚úì Seam add request sent to Manager for approval','ok');
}

function openEditSeam(id){
  const s=getSeam(id);
  $('es-id').value=id;$('es-num').value=s.num;$('es-desc').value=s.desc;
  $('es-mat').value=s.mat;$('es-thk').value=s.thk;$('es-wps').value=s.wps||'';
  const pid=s.pid;const secs=getSections(pid);
  $('es-sec').innerHTML=secs.map(sec=>`<option ${sec===s.sec?'selected':''}>${sec}</option>`).join('');
  $('es-type').value=s.type;
  openModal('m-edit-seam');
}

function saveSeamEdit(){
  const id=$('es-id').value;const s=getSeam(id);
  const updatedData={id,sec:$('es-sec').value,num:$('es-num').value.trim(),desc:$('es-desc').value.trim(),type:$('es-type').value,mat:$('es-mat').value.trim(),thk:$('es-thk').value.trim(),wps:$('es-wps').value.trim()};
  DB.pendingActions.push({id:'pa'+Date.now(),type:'edit_seam',data:updatedData,requestedBy:CU.name,requestedAt:now(),desc:`Edit Seam: ${s.num} ‚Üí ${updatedData.num}`});
  log(`üìã PENDING APPROVAL ‚Äî Edit Seam: ${s.num} requested by ${CU.name}`);save();
  closeModal('m-edit-seam');renderAdminSeams();
  toast('‚úì Seam edit request sent to Manager for approval','ok');
}

function dupeSeam(id){
  const s=getSeam(id);
  const newNum=prompt('New Seam Number for duplicate:',s.num+' (Copy)');
  if(!newNum)return;
  const newSeam={id:'s'+Date.now(),pid:s.pid,sec:s.sec,num:newNum,desc:s.desc,type:s.type,mat:s.mat,thk:s.thk,wps:s.wps,stages:mkStages(s.stages.map(st=>st.name))};
  DB.pendingActions.push({id:'pa'+Date.now(),type:'add_seam',data:newSeam,requestedBy:CU.name,requestedAt:now(),desc:`Duplicate Seam: ${s.num} ‚Üí ${newNum}`});
  log(`üìã PENDING APPROVAL ‚Äî Duplicate Seam: ${newNum} from ${s.num} requested by ${CU.name}`);save();
  renderAdminSeams();toast('‚úì Duplication request sent to Manager for approval','ok');
}

function delSeam(id){
  if(!confirm('Request deletion of this seam? Manager must approve.'))return;
  const s=getSeam(id);
  DB.pendingActions.push({id:'pa'+Date.now(),type:'del_seam',data:{id},requestedBy:CU.name,requestedAt:now(),desc:`Delete Seam: ${s.num} ‚Äî ${s.desc}`});
  log(`üìã PENDING APPROVAL ‚Äî Delete Seam: ${s.num} requested by ${CU.name}`);save();
  renderAdminSeams();toast('‚úì Deletion request sent to Manager for approval','ok');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PER-SEAM STAGE EDITOR (Admin only)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openSeamStageEditor(seamId){
  $('ss-seam-id').value=seamId;
  renderSeamStageLines(seamId);
  openModal('m-seam-stages');
}

function renderSeamStageLines(seamId){
  const seam=getSeam(seamId);
  if(!seam){return;}
  $('seam-stage-lines').innerHTML=seam.stages.map((st,i)=>{
    const canEdit=st.status==='pending'; // only pending stages can be renamed/removed
    return`<div class="stage-list-item" style="${!canEdit?'opacity:.6':''}">
      <span class="sli-handle" style="${!canEdit?'cursor:default':''}">‚†ø</span>
      <input style="flex:1;background:transparent;border:none;border-bottom:1px solid var(--border2);color:var(--text);padding:4px 6px;font-family:'Barlow',sans-serif;font-size:13px;" 
        value="${st.name}" 
        ${!canEdit?'disabled title="Cannot rename ‚Äî stage already in progress"':''}
        onchange="updateSeamStageName('${seamId}',${i},this.value)">
      <span class="chip ${st.status==='accepted'?'ch-acc':st.status==='offered'?'ch-off':st.status==='rejected'?'ch-rej':st.status==='returned'?'ch-ret':'ch-pend'}" style="font-size:8px;margin:0 4px;">${st.status.toUpperCase()}</span>
      <div class="sli-actions">
        ${canEdit&&i>0?`<button class="abtn ab-ghost" style="padding:2px 6px;" onclick="moveSeamStage('${seamId}',${i},-1)">‚Üë</button>`:'<span style="width:28px;"></span>'}
        ${canEdit&&i<seam.stages.length-1?`<button class="abtn ab-ghost" style="padding:2px 6px;" onclick="moveSeamStage('${seamId}',${i},1)">‚Üì</button>`:'<span style="width:28px;"></span>'}
        ${canEdit?`<button class="abtn ab-red" style="padding:2px 8px;" onclick="removeSeamStage('${seamId}',${i})">‚úï</button>`:'<span style="width:36px;"></span>'}
      </div>
    </div>`;
  }).join('');
}

function updateSeamStageName(seamId,i,val){
  const seam=getSeam(seamId);if(!seam||seam.stages[i].status!=='pending')return;
  seam.stages[i].name=val;save();
}

function moveSeamStage(seamId,i,dir){
  const seam=getSeam(seamId);if(!seam)return;
  const j=i+dir;if(j<0||j>=seam.stages.length)return;
  if(seam.stages[i].status!=='pending'||seam.stages[j].status!=='pending'){toast('Can only reorder pending stages','err');return;}
  [seam.stages[i],seam.stages[j]]=[seam.stages[j],seam.stages[i]];
  save();renderSeamStageLines(seamId);
}

function removeSeamStage(seamId,i){
  const seam=getSeam(seamId);if(!seam)return;
  if(seam.stages[i].status!=='pending'){toast('Cannot remove a stage already in progress','err');return;}
  if(!confirm(`Remove stage "${seam.stages[i].name}" from seam ${seam.num}?`))return;
  seam.stages.splice(i,1);save();renderSeamStageLines(seamId);
  log(`üîß STAGE REMOVED ‚Äî ${seam.num} ¬∑ stage ${i+1} removed by ${CU.name}`);
  toast('Stage removed','ok');
}

function addSeamStageLine(){
  const seamId=$('ss-seam-id').value;
  const seam=getSeam(seamId);if(!seam)return;
  const name=$('ss-new-stage').value.trim();
  if(!name){toast('Enter a stage name','err');return;}
  seam.stages.push({name,status:'pending',offeredBy:'',offeredByMob:'',offeredByCo:'',offeredAt:'',location:'',drawing:'',prodRem:'',inspectedBy:'',inspectedAt:'',qeRem:'',ncrNumber:'',returnRem:''});
  $('ss-new-stage').value='';save();renderSeamStageLines(seamId);
  log(`üîß STAGE ADDED ‚Äî ${seam.num} ¬∑ "${name}" added by ${CU.name}`);
  toast('Stage added','ok');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ADMIN ‚Äî STAGE TEMPLATES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderStagesPage(){
  $('stage-editor-card').style.display='none';
  $('tmpl-list').innerHTML=DB.templates.map(t=>`
    <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid rgba(33,38,45,.7);flex-wrap:wrap;gap:8px;">
      <div>
        <div style="font-weight:600;font-size:14px;">${t.name}</div>
        <div style="font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--text3);margin-top:2px;">${t.stages.length} stages</div>
      </div>
      <div style="display:flex;gap:6px;">
        <button class="abtn ab-blue" onclick="openTmplEditor('${t.id}')">EDIT STAGES</button>
        <button class="abtn ab-amber" onclick="renameTmpl('${t.id}')">RENAME</button>
        <button class="abtn ab-blue" onclick="dupeTmpl('${t.id}')">DUPE</button>
        ${DB.templates.length>1?`<button class="abtn ab-red" onclick="delTmpl('${t.id}')">DEL</button>`:''}
      </div>
    </div>`).join('');
}

function addTemplate(){
  const name=prompt('Template name:','New Inspection Template');
  if(!name)return;
  DB.templates.push({id:'t'+Date.now(),name,stages:DEFAULT_STAGES.slice()});
  save();renderStagesPage();refreshTmplSelect();toast('Template created','ok');
}

function renameTmpl(id){
  const t=DB.templates.find(t=>t.id===id);
  const name=prompt('New name:',t.name);
  if(!name)return;
  t.name=name;save();renderStagesPage();refreshTmplSelect();toast('Renamed','ok');
}

function dupeTmpl(id){
  const t=DB.templates.find(t=>t.id===id);
  const name=prompt('Name for duplicate:',t.name+' (Copy)');
  if(!name)return;
  DB.templates.push({id:'t'+Date.now(),name,stages:t.stages.slice()});
  save();renderStagesPage();refreshTmplSelect();toast('Duplicated','ok');
}

function delTmpl(id){
  if(!confirm('Delete this template?'))return;
  DB.templates=DB.templates.filter(t=>t.id!==id);
  save();renderStagesPage();refreshTmplSelect();toast('Template removed');
}

function openTmplEditor(id){
  editTmplId=id;
  const t=DB.templates.find(t=>t.id===id);
  $('stage-editor-title').textContent=`Editing: ${t.name}`;
  $('stage-editor-card').style.display='block';
  renderStageLines();
}

function closeStageEditor(){
  $('stage-editor-card').style.display='none';editTmplId=null;
}

function renderStageLines(){
  if(!editTmplId)return;
  const t=DB.templates.find(t=>t.id===editTmplId);
  $('stage-lines').innerHTML=t.stages.map((s,i)=>`
    <div class="stage-list-item">
      <span class="sli-handle">‚†ø</span>
      <input style="flex:1;background:transparent;border:none;border-bottom:1px solid var(--border2);color:var(--text);padding:4px 6px;font-family:'Barlow',sans-serif;font-size:13px;" value="${s}" onchange="updateStageName('${t.id}',${i},this.value)">
      <div class="sli-actions">
        ${i>0?`<button class="abtn ab-ghost" style="padding:2px 6px;" onclick="moveStage('${t.id}',${i},-1)">‚Üë</button>`:'<span style="width:28px;"></span>'}
        ${i<t.stages.length-1?`<button class="abtn ab-ghost" style="padding:2px 6px;" onclick="moveStage('${t.id}',${i},1)">‚Üì</button>`:'<span style="width:28px;"></span>'}
        <button class="abtn ab-red" style="padding:2px 8px;" onclick="removeStage('${t.id}',${i})">‚úï</button>
      </div>
    </div>`).join('');
}

function updateStageName(tid,i,val){
  const t=DB.templates.find(t=>t.id===tid);t.stages[i]=val;save();
}

function addStageLine(){
  const t=DB.templates.find(t=>t.id===editTmplId);
  const name=prompt('New stage name:','');
  if(!name)return;
  t.stages.push(name);save();renderStageLines();toast('Stage added','ok');
}

function moveStage(tid,i,dir){
  const t=DB.templates.find(t=>t.id===tid);
  const j=i+dir;if(j<0||j>=t.stages.length)return;
  [t.stages[i],t.stages[j]]=[t.stages[j],t.stages[i]];save();renderStageLines();
}

function removeStage(tid,i){
  const t=DB.templates.find(t=>t.id===tid);
  if(!confirm(`Remove stage "${t.stages[i]}"?`))return;
  t.stages.splice(i,1);save();renderStageLines();toast('Stage removed');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ADMIN ‚Äî USERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderUsers(){
  $('user-tbody').innerHTML=DB.users.map(u=>`<tr>
    <td><strong>${u.name}</strong></td>
    <td style="font-family:'JetBrains Mono',monospace;font-size:11px;">${u.mob}</td>
    <td>${u.co||'‚Äî'}</td>
    <td style="font-size:11px;">${u.desig||'‚Äî'}</td>
    <td><span class="rpill rp-${u.role}" style="font-size:8px;">${u.role}</span></td>
    <td style="font-size:11px;">${getProj(u.pid)?.number||'‚Äî'}</td>
    <td>${u.approved?'<span style="color:var(--green);font-size:11px;">‚úì Active</span>':'<span style="color:var(--amber);font-size:11px;">‚è≥ Pending</span>'}</td>
    <td>
      <div style="display:flex;gap:4px;flex-wrap:wrap;">
        ${!u.approved?`<button class="abtn ab-green" onclick="approveUser('${u.id}')">APPROVE</button>`:''}
        <button class="abtn ab-amber" onclick="changeRole('${u.id}')">ROLE</button>
        ${u.id!=='u0'?`<button class="abtn ab-red" onclick="delUser('${u.id}')">DEL</button>`:''}
      </div>
    </td>
  </tr>`).join('');
}

function adminAddUser(){
  const name=$('au-name').value.trim(),mob=$('au-mob').value.trim(),pw=$('au-pw').value;
  if(!name||!mob||!pw){toast('Name, mobile and password required','err');return;}
  if(DB.users.find(u=>u.mob===mob)){toast('Mobile already registered','err');return;}
  DB.users.push({id:'u'+Date.now(),name,mob,email:'',co:$('au-co').value.trim(),desig:$('au-desig').value.trim(),role:$('au-role').value,pid:$('au-proj').value,pw,approved:true});
  log(`üë§ USER ADDED ‚Äî ${name}`);save();closeModal('m-add-user');renderUsers();toast('User added','ok');
}

function approveUser(id){
  const u=DB.users.find(u=>u.id===id);u.approved=true;
  log(`‚úÖ APPROVED ‚Äî ${u.name}`);save();renderUsers();toast(`${u.name} approved`,'ok');
}

function changeRole(id){
  const u=DB.users.find(u=>u.id===id);
  const r=prompt('New role (admin/production/quality/manager):',u.role);
  if(!r||!['admin','production','quality','manager'].includes(r)){toast('Invalid role','err');return;}
  u.role=r;log(`üîÑ ROLE CHANGED ‚Äî ${u.name} ‚Üí ${r}`);save();renderUsers();toast('Role updated','ok');
}

function delUser(id){
  if(!confirm('Delete this user?'))return;
  const u=DB.users.find(u=>u.id===id);DB.users=DB.users.filter(us=>us.id!==id);
  log(`üóëÔ∏è USER DELETED ‚Äî ${u.name}`);save();renderUsers();toast('User removed');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LOG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderLog(){
  const roleF=$('log-role-filter')?$('log-role-filter').value:'';
  let entries=DB.log;

  // Apply role filter
  if(roleF) entries=entries.filter(l=>l.role===roleF);

  // Apply activity type filter
  if(activeLogFilter==='offered') entries=entries.filter(l=>l.msg.includes('OFFERED'));
  else if(activeLogFilter==='accepted') entries=entries.filter(l=>l.msg.includes('ACCEPTED')||l.msg.includes('APPROVED'));
  else if(activeLogFilter==='rejected') entries=entries.filter(l=>l.msg.includes('REJECTED'));
  else if(activeLogFilter==='pending') entries=entries.filter(l=>l.msg.includes('PENDING')||l.msg.includes('APPROVAL'));
  else if(activeLogFilter==='user') entries=entries.filter(l=>l.msg.includes('USER')||l.msg.includes('REGISTERED')||l.msg.includes('ROLE'));

  $('log-body').innerHTML=entries.length?entries.map(l=>`
    <div class="log-row">
      <div class="log-time">${l.t} ¬∑ <span style="color:var(--blue2)">${(l.role||'').toUpperCase()}</span> ¬∑ <strong>${l.user}</strong>${l.co?' ('+l.co+')':''}</div>
      <div class="log-msg">${l.msg}</div>
    </div>`).join(''):empty('No matching activity found.');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PRINT SUMMARY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderSummaryPage(){
  const opts=DB.projects.map(p=>`<option value="${p.id}">Project #${p.number} ‚Äî ${p.equipment}</option>`).join('');
  $('print-proj').innerHTML=opts;
  refreshPrintSecs();
  buildPrintPreview();
}

function buildPrintPreview(){
  const pid=$('print-proj')&&$('print-proj').value||DB.projects[0]?.id;
  const filterSec=$('print-sec')&&$('print-sec').value||'';
  const p=getProj(pid);if(!p){$('print-preview').innerHTML=empty('Select a project');return;}
  const st=overallStats(pid);
  const today=new Date().toLocaleDateString('en-IN',{day:'2-digit',month:'long',year:'numeric'});
  const sections=filterSec?[filterSec]:getSections(pid);

  let html=`<div id="printable">
  <div style="text-align:center;padding-bottom:14px;margin-bottom:16px;border-bottom:2px solid var(--blue);">
    <div style="font-family:'Barlow Condensed',sans-serif;font-size:30px;font-weight:800;letter-spacing:5px;color:var(--blue2);">TQIMS</div>
    <div style="font-size:11px;letter-spacing:2px;color:var(--text2);text-transform:uppercase;">Quality Inspection Management System</div>
    <div style="font-size:12px;color:var(--text3);margin-top:4px;">Inspection Summary Report</div>
  </div>
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:12px;margin-bottom:14px;">
    <div><b>Project No.:</b> ${p.number}</div><div><b>Equipment:</b> ${p.equipment}</div>
    <div><b>Client:</b> ${p.client||'‚Äî'}</div><div><b>Process:</b> ${p.process||'‚Äî'}</div>
    <div><b>Code/Standard:</b> ${p.code||'‚Äî'}</div><div><b>Report Date:</b> ${today}</div>
    <div><b>Total Seams:</b> ${st.seams}</div><div><b>Completion:</b> ${st.p}%</div>
  </div>
  <div style="font-size:12px;margin-bottom:16px;display:flex;gap:16px;flex-wrap:wrap;">
    <span style="color:var(--green)">‚úì Accepted: ${st.a}</span>
    <span style="color:var(--amber)">‚¨Ü Awaiting QC: ${st.o}</span>
    <span style="color:var(--red)">‚úó Rejected: ${st.r}</span>
    <span style="color:var(--text3)">‚óã Pending: ${st.t-st.a-st.o-st.r}</span>
  </div>`;

  sections.forEach(sec=>{
    const seams=getSeams(pid,sec);if(!seams.length)return;
    html+=`<div style="margin-bottom:18px;">
      <div style="font-family:'Barlow Condensed',sans-serif;font-size:15px;font-weight:800;letter-spacing:2px;text-transform:uppercase;color:var(--blue2);border-bottom:1px solid var(--border2);padding-bottom:5px;margin-bottom:10px;">SECTION: ${sec}</div>`;
    seams.forEach(seam=>{
      const ss=stageStats(seam);const ncr=hasNCR(seam);
      html+=`<div style="margin-bottom:12px;border:1px solid var(--border2);overflow:hidden;border-radius:2px;">
        <div style="background:var(--surf2);padding:8px 12px;display:flex;justify-content:space-between;flex-wrap:wrap;gap:4px;">
          <div>
            <div style="font-family:'JetBrains Mono',monospace;font-size:12px;font-weight:600;color:var(--blue2);">${seam.num}${ncr?' <span style="color:var(--red);border:1px solid var(--red);padding:1px 4px;font-size:8px;">NCR</span>':''}</div>
            <div style="font-size:11px;color:var(--text2);">${seam.desc} ¬∑ ${seam.type} ¬∑ ${seam.mat} ¬∑ ${seam.thk}mm ¬∑ WPS: ${seam.wps||'‚Äî'}</div>
          </div>
          <div style="font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--cyan);">${ss.a}/${ss.t} ¬∑ ${ss.pct}%</div>
        </div>
        <table style="width:100%;border-collapse:collapse;font-size:10px;">
          <thead><tr>
            <th style="background:rgba(22,27,34,.8);padding:5px 8px;text-align:left;font-family:'JetBrains Mono',monospace;font-size:8px;letter-spacing:1px;color:var(--text3);">#</th>
            <th style="background:rgba(22,27,34,.8);padding:5px 8px;text-align:left;font-family:'JetBrains Mono',monospace;font-size:8px;letter-spacing:1px;color:var(--text3);">Stage</th>
            <th style="background:rgba(22,27,34,.8);padding:5px 8px;text-align:left;font-family:'JetBrains Mono',monospace;font-size:8px;letter-spacing:1px;color:var(--text3);">Status</th>
            <th style="background:rgba(22,27,34,.8);padding:5px 8px;text-align:left;font-family:'JetBrains Mono',monospace;font-size:8px;letter-spacing:1px;color:var(--text3);">Offered By / Company</th>
            <th style="background:rgba(22,27,34,.8);padding:5px 8px;text-align:left;font-family:'JetBrains Mono',monospace;font-size:8px;letter-spacing:1px;color:var(--text3);">Location</th>
            <th style="background:rgba(22,27,34,.8);padding:5px 8px;text-align:left;font-family:'JetBrains Mono',monospace;font-size:8px;letter-spacing:1px;color:var(--text3);">Inspected By</th>
            <th style="background:rgba(22,27,34,.8);padding:5px 8px;text-align:left;font-family:'JetBrains Mono',monospace;font-size:8px;letter-spacing:1px;color:var(--text3);">QE Remarks</th>
          </tr></thead>
          <tbody>${seam.stages.map((st,i)=>{
            const sc=st.status==='accepted'?'var(--green)':st.status==='rejected'?'var(--red)':st.status==='offered'?'var(--amber)':st.status==='returned'?'#79c0ff':'var(--text3)';
            const stLabel=st.status==='returned'?'RETURNED':st.status.toUpperCase();
            return`<tr><td style="padding:4px 8px;border-bottom:1px solid rgba(33,38,45,.5);font-family:'JetBrains Mono',monospace;">${i+1}</td>
              <td style="padding:4px 8px;border-bottom:1px solid rgba(33,38,45,.5);">${st.name}</td>
              <td style="padding:4px 8px;border-bottom:1px solid rgba(33,38,45,.5);color:${sc};font-weight:600;text-transform:uppercase;font-size:9px;">${stLabel}${st.ncrNumber?`<br><span style="color:var(--red);font-size:8px;">NCR: ${st.ncrNumber}</span>`:''}</td>
              <td style="padding:4px 8px;border-bottom:1px solid rgba(33,38,45,.5);font-size:10px;">${st.offeredBy?st.offeredBy+'<br><span style="color:var(--text3);font-size:9px;">'+st.offeredByCo+'</span><br><span style="color:var(--text3);font-size:9px;">'+st.offeredAt+'</span>':'‚Äî'}</td>
              <td style="padding:4px 8px;border-bottom:1px solid rgba(33,38,45,.5);">${st.location||'‚Äî'}</td>
              <td style="padding:4px 8px;border-bottom:1px solid rgba(33,38,45,.5);font-size:10px;">${st.inspectedBy?st.inspectedBy+'<br><span style="color:var(--text3);font-size:9px;">'+st.inspectedAt+'</span>':'‚Äî'}</td>
              <td style="padding:4px 8px;border-bottom:1px solid rgba(33,38,45,.5);">${st.qeRem||'‚Äî'}</td>
            </tr>`;
          }).join('')}</tbody>
        </table></div>`;
    });
    html+='</div>';
  });

  // Signature block
  html+=`<div style="margin-top:28px;border-top:1px solid var(--border2);padding-top:18px;">
    <div style="font-family:'Barlow Condensed',sans-serif;font-size:13px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--text2);margin-bottom:18px;">AUTHORIZATIONS & SIGNATURES</div>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:20px;">
      ${['Quality Engineer (QE)','CTR Representative','CPY (Company)'].map(r=>`
      <div style="border:1px solid var(--border2);padding:14px;">
        <div style="font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:1px;color:var(--text2);margin-bottom:36px;">${r}</div>
        <div style="border-top:1px solid var(--text3);margin-bottom:6px;"></div>
        <div style="font-size:10px;color:var(--text3);">Name: ________________________</div>
        <div style="font-size:10px;color:var(--text3);margin-top:4px;">Date: _________________________</div>
      </div>`).join('')}
    </div>
  </div>
  <div style="margin-top:16px;text-align:center;font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--text3);border-top:1px solid var(--border2);padding-top:10px;">
    TQIMS ¬∑ Quality Inspection Management System ¬∑ Designed by Ujval Dharawaparmar ¬∑ Generated: ${today}
  </div></div>`;

  $('print-preview').innerHTML=html;
}

function doPrint(){
  buildPrintPreview();
  setTimeout(()=>{
    const c=$('printable');if(!c)return;
    const w=window.open('','_blank');
    w.document.write(`<!DOCTYPE html><html><head><title>TQIMS Report</title>
    <style>*{box-sizing:border-box;margin:0;padding:0;}body{font-family:Arial,sans-serif;background:#fff;color:#111;padding:12mm;font-size:10pt;}@media print{@page{size:A4;margin:10mm;}body{padding:0;}}</style>
    </head><body>`);
    // Write a clean light-theme version
    const clone=c.innerHTML
      .replace(/var\(--blue2\)/g,'#1f6feb').replace(/var\(--blue\)/g,'#1f6feb')
      .replace(/var\(--cyan\)/g,'#0891b2').replace(/var\(--green\)/g,'#059669')
      .replace(/var\(--red\)/g,'#dc2626').replace(/var\(--amber\)/g,'#d97706')
      .replace(/var\(--text\)/g,'#111').replace(/var\(--text2\)/g,'#374151')
      .replace(/var\(--text3\)/g,'#6b7280').replace(/var\(--border2\)/g,'#d1d5db')
      .replace(/var\(--border\)/g,'#e5e7eb').replace(/var\(--surf2\)/g,'#f3f4f6')
      .replace(/var\(--surf\)/g,'#fff').replace(/rgba\(22,27,34,\.8\)/g,'#f3f4f6')
      .replace(/rgba\(33,38,45,.*/g,'#e5e7eb)').replace(/rgba\(22,27,34.*?\)/g,'#f3f4f6');
    w.document.write(clone);
    w.document.write('</body></html>');w.document.close();w.focus();
    setTimeout(()=>w.print(),600);
  },200);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PROFILE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderProfile(){
  if(!CU)return;
  const p=getProj(CU.pid);
  $('profile-rows').innerHTML=`
    <div class="ir"><span class="ir-k">Full Name</span><span class="ir-v">${CU.name}</span></div>
    <div class="ir"><span class="ir-k">Mobile</span><span class="ir-v">${CU.mob}</span></div>
    <div class="ir"><span class="ir-k">Email</span><span class="ir-v">${CU.email||'‚Äî'}</span></div>
    <div class="ir"><span class="ir-k">Company</span><span class="ir-v">${CU.co||'‚Äî'}</span></div>
    <div class="ir"><span class="ir-k">Designation</span><span class="ir-v">${CU.desig||'‚Äî'}</span></div>
    <div class="ir"><span class="ir-k">Role</span><span class="ir-v"><span class="rpill rp-${CU.role}">${CU.role.toUpperCase()}</span></span></div>
    <div class="ir"><span class="ir-k">Project</span><span class="ir-v">${p?`#${p.number} ‚Äî ${p.equipment}`:'‚Äî'}</span></div>
  `;
  $('cp-cur').value='';$('cp-new').value='';$('cp-cnf').value='';$('cp-msg').innerHTML='';
  $('secret-key-card').style.display=CU.role==='admin'?'block':'none';
  if(CU.role==='admin'){$('sk-cur').value='';$('sk-new').value='';$('sk-cnf').value='';$('sk-msg').innerHTML='';}
}

function changePassword(){
  const cur=$('cp-cur').value,nw=$('cp-new').value,cnf=$('cp-cnf').value;
  if(!cur||!nw||!cnf){$('cp-msg').innerHTML='<div class="msg msg-err">Fill all fields.</div>';return;}
  if(cur!==CU.pw){$('cp-msg').innerHTML='<div class="msg msg-err">Current password incorrect.</div>';return;}
  if(nw.length<6){$('cp-msg').innerHTML='<div class="msg msg-err">Min 6 characters.</div>';return;}
  if(nw!==cnf){$('cp-msg').innerHTML='<div class="msg msg-err">New passwords do not match.</div>';return;}
  const u=DB.users.find(u=>u.id===CU.id);u.pw=nw;CU.pw=nw;
  log(`üîí PASSWORD CHANGED ‚Äî ${CU.name}`);save();
  $('cp-msg').innerHTML='<div class="msg msg-ok">‚úì Password updated!</div>';
  $('cp-cur').value='';$('cp-new').value='';$('cp-cnf').value='';
  toast('Password changed','ok');
}

function changeSecretKey(){
  const cur=$('sk-cur').value,nw=$('sk-new').value,cnf=$('sk-cnf').value;
  if(!cur||!nw||!cnf){$('sk-msg').innerHTML='<div class="msg msg-err">Fill all fields.</div>';return;}
  if(cur!==DB.secretKey){$('sk-msg').innerHTML='<div class="msg msg-err">Current key incorrect.</div>';return;}
  if(nw.length<8){$('sk-msg').innerHTML='<div class="msg msg-err">Min 8 characters.</div>';return;}
  if(nw!==cnf){$('sk-msg').innerHTML='<div class="msg msg-err">Keys do not match.</div>';return;}
  DB.secretKey=nw;log(`üîë SECRET KEY CHANGED by ${CU.name}`);save();
  $('sk-msg').innerHTML='<div class="msg msg-ok">‚úì Secret key updated!</div>';
  $('sk-cur').value='';$('sk-new').value='';$('sk-cnf').value='';
  toast('Secret key updated','ok');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BACKUP & RESTORE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderBackupPage(){
  const seams=DB.seams.length;
  const stages=DB.seams.reduce((a,s)=>a+s.stages.length,0);
  const accepted=DB.seams.reduce((a,s)=>a+s.stages.filter(st=>st.status==='accepted').length,0);
  const logCount=DB.log.length;
  const users=DB.users.length;
  const size=Math.round(JSON.stringify(DB).length/1024);
  $('backup-stats').innerHTML=`
    Projects: ${DB.projects.length} &nbsp;|&nbsp; Seams: ${seams} &nbsp;|&nbsp; Total Stages: ${stages}<br>
    Accepted Stages: ${accepted} &nbsp;|&nbsp; Log Entries: ${logCount} &nbsp;|&nbsp; Users: ${users}<br>
    Data Size: ~${size} KB
  `;
  const last=localStorage.getItem('tqims3_last_backup');
  $('last-backup-time').textContent=last?`Last backup: ${last}`:'No backup taken yet on this device';
}

function exportBackup(){
  const ts=new Date().toLocaleString('en-IN',{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit',hour12:false}).replace(/[\s,:\/]+/g,'-');
  const filename=`TQIMS-Backup-${ts}.json`;
  const data=JSON.stringify(DB,null,2);
  const blob=new Blob([data],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');a.href=url;a.download=filename;
  document.body.appendChild(a);a.click();document.body.removeChild(a);
  URL.revokeObjectURL(url);
  const timeStr=new Date().toLocaleString('en-IN');
  localStorage.setItem('tqims3_last_backup',timeStr);
  log(`üíæ BACKUP EXPORTED ‚Äî ${filename} by ${CU.name}`);save();
  $('last-backup-time').textContent=`Last backup: ${timeStr}`;
  toast('‚úì Backup file downloaded successfully','ok');
}

function importBackup(input){
  const file=input.files[0];
  if(!file){return;}
  const reader=new FileReader();
  reader.onload=function(e){
    try{
      const parsed=JSON.parse(e.target.result);
      // Validate it's a TQIMS backup
      if(!parsed.projects||!parsed.seams||!parsed.users){
        $('import-msg').innerHTML='<div class="msg msg-err">‚ùå Invalid backup file. Not a TQIMS backup.</div>';return;
      }
      if(!parsed.pendingActions)parsed.pendingActions=[];
      if(!parsed.templates)parsed.templates=[{id:'t1',name:'Standard Weld Inspection',stages:DEFAULT_STAGES.slice()}];
      if(!parsed.secretKey)parsed.secretKey='TQIMS@Admin2024';
      DB=parsed;save();
      $('import-msg').innerHTML=`<div class="msg msg-ok">‚úì Backup restored! ${parsed.projects.length} projects, ${parsed.seams.length} seams, ${parsed.users.length} users loaded.</div>`;
      log(`üì• BACKUP IMPORTED ‚Äî by ${CU.name}`);save();
      toast('‚úì Data restored from backup','ok');
      // Refresh current user reference from restored DB
      if(CU){const refreshed=DB.users.find(u=>u.id===CU.id);if(refreshed)CU=refreshed;}
      populateSelects();
      setTimeout(()=>{renderBackupPage();renderDashboard();},800);
    }catch(err){
      $('import-msg').innerHTML='<div class="msg msg-err">‚ùå File is corrupted or not valid JSON.</div>';
    }
    input.value='';
  };
  reader.readAsText(file);
}

function resetAllData(){
  if(!confirm('‚ö† This will DELETE ALL DATA and reset to defaults.\n\nAre you absolutely sure?'))return;
  if(!confirm('FINAL WARNING: All seams, inspection records, users and logs will be lost. Continue?'))return;
  localStorage.removeItem('tqims3');
  DB=defaultDB();save();
  log(`üîÑ SYSTEM RESET TO DEFAULTS by ${CU.name}`);save();
  populateSelects();renderBackupPage();renderDashboard();
  toast('System reset to defaults');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STAGE FILTER (Inspection page)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let activeStageFilter='all';

function setStageFilter(f,el){
  activeStageFilter=f;
  document.querySelectorAll('[data-f]').forEach(c=>c.classList.remove('on'));
  el.classList.add('on');
  renderInspSeams();
}

function populateStageNameFilter(){
  const el=$('stage-name-filter');if(!el)return;
  // Collect all unique stage names across all templates
  const names=new Set();
  DB.templates.forEach(t=>t.stages.forEach(s=>names.add(s)));
  DB.seams.forEach(s=>s.stages.forEach(st=>names.add(st.name)));
  const cur=el.value;
  el.innerHTML='<option value="">All Stage Types</option>'+[...names].map(n=>`<option value="${n}" ${n===cur?'selected':''}>${n}</option>`).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LOG FILTER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let activeLogFilter='all';

function setLogFilter(f,el){
  activeLogFilter=f;
  document.querySelectorAll('[data-lf]').forEach(c=>c.classList.remove('on'));
  el.classList.add('on');
  renderLog();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MANAGER APPROVALS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateApprovalBadge(){
  const count=DB.pendingActions.length;
  const nb=$('nb-approvals');
  if(nb){nb.style.display=count>0?'inline':'none';nb.textContent=count;}
}

function renderApprovals(){
  updateApprovalBadge();
  if(!DB.pendingActions.length){
    $('approvals-body').innerHTML=`<div style="text-align:center;padding:40px;font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--green);">‚úì No pending approvals. All up to date.</div>`;
    return;
  }
  $('approvals-body').innerHTML=`
    <div class="chead"><div class="ctitle">Pending Requests (${DB.pendingActions.length})</div></div>
    ${DB.pendingActions.map(a=>`
      <div style="display:flex;align-items:flex-start;justify-content:space-between;padding:14px 0;border-bottom:1px solid rgba(33,38,45,.7);flex-wrap:wrap;gap:10px;">
        <div style="flex:1;min-width:200px;">
          <div style="font-weight:600;font-size:13px;margin-bottom:3px;">${a.desc}</div>
          <div style="font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--text3);">Requested by: ${a.requestedBy} ¬∑ ${a.requestedAt}</div>
          <div style="margin-top:5px;">
            ${a.type==='add_seam'||a.type==='edit_seam'?`<span class="chip ch-off" style="font-size:8px;">SEAM CHANGE</span>`:
              a.type==='del_seam'?`<span class="chip ch-rej" style="font-size:8px;">DELETE SEAM</span>`:
              a.type==='add_proj'?`<span class="chip ch-off" style="font-size:8px;">NEW PROJECT</span>`:
              a.type==='edit_proj'?`<span class="chip ch-off" style="font-size:8px;">EDIT PROJECT</span>`:
              a.type==='ncr_reoffer'?`<span class="chip ch-ncr" style="font-size:8px;">üî¥ NCR RE-OFFER</span>`:
              `<span class="chip ch-rej" style="font-size:8px;">DELETE PROJECT</span>`}
          </div>
        </div>
        <div style="display:flex;gap:8px;align-items:center;">
          <button class="abtn ab-red" onclick="rejectAction('${a.id}')">‚úó REJECT</button>
          <button class="abtn ab-green" onclick="approveAction('${a.id}')">‚úì APPROVE</button>
        </div>
      </div>`).join('')}
  `;
}

function approveAction(id){
  const a=DB.pendingActions.find(x=>x.id===id);
  if(!a)return;
  if(a.type==='add_seam'){DB.seams.push(a.data);log(`‚úÖ APPROVED & ADDED ‚Äî ${a.desc} (approved by ${CU.name})`);}
  else if(a.type==='edit_seam'){const s=getSeam(a.data.id);if(s){Object.assign(s,a.data);}log(`‚úÖ APPROVED & EDITED ‚Äî ${a.desc} (approved by ${CU.name})`);}
  else if(a.type==='del_seam'){DB.seams=DB.seams.filter(s=>s.id!==a.data.id);log(`‚úÖ APPROVED & DELETED ‚Äî ${a.desc} (approved by ${CU.name})`);}
  else if(a.type==='add_proj'){DB.projects.push(a.data);log(`‚úÖ APPROVED & ADDED ‚Äî ${a.desc} (approved by ${CU.name})`);}
  else if(a.type==='edit_proj'){const p=getProj(a.data.id);if(p){Object.assign(p,a.data);}log(`‚úÖ APPROVED & EDITED ‚Äî ${a.desc} (approved by ${CU.name})`);}
  else if(a.type==='del_proj'){DB.projects=DB.projects.filter(p=>p.id!==a.data.id);DB.seams=DB.seams.filter(s=>s.pid!==a.data.id);log(`‚úÖ APPROVED & DELETED ‚Äî ${a.desc} (approved by ${CU.name})`);}
  else if(a.type==='ncr_reoffer'){
    const d=a.data;
    const seam=getSeam(d.seamId);
    if(seam&&seam.stages[d.idx]){
      const st=seam.stages[d.idx];
      st.status='offered';
      st.offeredBy=d.offeredBy;st.offeredByMob=d.offeredByMob;st.offeredByCo=d.offeredByCo;
      st.offeredAt=d.offeredAt;st.location=d.loc;st.drawing=d.drw;st.prodRem=d.rem;
      st.ncrNumber=d.ncrNumber;
      st.inspectedBy='';st.inspectedAt='';st.qeRem='';
      log(`‚úÖ NCR RE-OFFER APPROVED ‚Äî ${seam.num} ¬∑ ${st.name} ¬∑ NCR: ${d.ncrNumber} (approved by ${CU.name}) ‚Äî Now offered for QC inspection`);
    }
  }
  DB.pendingActions=DB.pendingActions.filter(x=>x.id!==id);
  save();populateSelects();renderApprovals();updateApprovalBadge();
  toast('Approved & applied','ok');
}

function rejectAction(id){
  const a=DB.pendingActions.find(x=>x.id===id);if(!a)return;
  log(`‚ùå REJECTED ‚Äî ${a.desc} (rejected by ${CU.name})`);
  DB.pendingActions=DB.pendingActions.filter(x=>x.id!==id);
  save();renderApprovals();updateApprovalBadge();
  toast('Request rejected');
}
(function init(){
  $('scr-auth').classList.add('on');
  showTab('login');
})();
</script>
</body>
</html>
