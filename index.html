<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TQIMS ‚Äî Quality Inspection Management System</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@400;600;700;800&family=JetBrains+Mono:wght@400;500&family=Barlow:wght@300;400;500;600&display=swap');

:root{
  --bg:#07090f; --surf:#0d1117; --surf2:#161b22; --surf3:#1c2333;
  --border:#21262d; --border2:#30363d;
  --blue:#1f6feb; --blue2:#388bfd; --cyan:#39d353;
  --green:#3fb950; --amber:#d29922; --red:#f85149; --purple:#bc8cff;
  --text:#e6edf3; --text2:#8b949e; --text3:#484f58;
  --accent:#1f6feb;
}
*{box-sizing:border-box;margin:0;padding:0;}
html{scroll-behavior:smooth;}
body{font-family:'Barlow',sans-serif;background:var(--bg);color:var(--text);font-size:14px;line-height:1.5;}

/* ‚îÄ‚îÄ‚îÄ SCREENS ‚îÄ‚îÄ‚îÄ */
.scr{display:none;}
.scr.on{display:block;}

/* ‚îÄ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ‚îÄ */
#scr-auth{min-height:100vh;display:none;align-items:flex-start;justify-content:center;padding:24px 16px;background:var(--bg);}
#scr-auth.on{display:flex;}
.acard{background:var(--surf);border:1px solid var(--border2);width:100%;max-width:460px;padding:32px 28px;position:relative;margin:auto;}
.acard::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--blue),var(--cyan));}
.logo-big{font-family:'Barlow Condensed',sans-serif;font-size:34px;font-weight:800;letter-spacing:5px;color:var(--blue2);margin-bottom:2px;}
.logo-sub{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text3);letter-spacing:2px;text-transform:uppercase;margin-bottom:26px;}
.atabs{display:flex;border:1px solid var(--border2);margin-bottom:22px;}
.atab{flex:1;padding:10px;text-align:center;cursor:pointer;font-family:'Barlow Condensed',sans-serif;font-size:13px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--text3);transition:all .2s;border:none;background:none;}
.atab.on{background:var(--blue);color:#fff;}
.aform{display:none;flex-direction:column;gap:13px;}
.aform.on{display:flex;}
.lbl{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--text3);letter-spacing:1.5px;text-transform:uppercase;display:block;margin-bottom:4px;}
input,select,textarea{width:100%;background:var(--surf2);border:1px solid var(--border2);color:var(--text);padding:9px 12px;font-family:'Barlow',sans-serif;font-size:13px;outline:none;transition:border-color .2s;border-radius:2px;}
input:focus,select:focus,textarea:focus{border-color:var(--blue);}
select option{background:var(--surf2);}
textarea{resize:vertical;min-height:60px;}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.span2{grid-column:1/-1;}
.rchips{display:flex;gap:6px;flex-wrap:wrap;}
.rchip{flex:1;padding:7px 10px;text-align:center;border:1px solid var(--border2);color:var(--text2);cursor:pointer;font-family:'Barlow Condensed',sans-serif;font-size:12px;font-weight:700;letter-spacing:1px;text-transform:uppercase;transition:all .2s;border-radius:2px;}
.rchip.on{border-color:var(--blue);background:rgba(31,111,235,.15);color:var(--blue2);}
.btn{padding:11px 20px;font-family:'Barlow Condensed',sans-serif;font-size:14px;font-weight:700;letter-spacing:2px;text-transform:uppercase;cursor:pointer;border:none;transition:all .2s;border-radius:2px;display:inline-block;}
.btn-w{width:100%;}
.btn-blue{background:var(--blue);color:#fff;}
.btn-blue:hover{background:var(--blue2);}
.btn-green{background:var(--green);color:#fff;}
.btn-red{background:var(--red);color:#fff;}
.btn-amber{background:var(--amber);color:#000;}
.btn-ghost{background:none;border:1px solid var(--border2);color:var(--text2);}
.btn-ghost:hover{border-color:var(--blue);color:var(--blue2);}
.alink{text-align:center;font-size:11px;color:var(--text3);margin-top:4px;}
.alink a{color:var(--blue2);cursor:pointer;text-decoration:none;}
.alink a:hover{text-decoration:underline;}
.msg{font-family:'JetBrains Mono',monospace;font-size:10px;padding:8px 10px;border:1px solid;border-radius:2px;}
.msg-err{color:var(--red);border-color:rgba(248,81,73,.3);background:rgba(248,81,73,.07);}
.msg-ok{color:var(--green);border-color:rgba(63,185,80,.3);background:rgba(63,185,80,.07);}
.msg-warn{color:var(--amber);border-color:rgba(210,153,34,.3);background:rgba(210,153,34,.07);}
.credit{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--text3);text-align:center;margin-top:20px;letter-spacing:1px;}

/* ‚îÄ‚îÄ‚îÄ APP SHELL ‚îÄ‚îÄ‚îÄ */
#scr-app{display:none;min-height:100vh;flex-direction:column;}
#scr-app.on{display:flex;}
.topbar{display:flex;align-items:center;justify-content:space-between;background:var(--surf);border-bottom:1px solid var(--border2);padding:0 16px;height:52px;position:sticky;top:0;z-index:300;flex-shrink:0;}
.tb-left{display:flex;align-items:center;gap:12px;}
.tb-logo{font-family:'Barlow Condensed',sans-serif;font-size:20px;font-weight:800;letter-spacing:3px;color:var(--blue2);}
.ham{background:none;border:none;color:var(--text2);font-size:22px;cursor:pointer;padding:4px;display:none;}
.tb-right{display:flex;align-items:center;gap:8px;}
.rpill{font-family:'JetBrains Mono',monospace;font-size:9px;padding:3px 8px;border:1px solid;letter-spacing:1px;text-transform:uppercase;border-radius:2px;}
.rp-admin{color:var(--amber);border-color:var(--amber);background:rgba(210,153,34,.1);}
.rp-production{color:#79c0ff;border-color:#79c0ff;background:rgba(121,192,255,.1);}
.rp-quality{color:var(--green);border-color:var(--green);background:rgba(63,185,80,.1);}
.rp-manager{color:var(--purple);border-color:var(--purple);background:rgba(188,140,255,.1);}
.tb-user{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text2);}
.tb-logout{background:none;border:1px solid var(--border2);color:var(--text3);padding:5px 12px;font-family:'JetBrains Mono',monospace;font-size:9px;letter-spacing:1px;cursor:pointer;border-radius:2px;}
.tb-logout:hover{border-color:var(--red);color:var(--red);}

/* ‚îÄ‚îÄ‚îÄ BODY LAYOUT ‚îÄ‚îÄ‚îÄ */
.app-body{display:flex;flex:1;}
.sidebar{width:220px;background:var(--surf);border-right:1px solid var(--border2);padding:12px 0;flex-shrink:0;position:sticky;top:52px;height:calc(100vh - 52px);overflow-y:auto;transition:transform .3s;}
.sg-lbl{font-family:'JetBrains Mono',monospace;font-size:8px;color:var(--text3);letter-spacing:2px;text-transform:uppercase;padding:10px 16px 4px;}
.nitem{display:flex;align-items:center;gap:9px;padding:9px 16px;cursor:pointer;color:var(--text2);font-size:13px;font-weight:500;transition:all .15s;border-left:3px solid transparent;}
.nitem:hover{background:var(--surf2);color:var(--text);}
.nitem.on{background:rgba(31,111,235,.12);color:var(--blue2);border-left-color:var(--blue);}
.nitem .ni{font-size:15px;width:18px;text-align:center;}
.nbadge{margin-left:auto;background:var(--amber);color:#000;font-family:'JetBrains Mono',monospace;font-size:8px;padding:1px 5px;font-weight:700;border-radius:2px;}
.sov{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:299;}

/* ‚îÄ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ‚îÄ */
.main{flex:1;padding:24px;min-width:0;overflow-x:hidden;}

/* ‚îÄ‚îÄ‚îÄ PAGES ‚îÄ‚îÄ‚îÄ */
.pg{display:none;}
.pg.on{display:block;}
.pgh{margin-bottom:20px;}
.pgt{font-family:'Barlow Condensed',sans-serif;font-size:24px;font-weight:800;letter-spacing:2px;text-transform:uppercase;}
.pgs{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--text3);letter-spacing:1px;margin-top:2px;}

/* ‚îÄ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ‚îÄ */
.card{background:var(--surf);border:1px solid var(--border2);padding:16px;margin-bottom:14px;border-radius:3px;}
.chead{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;flex-wrap:wrap;gap:8px;}
.ctitle{font-family:'Barlow Condensed',sans-serif;font-size:13px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--text2);}

/* ‚îÄ‚îÄ‚îÄ STATS ‚îÄ‚îÄ‚îÄ */
.sgrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:10px;margin-bottom:18px;}
.sbox{background:var(--surf);border:1px solid var(--border2);padding:14px;position:relative;border-radius:3px;overflow:hidden;}
.sbox::after{content:'';position:absolute;top:0;left:0;right:0;height:2px;}
.sb-blue::after{background:var(--blue2);}
.sb-green::after{background:var(--green);}
.sb-amber::after{background:var(--amber);}
.sb-red::after{background:var(--red);}
.sb-grey::after{background:var(--text3);}
.snum{font-family:'Barlow Condensed',sans-serif;font-size:32px;font-weight:800;line-height:1;margin-bottom:3px;}
.slbl{font-family:'JetBrains Mono',monospace;font-size:8px;color:var(--text3);letter-spacing:1.5px;text-transform:uppercase;}

/* ‚îÄ‚îÄ‚îÄ PROGRESS ‚îÄ‚îÄ‚îÄ */
.pbar{width:100%;height:3px;background:var(--border2);border-radius:2px;overflow:hidden;}
.pfill{height:100%;background:linear-gradient(90deg,var(--blue),var(--cyan));transition:width .4s;}

/* ‚îÄ‚îÄ‚îÄ PROJECT BAR ‚îÄ‚îÄ‚îÄ */
.projbar{display:flex;flex-wrap:wrap;gap:16px;background:var(--surf);border:1px solid var(--border2);padding:12px 16px;margin-bottom:18px;border-radius:3px;}
.pf-lbl{font-family:'JetBrains Mono',monospace;font-size:8px;color:var(--text3);letter-spacing:1.5px;text-transform:uppercase;}
.pf-val{font-family:'Barlow Condensed',sans-serif;font-size:14px;font-weight:700;color:var(--blue2);letter-spacing:1px;}

/* ‚îÄ‚îÄ‚îÄ SECTION TABS ‚îÄ‚îÄ‚îÄ */
.stabs{display:flex;border-bottom:1px solid var(--border2);flex-wrap:wrap;margin-bottom:16px;gap:0;overflow-x:auto;}
.stab{padding:8px 16px;cursor:pointer;font-family:'Barlow Condensed',sans-serif;font-size:12px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--text3);border-bottom:2px solid transparent;margin-bottom:-1px;white-space:nowrap;transition:all .2s;}
.stab:hover{color:var(--text2);}
.stab.on{color:var(--blue2);border-bottom-color:var(--blue);}

/* ‚îÄ‚îÄ‚îÄ DASHBOARD SEAM GRID ‚îÄ‚îÄ‚îÄ */
.dash-section{margin-bottom:24px;}
.dash-sec-title{font-family:'Barlow Condensed',sans-serif;font-size:16px;font-weight:800;letter-spacing:2px;text-transform:uppercase;color:var(--blue2);padding:8px 0;border-bottom:1px solid var(--border2);margin-bottom:12px;display:flex;align-items:center;justify-content:space-between;}
.seam-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:8px;}
.seam-tile{background:var(--surf2);border:1px solid var(--border2);padding:12px;cursor:pointer;transition:all .2s;border-radius:3px;position:relative;}
.seam-tile:hover{border-color:var(--blue);background:var(--surf3);}
.seam-tile.st-done{border-left:3px solid var(--green);}
.seam-tile.st-active{border-left:3px solid var(--amber);}
.seam-tile.st-rejected{border-left:3px solid var(--red);}
.seam-tile.st-pending{border-left:3px solid var(--border2);}
.st-seam-num{font-family:'JetBrains Mono',monospace;font-size:11px;font-weight:500;color:var(--blue2);margin-bottom:3px;}
.st-seam-desc{font-size:10px;color:var(--text2);margin-bottom:6px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.st-seam-pct{font-family:'Barlow Condensed',sans-serif;font-size:18px;font-weight:700;color:var(--text);}
.st-seam-meta{font-family:'JetBrains Mono',monospace;font-size:8px;color:var(--text3);margin-top:2px;}
.ncr-dot{position:absolute;top:6px;right:6px;width:6px;height:6px;background:var(--red);border-radius:50%;}

/* ‚îÄ‚îÄ‚îÄ INSPECTION / SEAM DETAIL ‚îÄ‚îÄ‚îÄ */
.seam-detail-card{background:var(--surf);border:1px solid var(--border2);margin-bottom:12px;border-radius:3px;overflow:hidden;}
.sdh{padding:12px 16px;background:var(--surf2);border-bottom:1px solid var(--border2);display:flex;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;gap:8px;}
.sd-num{font-family:'JetBrains Mono',monospace;font-size:13px;color:var(--blue2);font-weight:500;}
.sd-desc{font-size:12px;color:var(--text2);margin-top:2px;}
.sd-meta{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--text3);margin-top:3px;}
.stage-row{display:flex;align-items:flex-start;gap:10px;padding:10px 16px;border-bottom:1px solid rgba(33,38,45,.7);}
.stage-row:last-child{border-bottom:none;}
.sr-num{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--text3);width:18px;flex-shrink:0;padding-top:2px;}
.sr-info{flex:1;min-width:0;}
.sr-name{font-size:13px;font-weight:500;}
.sr-detail{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--text3);margin-top:3px;line-height:1.6;}
.sr-remark{font-family:'JetBrains Mono',monospace;font-size:9px;margin-top:3px;}
.sr-actions{flex-shrink:0;display:flex;flex-direction:column;align-items:flex-end;gap:4px;}

/* ‚îÄ‚îÄ‚îÄ CHIPS ‚îÄ‚îÄ‚îÄ */
.chip{display:inline-flex;align-items:center;gap:3px;padding:2px 7px;font-family:'JetBrains Mono',monospace;font-size:8px;letter-spacing:.8px;border:1px solid;text-transform:uppercase;border-radius:2px;white-space:nowrap;}
.ch-pend{color:var(--text3);border-color:var(--border2);}
.ch-off{color:var(--amber);border-color:var(--amber);background:rgba(210,153,34,.08);}
.ch-acc{color:var(--green);border-color:var(--green);background:rgba(63,185,80,.08);}
.ch-rej{color:var(--red);border-color:var(--red);background:rgba(248,81,73,.08);}
.ch-lock{color:var(--text3);border-color:var(--text3);background:rgba(72,79,88,.15);}

/* ‚îÄ‚îÄ‚îÄ ACTION BTNS ‚îÄ‚îÄ‚îÄ */
.abtn{padding:4px 10px;font-family:'JetBrains Mono',monospace;font-size:9px;letter-spacing:1px;border:1px solid;background:none;cursor:pointer;transition:all .2s;white-space:nowrap;text-transform:uppercase;border-radius:2px;}
.ab-blue{color:var(--blue2);border-color:var(--blue2);}
.ab-blue:hover{background:rgba(56,139,253,.1);}
.ab-green{color:var(--green);border-color:var(--green);}
.ab-green:hover{background:rgba(63,185,80,.1);}
.ab-red{color:var(--red);border-color:var(--red);}
.ab-red:hover{background:rgba(248,81,73,.1);}
.ab-amber{color:var(--amber);border-color:var(--amber);}
.ab-amber:hover{background:rgba(210,153,34,.1);}
.ab-ghost{color:var(--text3);border-color:var(--border2);}
.ab-ghost:hover{color:var(--text);border-color:var(--text2);}

/* ‚îÄ‚îÄ‚îÄ TABLES ‚îÄ‚îÄ‚îÄ */
.tbl-wrap{overflow-x:auto;}
table{width:100%;border-collapse:collapse;font-size:12px;min-width:400px;}
th{background:var(--surf2);padding:8px 12px;text-align:left;font-family:'JetBrains Mono',monospace;font-size:8px;letter-spacing:1.5px;text-transform:uppercase;color:var(--text3);border-bottom:1px solid var(--border2);white-space:nowrap;}
td{padding:9px 12px;border-bottom:1px solid rgba(33,38,45,.7);vertical-align:middle;}
tr:hover td{background:rgba(255,255,255,.015);}

/* ‚îÄ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ‚îÄ */
.mbg{display:none;position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:500;align-items:flex-start;justify-content:center;padding:16px;overflow-y:auto;backdrop-filter:blur(3px);}
.mbg.on{display:flex;}
.modal{background:var(--surf);border:1px solid var(--border2);width:100%;max-width:520px;position:relative;border-radius:3px;margin:auto;}
.modal::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--blue),var(--cyan));border-radius:3px 3px 0 0;}
.mhead{padding:16px 20px;border-bottom:1px solid var(--border2);display:flex;justify-content:space-between;align-items:center;}
.mtitle{font-family:'Barlow Condensed',sans-serif;font-size:17px;font-weight:700;letter-spacing:2px;text-transform:uppercase;}
.mclose{background:none;border:none;color:var(--text2);font-size:20px;cursor:pointer;line-height:1;padding:0 2px;}
.mbody{padding:20px;}
.mfoot{padding:12px 20px;border-top:1px solid var(--border2);display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap;}
.ir{display:flex;justify-content:space-between;align-items:flex-start;padding:6px 0;border-bottom:1px solid rgba(33,38,45,.7);gap:10px;}
.ir:last-child{border-bottom:none;}
.ir-k{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--text3);letter-spacing:1px;flex-shrink:0;min-width:110px;}
.ir-v{font-size:12px;font-weight:500;text-align:right;}

/* ‚îÄ‚îÄ‚îÄ BACK BUTTON ‚îÄ‚îÄ‚îÄ */
.back-btn{display:inline-flex;align-items:center;gap:6px;font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text3);cursor:pointer;margin-bottom:16px;transition:color .2s;}
.back-btn:hover{color:var(--blue2);}

/* ‚îÄ‚îÄ‚îÄ LOG ‚îÄ‚îÄ‚îÄ */
.log-row{padding:9px 0;border-bottom:1px solid rgba(33,38,45,.7);}
.log-row:last-child{border-bottom:none;}
.log-time{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--text3);}
.log-msg{font-size:12px;color:var(--text2);margin-top:2px;line-height:1.5;}

/* ‚îÄ‚îÄ‚îÄ STAGE MANAGER (ADMIN) ‚îÄ‚îÄ‚îÄ */
.stage-list-item{display:flex;align-items:center;gap:8px;padding:8px 12px;background:var(--surf2);border:1px solid var(--border2);margin-bottom:6px;border-radius:2px;}
.sli-handle{color:var(--text3);cursor:grab;font-size:14px;}
.sli-name{flex:1;font-size:13px;}
.sli-actions{display:flex;gap:4px;}

/* ‚îÄ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ‚îÄ */
.toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%) translateY(80px);background:var(--surf2);border:1px solid var(--border2);border-left:3px solid var(--blue);padding:10px 18px;font-family:'JetBrains Mono',monospace;font-size:10px;z-index:9999;transition:transform .3s;max-width:90vw;box-shadow:0 8px 24px rgba(0,0,0,.5);border-radius:2px;}
.toast.on{transform:translateX(-50%) translateY(0);}

/* ‚îÄ‚îÄ‚îÄ PROFILE ROWS ‚îÄ‚îÄ‚îÄ */
.profile-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;}

/* ‚îÄ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ‚îÄ */
@media(max-width:720px){
  .ham{display:block;}
  .sidebar{position:fixed;top:52px;left:0;height:calc(100vh - 52px);z-index:300;transform:translateX(-100%);width:240px;}
  .sidebar.open{transform:translateX(0);}
  .sov.on{display:block;}
  .main{padding:12px;}
  .grid2{grid-template-columns:1fr;}
  .seam-grid{grid-template-columns:repeat(auto-fill,minmax(130px,1fr));}
  .tb-user{display:none;}
  .profile-grid{grid-template-columns:1fr;}
}
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     AUTH SCREEN
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="scr-auth">
  <div class="acard">
    <div class="logo-big">TQIMS</div>
    <div class="logo-sub">Quality Inspection Management System</div>

    <div class="atabs">
      <button class="atab on" id="tab-login" onclick="showTab('login')">LOGIN</button>
      <button class="atab" id="tab-reg" onclick="showTab('reg')">REGISTER</button>
    </div>

    <!-- LOGIN -->
    <div class="aform on" id="form-login">
      <div><label class="lbl">Mobile Number</label><input id="l-mob" type="tel" placeholder="e.g. 9876543210"></div>
      <div><label class="lbl">Password</label><input id="l-pw" type="password" placeholder="Your password"></div>
      <div id="l-err"></div>
      <button class="btn btn-blue btn-w" onclick="doLogin()">LOGIN ‚Üí</button>
      <div class="alink"><a onclick="showTab('reg')">Create new account</a> &nbsp;|&nbsp; <a onclick="showTab('admin-reg')" style="color:var(--text3);font-size:10px;">Admin registration</a></div>
    </div>

    <!-- REGISTER -->
    <div class="aform" id="form-reg">
      <div class="grid2">
        <div><label class="lbl">Full Name</label><input id="r-name" placeholder="Your full name"></div>
        <div><label class="lbl">Mobile</label><input id="r-mob" type="tel" placeholder="10-digit number"></div>
        <div><label class="lbl">Company / Contractor</label><input id="r-co" placeholder="Company name"></div>
        <div><label class="lbl">Designation</label><input id="r-desig" placeholder="e.g. QC Engineer"></div>
        <div class="span2"><label class="lbl">Email (optional)</label><input id="r-email" type="email" placeholder="email@example.com"></div>
        <div class="span2"><label class="lbl">Role</label>
          <div class="rchips">
            <div class="rchip" data-r="production" onclick="pickRole(this)">Production</div>
            <div class="rchip" data-r="quality" onclick="pickRole(this)">Quality Eng.</div>
            <div class="rchip" data-r="manager" onclick="pickRole(this)">Manager</div>
          </div>
        </div>
        <div class="span2"><label class="lbl">Project</label><select id="r-proj"></select></div>
        <div><label class="lbl">Password</label><input id="r-pw" type="password" placeholder="Min 6 characters"></div>
        <div><label class="lbl">Confirm Password</label><input id="r-pw2" type="password" placeholder="Repeat password"></div>
      </div>
      <div id="r-err"></div>
      <button class="btn btn-blue btn-w" onclick="doRegister()">CREATE ACCOUNT ‚Üí</button>
      <div class="alink"><a onclick="showTab('login')">‚Üê Back to login</a></div>
    </div>

    <!-- ADMIN REGISTER -->
    <div class="aform" id="form-admin-reg">
      <div class="msg msg-warn">üîê Admin registration requires a secret authorization key. Only authorized personnel can create admin accounts.</div>
      <div class="grid2">
        <div><label class="lbl">Full Name</label><input id="ar-name" placeholder="Your full name"></div>
        <div><label class="lbl">Mobile</label><input id="ar-mob" type="tel" placeholder="10-digit number"></div>
        <div><label class="lbl">Company</label><input id="ar-co" placeholder="Company name"></div>
        <div><label class="lbl">Designation</label><input id="ar-desig" placeholder="e.g. QA Manager"></div>
        <div class="span2"><label class="lbl">Project</label><select id="ar-proj"></select></div>
        <div><label class="lbl">Password</label><input id="ar-pw" type="password" placeholder="Min 6 characters"></div>
        <div><label class="lbl">Confirm Password</label><input id="ar-pw2" type="password" placeholder="Repeat password"></div>
        <div class="span2">
          <label class="lbl">üîë Admin Secret Key</label>
          <input id="ar-key" type="password" placeholder="Enter admin secret key">
          <div style="font-family:'JetBrains Mono',monospace;font-size:8px;color:var(--text3);margin-top:4px;">Default: TQIMS@Admin2024 (change after first login)</div>
        </div>
      </div>
      <div id="ar-err"></div>
      <button class="btn btn-amber btn-w" onclick="doAdminReg()">CREATE ADMIN ACCOUNT ‚Üí</button>
      <div class="alink"><a onclick="showTab('login')">‚Üê Back to login</a></div>
    </div>

    <div class="credit">¬© TQIMS ¬∑ Designed by Ujval Dharawaparmar</div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     APP SCREEN
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="scr-app">
  <!-- TOPBAR -->
  <div class="topbar">
    <div class="tb-left">
      <button class="ham" onclick="toggleSidebar()">‚ò∞</button>
      <div class="tb-logo">TQIMS</div>
    </div>
    <div class="tb-right">
      <span class="rpill" id="hdr-role"></span>
      <span class="tb-user" id="hdr-name"></span>
      <button class="tb-logout" onclick="doLogout()">LOGOUT</button>
    </div>
  </div>

  <div class="app-body">
    <div class="sov" id="sov" onclick="closeSidebar()"></div>

    <!-- SIDEBAR -->
    <div class="sidebar" id="sidebar">
      <div>
        <div class="sg-lbl">Navigation</div>
        <div class="nitem on" id="ni-dashboard" onclick="goPage('dashboard')"><span class="ni">üìä</span>Dashboard</div>
        <div class="nitem" id="ni-inspection" onclick="goPage('inspection')"><span class="ni">üî¨</span>Inspection<span class="nbadge" id="nb" style="display:none">0</span></div>
        <div class="nitem" id="ni-log" onclick="goPage('log')"><span class="ni">üìã</span>Activity Log</div>
      </div>
      <div id="admin-nav" style="display:none">
        <div class="sg-lbl">Admin</div>
        <div class="nitem" id="ni-projects" onclick="goPage('projects')"><span class="ni">üóÇÔ∏è</span>Projects & Seams</div>
        <div class="nitem" id="ni-stages" onclick="goPage('stages')"><span class="ni">üîß</span>Stage Templates</div>
        <div class="nitem" id="ni-users" onclick="goPage('users')"><span class="ni">üë•</span>Users</div>
      </div>
      <div id="manager-nav" style="display:none">
        <div class="sg-lbl">Manager</div>
        <div class="nitem" id="ni-approvals" onclick="goPage('approvals')"><span class="ni">‚úÖ</span>Approvals<span class="nbadge" id="nb-approvals" style="display:none">0</span></div>
      </div>
      <div>
        <div class="sg-lbl">Reports</div>
        <div class="nitem" id="ni-summary" onclick="goPage('summary')"><span class="ni">üìÑ</span>Print Summary</div>
        <div class="sg-lbl">Account</div>
        <div class="nitem" id="ni-profile" onclick="goPage('profile')"><span class="ni">üë§</span>My Profile</div>
      </div>
      <div class="credit" style="padding:12px 16px;margin-top:8px;">Designed by<br>Ujval Dharawaparmar</div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="main">

      <!-- ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ -->
      <div class="pg on" id="pg-dashboard">
        <div class="pgh"><div class="pgt">Dashboard</div><div class="pgs" id="dash-sub">// Project Overview</div></div>
        <div class="projbar" id="projbar"></div>
        <div class="sgrid" id="stat-grid"></div>
        <div id="dash-sections"></div>
      </div>

      <!-- ‚îÄ‚îÄ SEAM DETAIL (from dashboard click) ‚îÄ‚îÄ -->
      <div class="pg" id="pg-seam">
        <div class="back-btn" onclick="goPage('dashboard')">‚Üê Back to Dashboard</div>
        <div class="pgh"><div class="pgt" id="seam-detail-title">Seam Detail</div><div class="pgs" id="seam-detail-sub"></div></div>
        <div id="seam-detail-content"></div>
      </div>

      <!-- ‚îÄ‚îÄ INSPECTION ‚îÄ‚îÄ -->
      <div class="pg" id="pg-inspection">
        <div class="pgh"><div class="pgt">Inspection Stages</div><div class="pgs">// Select section then offer or inspect stages</div></div>
        <div class="stabs" id="insp-tabs"></div>
        <div id="insp-seams"></div>
      </div>

      <!-- ‚îÄ‚îÄ ADMIN: PROJECTS & SEAMS ‚îÄ‚îÄ -->
      <div class="pg" id="pg-projects">
        <div class="pgh"><div class="pgt">Projects & Seams</div><div class="pgs">// All changes require Manager approval before taking effect</div></div>
        <div style="background:rgba(210,153,34,.08);border:1px solid rgba(210,153,34,.2);padding:10px 14px;margin-bottom:14px;font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--amber);border-radius:2px;">
          ‚ö†Ô∏è All add / edit / delete actions are sent to the Manager for approval. Changes will not apply until approved.
        </div>

        <div class="card">
          <div class="chead">
            <div class="ctitle">Projects</div>
            <button class="abtn ab-blue" onclick="openModal('m-add-proj')">+ ADD PROJECT</button>
          </div>
          <div id="proj-list"></div>
        </div>

        <div class="card">
          <div class="chead"><div class="ctitle">Add Seam / Joint</div></div>
          <div class="grid2">
            <div><label class="lbl">Project</label><select id="ns-proj" onchange="refreshNsSections()"></select></div>
            <div><label class="lbl">Section</label><select id="ns-sec"></select></div>
            <div><label class="lbl">Seam / Joint Number</label><input id="ns-num" placeholder="Circ. Seam No: 101"></div>
            <div><label class="lbl">Description</label><input id="ns-desc" placeholder="Nozzle Neck fit-up with Flange"></div>
            <div><label class="lbl">Joint Type</label>
              <select id="ns-type"><option>Butt Joint</option><option>Fillet Joint</option><option>Nozzle Weld</option><option>Corner Joint</option><option>T-Joint</option><option>Lap Joint</option></select>
            </div>
            <div><label class="lbl">Material</label><input id="ns-mat" placeholder="SA516 Gr.70"></div>
            <div><label class="lbl">Thickness (mm)</label><input id="ns-thk" placeholder="20"></div>
            <div><label class="lbl">WPS No.</label><input id="ns-wps" placeholder="WPS-001"></div>
            <div><label class="lbl">Stage Template</label><select id="ns-tmpl"></select></div>
            <div class="span2" style="display:flex;gap:8px;justify-content:flex-end;margin-top:4px;">
              <button class="abtn ab-blue" style="padding:8px 20px;font-size:11px;" onclick="addSeam()">+ ADD SEAM</button>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="chead">
            <div class="ctitle">All Seams</div>
            <select id="fp" onchange="renderAdminSeams()" style="padding:5px 8px;font-size:11px;background:var(--surf2);border:1px solid var(--border2);color:var(--text);border-radius:2px;"></select>
          </div>
          <div class="tbl-wrap">
            <table><thead><tr><th>Section</th><th>Seam #</th><th>Description</th><th>Type</th><th>Material</th><th>THK</th><th>WPS</th><th>Stages</th><th>Progress</th><th>Actions</th></tr></thead>
            <tbody id="seam-tbody"></tbody></table>
          </div>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ ADMIN: STAGE TEMPLATES ‚îÄ‚îÄ -->
      <div class="pg" id="pg-stages">
        <div class="pgh"><div class="pgt">Stage Templates</div><div class="pgs">// Define, edit, add or remove inspection stages ‚Äî apply to seams</div></div>

        <div class="card">
          <div class="chead">
            <div class="ctitle">Templates</div>
            <button class="abtn ab-blue" onclick="addTemplate()">+ NEW TEMPLATE</button>
          </div>
          <div id="tmpl-list"></div>
        </div>

        <div class="card" id="stage-editor-card" style="display:none;">
          <div class="chead">
            <div class="ctitle" id="stage-editor-title">Edit Stages</div>
            <div style="display:flex;gap:6px;">
              <button class="abtn ab-green" onclick="addStageLine()">+ ADD STAGE</button>
              <button class="abtn ab-ghost" onclick="closeStageEditor()">CLOSE</button>
            </div>
          </div>
          <div id="stage-lines"></div>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ ADMIN: USERS ‚îÄ‚îÄ -->
      <div class="pg" id="pg-users">
        <div class="pgh"><div class="pgt">Users</div><div class="pgs">// Manage registered accounts and approvals</div></div>
        <div class="card">
          <div class="chead">
            <div class="ctitle">All Users</div>
            <button class="abtn ab-blue" onclick="openModal('m-add-user')">+ ADD USER</button>
          </div>
          <div class="tbl-wrap">
            <table><thead><tr><th>Name</th><th>Mobile</th><th>Company</th><th>Designation</th><th>Role</th><th>Project</th><th>Status</th><th>Actions</th></tr></thead>
            <tbody id="user-tbody"></tbody></table>
          </div>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ LOG ‚îÄ‚îÄ -->
      <div class="pg" id="pg-log">
        <div class="pgh"><div class="pgt">Activity Log</div><div class="pgs">// Full inspection history and audit trail</div></div>
        <div class="card"><div id="log-body"></div></div>
      </div>

      <!-- ‚îÄ‚îÄ SUMMARY ‚îÄ‚îÄ -->
      <div class="pg" id="pg-summary">
        <div class="pgh"><div class="pgt">Print Summary</div><div class="pgs">// Generate A4 inspection report with signature blocks</div></div>
        <div class="card">
          <div class="grid2" style="max-width:480px;">
            <div><label class="lbl">Project</label><select id="print-proj" onchange="refreshPrintSecs()"></select></div>
            <div><label class="lbl">Section Filter</label><select id="print-sec"><option value="">All Sections</option></select></div>
            <div class="span2">
              <button class="btn btn-blue" style="width:auto;padding:10px 24px;" onclick="doPrint()">üñ®Ô∏è PRINT / SAVE AS PDF</button>
            </div>
          </div>
        </div>
        <div class="card" id="print-preview"></div>
      </div>

      <!-- ‚îÄ‚îÄ PROFILE ‚îÄ‚îÄ -->
      <div class="pg" id="pg-profile">
        <div class="pgh"><div class="pgt">My Profile</div><div class="pgs">// Account details and password management</div></div>
        <div style="max-width:520px;">
          <div class="card">
            <div class="chead"><div class="ctitle">Account Details</div></div>
            <div id="profile-rows"></div>
          </div>
          <div class="card">
            <div class="chead"><div class="ctitle">Change Password</div></div>
            <div class="fl" style="max-width:360px;gap:12px;display:flex;flex-direction:column;">
              <div><label class="lbl">Current Password</label><input id="cp-cur" type="password" placeholder="Enter current password"></div>
              <div><label class="lbl">New Password</label><input id="cp-new" type="password" placeholder="Min 6 characters"></div>
              <div><label class="lbl">Confirm New Password</label><input id="cp-cnf" type="password" placeholder="Repeat new password"></div>
              <div id="cp-msg"></div>
              <button class="btn btn-blue" style="width:auto;padding:10px 22px;" onclick="changePassword()">UPDATE PASSWORD ‚Üí</button>
            </div>
          </div>
          <div class="card" id="secret-key-card" style="display:none;">
            <div class="chead"><div class="ctitle">üîë Admin Secret Key</div></div>
            <div style="font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--text3);margin-bottom:12px;">Required for new admin registrations. Keep confidential.</div>
            <div class="fl" style="max-width:360px;gap:12px;display:flex;flex-direction:column;">
              <div><label class="lbl">Current Key</label><input id="sk-cur" type="password" placeholder="Current secret key"></div>
              <div><label class="lbl">New Key (min 8 chars)</label><input id="sk-new" type="password" placeholder="New secret key"></div>
              <div><label class="lbl">Confirm New Key</label><input id="sk-cnf" type="password" placeholder="Repeat new key"></div>
              <div id="sk-msg"></div>
              <button class="btn btn-amber" style="width:auto;padding:10px 22px;" onclick="changeSecretKey()">UPDATE SECRET KEY ‚Üí</button>
            </div>
          </div>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ APPROVALS (Manager) ‚îÄ‚îÄ -->
      <div class="pg" id="pg-approvals">
        <div class="pgh"><div class="pgt">Pending Approvals</div><div class="pgs">// Review and approve or reject Admin requests</div></div>
        <div class="card" id="approvals-body"></div>
      </div>

    </div><!-- /main -->
  </div><!-- /app-body -->
</div><!-- /scr-app -->

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MODALS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

<!-- Offer Modal -->
<div class="mbg" id="m-offer">
  <div class="modal">
    <div class="mhead"><div class="mtitle">üì§ Offer for Inspection</div><button class="mclose" onclick="closeModal('m-offer')">‚úï</button></div>
    <div class="mbody">
      <div id="offer-info"></div>
      <div class="grid2" style="margin-top:14px;">
        <div><label class="lbl">Location / Position</label><input id="of-loc" placeholder="Bay-3, Grid B-4, Bottom NW"></div>
        <div><label class="lbl">Drawing / Ref. No.</label><input id="of-drw" placeholder="DRG-1242-001"></div>
        <div class="span2"><label class="lbl">Production Remarks</label><textarea id="of-rem" placeholder="e.g. Pre-heat done, joint cleaned..."></textarea></div>
      </div>
    </div>
    <div class="mfoot">
      <button class="btn btn-ghost" style="width:auto;padding:9px 16px;" onclick="closeModal('m-offer')">Cancel</button>
      <button class="btn btn-blue" style="width:auto;padding:9px 16px;" onclick="confirmOffer()">OFFER STAGE ‚Üë</button>
    </div>
  </div>
</div>

<!-- Inspect Modal -->
<div class="mbg" id="m-inspect">
  <div class="modal">
    <div class="mhead"><div class="mtitle">üîç Quality Inspection</div><button class="mclose" onclick="closeModal('m-inspect')">‚úï</button></div>
    <div class="mbody">
      <div id="inspect-info"></div>
      <div style="margin-top:14px;">
        <label class="lbl">Quality Remarks / NCR Number / Hold</label>
        <textarea id="ins-rem" placeholder="Enter remarks, NCR number, or HOLD reason (optional)..."></textarea>
      </div>
    </div>
    <div class="mfoot">
      <button class="btn btn-ghost" style="width:auto;padding:9px 16px;" onclick="closeModal('m-inspect')">Cancel</button>
      <button class="btn btn-red" style="width:auto;padding:9px 16px;" onclick="submitInspect('rejected')">‚úó REJECT</button>
      <button class="btn btn-green" style="width:auto;padding:9px 16px;" onclick="submitInspect('accepted')">‚úì ACCEPT</button>
    </div>
  </div>
</div>

<!-- Add Project Modal -->
<div class="mbg" id="m-add-proj">
  <div class="modal">
    <div class="mhead"><div class="mtitle">+ New Project</div><button class="mclose" onclick="closeModal('m-add-proj')">‚úï</button></div>
    <div class="mbody">
      <div class="grid2">
        <div><label class="lbl">Project Number</label><input id="np-num" placeholder="1242"></div>
        <div><label class="lbl">Equipment Name</label><input id="np-eq" placeholder="Heat Exchanger"></div>
        <div><label class="lbl">Client</label><input id="np-cl" placeholder="IOCL"></div>
        <div><label class="lbl">Process</label><input id="np-pr" placeholder="Fabrication"></div>
        <div class="span2"><label class="lbl">Sections (comma separated)</label><input id="np-secs" placeholder="Pre-Fabrication, Head Assembly, Shell Side, Channel Side, Tube Bundle Assembly"></div>
        <div class="span2"><label class="lbl">Code / Standard</label><input id="np-code" placeholder="ASME Sec VIII Div.1"></div>
      </div>
    </div>
    <div class="mfoot">
      <button class="btn btn-ghost" style="width:auto;padding:9px 16px;" onclick="closeModal('m-add-proj')">Cancel</button>
      <button class="btn btn-blue" style="width:auto;padding:9px 16px;" onclick="confirmAddProj()">CREATE PROJECT</button>
    </div>
  </div>
</div>

<!-- Edit Seam Modal -->
<div class="mbg" id="m-edit-seam">
  <div class="modal">
    <div class="mhead"><div class="mtitle">‚úèÔ∏è Edit Seam</div><button class="mclose" onclick="closeModal('m-edit-seam')">‚úï</button></div>
    <div class="mbody">
      <input type="hidden" id="es-id">
      <div class="grid2">
        <div><label class="lbl">Section</label><select id="es-sec"></select></div>
        <div><label class="lbl">Seam Number</label><input id="es-num"></div>
        <div class="span2"><label class="lbl">Description</label><input id="es-desc"></div>
        <div><label class="lbl">Joint Type</label><select id="es-type"><option>Butt Joint</option><option>Fillet Joint</option><option>Nozzle Weld</option><option>Corner Joint</option><option>T-Joint</option><option>Lap Joint</option></select></div>
        <div><label class="lbl">Material</label><input id="es-mat"></div>
        <div><label class="lbl">Thickness (mm)</label><input id="es-thk"></div>
        <div><label class="lbl">WPS No.</label><input id="es-wps"></div>
      </div>
    </div>
    <div class="mfoot">
      <button class="btn btn-ghost" style="width:auto;padding:9px 16px;" onclick="closeModal('m-edit-seam')">Cancel</button>
      <button class="btn btn-blue" style="width:auto;padding:9px 16px;" onclick="saveSeamEdit()">SAVE CHANGES</button>
    </div>
  </div>
</div>

<!-- Add User Modal -->
<div class="mbg" id="m-add-user">
  <div class="modal">
    <div class="mhead"><div class="mtitle">+ Add User</div><button class="mclose" onclick="closeModal('m-add-user')">‚úï</button></div>
    <div class="mbody">
      <div class="grid2">
        <div><label class="lbl">Full Name</label><input id="au-name" placeholder="Full name"></div>
        <div><label class="lbl">Mobile</label><input id="au-mob" type="tel" placeholder="Mobile number"></div>
        <div><label class="lbl">Company</label><input id="au-co" placeholder="Company name"></div>
        <div><label class="lbl">Designation</label><input id="au-desig" placeholder="e.g. QC Engineer"></div>
        <div><label class="lbl">Role</label>
          <select id="au-role"><option value="production">Production</option><option value="quality">Quality Engineer</option><option value="manager">Manager</option><option value="admin">Admin</option></select>
        </div>
        <div><label class="lbl">Project</label><select id="au-proj"></select></div>
        <div class="span2"><label class="lbl">Password</label><input id="au-pw" type="password" placeholder="Set password"></div>
      </div>
    </div>
    <div class="mfoot">
      <button class="btn btn-ghost" style="width:auto;padding:9px 16px;" onclick="closeModal('m-add-user')">Cancel</button>
      <button class="btn btn-blue" style="width:auto;padding:9px 16px;" onclick="adminAddUser()">CREATE USER</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DATABASE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const DEFAULT_STAGES = ['WEP PT/MT','Fit-up Inspection','Root Run / Back Chip PT/MT','Complete Weld Dimension Inspection','Complete Weld PT/MT','Hardness Test','RT (Radiographic Test)','UT (Ultrasonic Test)'];

function mkStages(names) {
  return (names||DEFAULT_STAGES).map(n=>({name:n,status:'pending',offeredBy:'',offeredByMob:'',offeredByCo:'',offeredAt:'',location:'',drawing:'',prodRem:'',inspectedBy:'',inspectedAt:'',qeRem:''}));
}

function defaultDB() {
  return {
    projects:[{id:'p1',number:'1242',equipment:'Heat Exchanger',client:'IOCL',process:'Fabrication',code:'ASME Sec VIII Div.1',sections:['Pre-Fabrication','Head Assembly','Shell Side','Channel Side','Tube Bundle Assembly']}],
    seams:[
      {id:'s1',pid:'p1',sec:'Pre-Fabrication',num:'Circ. Seam No: 101',desc:'Nozzle Neck fit-up with Flange',type:'Butt Joint',mat:'SA516 Gr.70',thk:'20',wps:'WPS-001',stages:mkStages()},
      {id:'s2',pid:'p1',sec:'Pre-Fabrication',num:'Circ. Seam No: 102',desc:'Shell Plate to End Plate',type:'Butt Joint',mat:'SA516 Gr.70',thk:'25',wps:'WPS-001',stages:mkStages()},
      {id:'s3',pid:'p1',sec:'Head Assembly',num:'Circ. Seam No: 201',desc:'Ellipsoidal Head to Shell',type:'Butt Joint',mat:'SA516 Gr.70',thk:'22',wps:'WPS-002',stages:mkStages()},
      {id:'s4',pid:'p1',sec:'Shell Side',num:'Circ. Seam No: 301',desc:'Shell Longitudinal Seam',type:'Butt Joint',mat:'SA516 Gr.70',thk:'18',wps:'WPS-001',stages:mkStages()},
      {id:'s5',pid:'p1',sec:'Channel Side',num:'Circ. Seam No: 401',desc:'Channel Cover to Flange',type:'Butt Joint',mat:'SA516 Gr.70',thk:'30',wps:'WPS-003',stages:mkStages()},
      {id:'s6',pid:'p1',sec:'Tube Bundle Assembly',num:'Circ. Seam No: 501',desc:'Tube to Tubesheet Welding',type:'Fillet Joint',mat:'SA179',thk:'3',wps:'WPS-004',stages:mkStages()}
    ],
    users:[{id:'u0',name:'Admin User',mob:'0000000000',email:'',co:'TQIMS',desig:'System Admin',role:'admin',pid:'p1',pw:'admin123',approved:true}],
    templates:[{id:'t1',name:'Standard Weld Inspection',stages:DEFAULT_STAGES.slice()}],
    log:[],
    pendingActions:[],
    secretKey:'TQIMS@Admin2024'
  };
}

let DB = (()=>{try{const d=localStorage.getItem('tqims3');if(d){const p=JSON.parse(d);if(!p.templates)p.templates=[{id:'t1',name:'Standard Weld Inspection',stages:DEFAULT_STAGES.slice()}];if(!p.secretKey)p.secretKey='TQIMS@Admin2024';if(!p.pendingActions)p.pendingActions=[];return p;}}catch(e){}return defaultDB();})();
function save(){try{localStorage.setItem('tqims3',JSON.stringify(DB));}catch(e){}}

let CU = null; // current user
let activeSeamId = null; // for seam detail view
let inspTarget = null;
let offerTarget = null;
let editTmplId = null;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const $ = id => document.getElementById(id);
const now = () => new Date().toLocaleString('en-IN',{day:'2-digit',month:'short',year:'2-digit',hour:'2-digit',minute:'2-digit',hour12:false});
function log(msg){DB.log.unshift({t:now(),user:CU?CU.name:'System',role:CU?CU.role:'system',co:CU?CU.co:'',msg});save();}
function getProj(id){return DB.projects.find(p=>p.id===id);}
function getSeam(id){return DB.seams.find(s=>s.id===id);}
function getSections(pid){const p=getProj(pid);return p?p.sections:[];}
function getSeams(pid,sec){return DB.seams.filter(s=>s.pid===pid&&(!sec||s.sec===sec));}
function stageStats(seam){const t=seam.stages.length,a=seam.stages.filter(s=>s.status==='accepted').length,o=seam.stages.filter(s=>s.status==='offered').length,r=seam.stages.filter(s=>s.status==='rejected').length;return{t,a,o,r,pct:t?Math.round(a/t*100):0};}
function hasNCR(seam){return seam.stages.some(s=>s.qeRem&&s.qeRem.toLowerCase().includes('ncr'));}
function overallStats(pid){let t=0,a=0,o=0,r=0;getSeams(pid).forEach(s=>s.stages.forEach(st=>{t++;if(st.status==='accepted')a++;else if(st.status==='offered')o++;else if(st.status==='rejected')r++;}));return{t,a,o,r,p:t?Math.round(a/t*100):0,seams:getSeams(pid).length};}
function updateBadge(){const seams=getSeams(CU?CU.pid:'');let o=0;seams.forEach(s=>s.stages.forEach(st=>{if(st.status==='offered')o++;}));const nb=$('nb');if(nb){nb.style.display=o>0?'inline':'none';nb.textContent=o;}}
function empty(t){return`<div style="text-align:center;padding:36px;font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text3);">${t}</div>`;}

function toast(msg,type){
  const el=$('toast');
  el.textContent=msg;
  el.style.borderLeftColor=type==='err'?'var(--red)':type==='ok'?'var(--green)':'var(--blue)';
  el.classList.add('on');
  setTimeout(()=>el.classList.remove('on'),3000);
}

function openModal(id){$(id).classList.add('on');}
function closeModal(id){$(id).classList.remove('on');}
document.querySelectorAll('.mbg').forEach(b=>b.addEventListener('click',e=>{if(e.target===b)b.classList.remove('on');}));
document.addEventListener('keydown',e=>{if(e.key==='Escape')document.querySelectorAll('.mbg.on').forEach(m=>m.classList.remove('on'));});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUTH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showTab(t){
  ['login','reg','admin-reg'].forEach(id=>{
    $('tab-'+id)&&$('tab-'+id).classList.toggle('on',id===t);
    $('form-'+id).classList.toggle('on',id===t);
  });
  // populate project dropdowns
  const opts=DB.projects.map(p=>`<option value="${p.id}">Project #${p.number} ‚Äî ${p.equipment}</option>`).join('');
  ['r-proj','ar-proj'].forEach(id=>{const el=$(id);if(el)el.innerHTML=opts;});
}

function pickRole(el){document.querySelectorAll('.rchip').forEach(c=>c.classList.remove('on'));el.classList.add('on');}

function doLogin(){
  const mob=$('l-mob').value.trim();
  const pw=$('l-pw').value;
  const u=DB.users.find(u=>u.mob===mob&&u.pw===pw);
  if(!u){$('l-err').innerHTML='<div class="msg msg-err">Invalid mobile or password.</div>';return;}
  if(!u.approved){$('l-err').innerHTML='<div class="msg msg-err">Account pending admin approval.</div>';return;}
  loginAs(u);
}

function doRegister(){
  const name=$('r-name').value.trim();
  const mob=$('r-mob').value.trim();
  const co=$('r-co').value.trim();
  const desig=$('r-desig').value.trim();
  const email=$('r-email').value.trim();
  const pw=$('r-pw').value;
  const pw2=$('r-pw2').value;
  const pid=$('r-proj').value;
  const roleEl=document.querySelector('.rchip.on');
  const role=roleEl?roleEl.dataset.r:'';
  const err=$('r-err');
  if(!name||!mob||!co||!pw||!pid||!role){err.innerHTML='<div class="msg msg-err">Please fill all required fields and select a role.</div>';return;}
  if(pw!==pw2){err.innerHTML='<div class="msg msg-err">Passwords do not match.</div>';return;}
  if(pw.length<6){err.innerHTML='<div class="msg msg-err">Password must be at least 6 characters.</div>';return;}
  if(DB.users.find(u=>u.mob===mob)){err.innerHTML='<div class="msg msg-err">Mobile number already registered.</div>';return;}
  DB.users.push({id:'u'+Date.now(),name,mob,email,co,desig,role,pid,pw,approved:false});
  save();
  err.innerHTML='<div class="msg msg-ok">‚úì Account created! Awaiting admin approval.</div>';
  toast('Registration submitted');
}

function doAdminReg(){
  const name=$('ar-name').value.trim();
  const mob=$('ar-mob').value.trim();
  const co=$('ar-co').value.trim();
  const desig=$('ar-desig').value.trim();
  const pid=$('ar-proj').value;
  const pw=$('ar-pw').value;
  const pw2=$('ar-pw2').value;
  const key=$('ar-key').value;
  const err=$('ar-err');
  if(!name||!mob||!pw||!pid||!key){err.innerHTML='<div class="msg msg-err">Please fill all required fields.</div>';return;}
  if(key!==DB.secretKey){err.innerHTML='<div class="msg msg-err">‚ùå Invalid admin secret key. Access denied.</div>';$('ar-key').value='';return;}
  if(pw!==pw2){err.innerHTML='<div class="msg msg-err">Passwords do not match.</div>';return;}
  if(pw.length<6){err.innerHTML='<div class="msg msg-err">Password must be at least 6 characters.</div>';return;}
  if(DB.users.find(u=>u.mob===mob)){err.innerHTML='<div class="msg msg-err">Mobile already registered.</div>';return;}
  DB.users.push({id:'u'+Date.now(),name,mob,email:'',co:co||'TQIMS',desig:desig||'Admin',role:'admin',pid,pw,approved:true});
  save();
  err.innerHTML='<div class="msg msg-ok">‚úì Admin account created! You can now login.</div>';
  $('ar-pw').value='';$('ar-pw2').value='';$('ar-key').value='';
  setTimeout(()=>showTab('login'),2000);
}

function loginAs(u){
  CU=u;
  $('scr-auth').classList.remove('on');
  $('scr-app').classList.add('on');
  $('hdr-role').className='rpill rp-'+u.role;
  $('hdr-role').textContent=u.role.toUpperCase();
  $('hdr-name').textContent=u.name;
  $('admin-nav').style.display=u.role==='admin'?'block':'none';
  $('manager-nav').style.display=u.role==='manager'?'block':'none';
  populateSelects();
  updateApprovalBadge();
  goPage('dashboard');
}

function doLogout(){
  CU=null;
  $('scr-app').classList.remove('on');
  $('scr-auth').classList.add('on');
  $('l-mob').value='';$('l-pw').value='';$('l-err').innerHTML='';
  $('hdr-role').className='rpill';
  $('admin-nav').style.display='none';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function goPage(pg){
  document.querySelectorAll('.pg').forEach(p=>p.classList.remove('on'));
  document.querySelectorAll('.nitem').forEach(n=>n.classList.remove('on'));
  $('pg-'+pg).classList.add('on');
  const ni=$('ni-'+pg);if(ni)ni.classList.add('on');
  closeSidebar();
  if(pg==='dashboard')renderDashboard();
  else if(pg==='inspection'){renderInspection();updateBadge();}
  else if(pg==='log')renderLog();
  else if(pg==='projects')renderProjectsPage();
  else if(pg==='stages')renderStagesPage();
  else if(pg==='users')renderUsers();
  else if(pg==='summary')renderSummaryPage();
  else if(pg==='profile')renderProfile();
  else if(pg==='approvals')renderApprovals();
}

function toggleSidebar(){$('sidebar').classList.toggle('open');$('sov').classList.toggle('on');}
function closeSidebar(){$('sidebar').classList.remove('open');$('sov').classList.remove('on');}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// POPULATE SELECTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function populateSelects(){
  const opts=DB.projects.map(p=>`<option value="${p.id}">Project #${p.number} ‚Äî ${p.equipment}</option>`).join('');
  ['fp','print-proj','au-proj'].forEach(id=>{const el=$(id);if(el)el.innerHTML=opts;});
  refreshNsSections();
  refreshPrintSecs();
  refreshTmplSelect();
}

function refreshNsSections(){
  const pid=$('ns-proj')&&$('ns-proj').value;
  const secs=getSections(pid);
  const el=$('ns-sec');if(el)el.innerHTML=secs.map(s=>`<option>${s}</option>`).join('');
}

function refreshPrintSecs(){
  const pid=$('print-proj')&&$('print-proj').value||DB.projects[0]&&DB.projects[0].id;
  const secs=getSections(pid);
  const el=$('print-sec');if(el)el.innerHTML='<option value="">All Sections</option>'+secs.map(s=>`<option>${s}</option>`).join('');
}

function refreshTmplSelect(){
  const el=$('ns-tmpl');if(!el)return;
  el.innerHTML=DB.templates.map(t=>`<option value="${t.id}">${t.name}</option>`).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DASHBOARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderDashboard(){
  if(!CU)return;
  const pid=CU.pid;
  const p=getProj(pid);
  if(!p){$('dash-sections').innerHTML=empty('No project assigned. Contact admin.');return;}

  $('dash-sub').textContent=`// Project #${p.number} ‚Äî ${p.equipment}`;
  $('projbar').innerHTML=`
    <div><div class="pf-lbl">Project No.</div><div class="pf-val">${p.number}</div></div>
    <div><div class="pf-lbl">Equipment</div><div class="pf-val">${p.equipment}</div></div>
    <div><div class="pf-lbl">Client</div><div class="pf-val">${p.client||'‚Äî'}</div></div>
    <div><div class="pf-lbl">Process</div><div class="pf-val">${p.process||'‚Äî'}</div></div>
    <div><div class="pf-lbl">Code</div><div class="pf-val">${p.code||'‚Äî'}</div></div>
  `;

  const st=overallStats(pid);
  $('stat-grid').innerHTML=`
    <div class="sbox sb-blue"><div class="snum" style="color:var(--blue2)">${st.seams}</div><div class="slbl">Total Seams</div></div>
    <div class="sbox sb-green"><div class="snum" style="color:var(--green)">${st.a}</div><div class="slbl">Accepted</div></div>
    <div class="sbox sb-amber"><div class="snum" style="color:var(--amber)">${st.o}</div><div class="slbl">Awaiting QC</div></div>
    <div class="sbox sb-red"><div class="snum" style="color:var(--red)">${st.r}</div><div class="slbl">Rejected</div></div>
    <div class="sbox sb-green"><div class="snum" style="color:var(--cyan)">${st.p}%</div><div class="slbl">Completion</div></div>
  `;

  // Seam tiles per section
  const sections=getSections(pid);
  let html='';
  sections.forEach(sec=>{
    const seams=getSeams(pid,sec);
    if(!seams.length)return;
    const secTotal=seams.reduce((a,s)=>a+s.stages.length,0);
    const secDone=seams.reduce((a,s)=>a+s.stages.filter(st=>st.status==='accepted').length,0);
    const secPct=secTotal?Math.round(secDone/secTotal*100):0;
    html+=`<div class="dash-section">
      <div class="dash-sec-title">
        <span>${sec}</span>
        <span style="font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text3);">${secDone}/${secTotal} stages ¬∑ ${secPct}%</span>
      </div>
      <div class="seam-grid">`;
    seams.forEach(seam=>{
      const ss=stageStats(seam);
      const ncr=hasNCR(seam);
      const hasOff=seam.stages.some(s=>s.status==='offered');
      const hasRej=seam.stages.some(s=>s.status==='rejected');
      const tileClass=ss.pct===100?'st-done':hasOff?'st-active':hasRej?'st-rejected':'st-pending';
      html+=`<div class="seam-tile ${tileClass}" onclick="openSeamDetail('${seam.id}')">
        ${ncr?'<div class="ncr-dot" title="NCR Raised"></div>':''}
        <div class="st-seam-num">${seam.num}</div>
        <div class="st-seam-desc" title="${seam.desc}">${seam.desc}</div>
        <div class="st-seam-pct">${ss.pct}%</div>
        <div class="st-seam-meta">${ss.a}/${ss.t} stages</div>
        <div class="pbar" style="margin-top:5px;"><div class="pfill" style="width:${ss.pct}%"></div></div>
        ${hasOff?'<div style="font-family:\'JetBrains Mono\',monospace;font-size:8px;color:var(--amber);margin-top:4px;">‚óè AWAITING QC</div>':''}
      </div>`;
    });
    html+='</div></div>';
  });
  $('dash-sections').innerHTML=html||empty('No seams added yet. Admin can add from Projects & Seams.');
  updateBadge();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SEAM DETAIL VIEW (click from dashboard)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openSeamDetail(seamId){
  activeSeamId=seamId;
  const seam=getSeam(seamId);
  $('seam-detail-title').textContent=seam.num;
  $('seam-detail-sub').textContent=`// ${seam.sec} ¬∑ ${seam.desc} ¬∑ ${seam.type} ¬∑ ${seam.mat} ¬∑ ${seam.thk}mm ¬∑ WPS: ${seam.wps||'‚Äî'}`;
  renderSeamDetailContent(seamId);
  goPage('seam');
  $('ni-dashboard').classList.add('on');
}

function renderSeamDetailContent(seamId){
  const seam=getSeam(seamId);
  $('seam-detail-content').innerHTML=renderSeamCard(seam,true);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INSPECTION PAGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let activeSec=null;
function renderInspection(){
  if(!CU)return;
  const pid=CU.pid;
  const secs=getSections(pid);
  if(!activeSec||!secs.includes(activeSec))activeSec=secs[0]||null;
  // Role hint
  const hint = CU.role==='production' ? '// You can offer stages for inspection'
    : CU.role==='quality' ? '// You can accept or reject offered stages'
    : '// View-only ‚Äî inspection actions are role-restricted';
  document.querySelector('#pg-inspection .pgs').textContent=hint;
  $('insp-tabs').innerHTML=secs.map(s=>`<div class="stab ${s===activeSec?'on':''}" onclick="switchSec('${s}')">${s}</div>`).join('');
  renderInspSeams();
}
function switchSec(s){activeSec=s;renderInspection();}
function renderInspSeams(){
  const seams=getSeams(CU.pid,activeSec);
  $('insp-seams').innerHTML=seams.length?seams.map(s=>renderSeamCard(s,false)).join(''):empty('No seams in this section.');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SEAM CARD RENDERER (shared by inspection page and seam detail)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderSeamCard(seam,standalone){
  const ss=stageStats(seam);
  const ncr=hasNCR(seam);
  let html=`<div class="seam-detail-card">
    <div class="sdh">
      <div>
        <div class="sd-num">${seam.num}${ncr?' <span class="chip ch-rej" style="font-size:8px;">NCR</span>':''}</div>
        <div class="sd-desc">${seam.desc}</div>
        <div class="sd-meta">${seam.type} ¬∑ ${seam.mat} ¬∑ ${seam.thk}mm ¬∑ WPS: ${seam.wps||'‚Äî'}</div>
      </div>
      <div style="text-align:right;">
        <div style="font-family:'Barlow Condensed',sans-serif;font-size:22px;font-weight:800;color:var(--cyan);">${ss.pct}%</div>
        <div style="font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--text3);">${ss.a}/${ss.t} stages</div>
        <div class="pbar" style="width:100px;margin-top:4px;"><div class="pfill" style="width:${ss.pct}%"></div></div>
      </div>
    </div>`;

  seam.stages.forEach((st,i)=>{
    const prev=i===0||seam.stages[i-1].status==='accepted';
    const locked=!prev&&st.status==='pending';
    // STRICT ROLE PERMISSIONS
    const canOffer = CU.role==='production';           // ONLY production can offer
    const canInspect = CU.role==='quality';            // ONLY quality can inspect/accept/reject

    let chip='',action='';
    if(locked)chip='<span class="chip ch-lock">üîí LOCKED</span>';
    else if(st.status==='pending')chip='<span class="chip ch-pend">‚óã PENDING</span>';
    else if(st.status==='offered')chip='<span class="chip ch-off">‚¨Ü OFFERED</span>';
    else if(st.status==='accepted')chip='<span class="chip ch-acc">‚úì ACCEPTED</span>';
    else if(st.status==='rejected')chip='<span class="chip ch-rej">‚úó REJECTED</span>';

    if(canOffer&&!locked&&(st.status==='pending'||st.status==='rejected'))
      action=`<button class="abtn ab-blue" onclick="openOfferModal('${seam.id}',${i})">OFFER ‚Üë</button>`;
    if(canInspect&&st.status==='offered')
      action=`<button class="abtn ab-green" onclick="openInspectModal('${seam.id}',${i})">INSPECT ‚ñ∏</button>`;

    let detail='';
    if(st.offeredAt)detail+=`Offered: ${st.offeredBy} (${st.offeredByCo}) @ ${st.offeredAt}`;
    if(st.location)detail+=` | üìç ${st.location}`;
    if(st.drawing)detail+=` | DRG: ${st.drawing}`;
    if(st.inspectedAt)detail+=`\nInspected: ${st.inspectedBy} @ ${st.inspectedAt}`;

    html+=`<div class="stage-row">
      <div class="sr-num">${String(i+1).padStart(2,'0')}</div>
      <div class="sr-info">
        <div class="sr-name">${st.name}</div>
        ${detail?`<div class="sr-detail">${detail.replace(/\n/g,'<br>')}</div>`:''}
        ${st.prodRem?`<div class="sr-remark" style="color:var(--blue2)">üîµ Prod: ${st.prodRem}</div>`:''}
        ${st.qeRem?`<div class="sr-remark" style="color:${st.status==='rejected'?'var(--red)':'var(--amber)'}">üîç QE: ${st.qeRem}</div>`:''}
      </div>
      <div class="sr-actions">${chip}${action}</div>
    </div>`;
  });

  html+='</div>';
  return html;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// OFFER FLOW
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openOfferModal(seamId,idx){
  const seam=getSeam(seamId);const st=seam.stages[idx];
  offerTarget={seamId,idx};
  $('of-loc').value='';$('of-drw').value='';$('of-rem').value='';
  $('offer-info').innerHTML=`
    <div class="ir"><span class="ir-k">Seam / Joint</span><span class="ir-v">${seam.num}</span></div>
    <div class="ir"><span class="ir-k">Description</span><span class="ir-v">${seam.desc}</span></div>
    <div class="ir"><span class="ir-k">Stage</span><span class="ir-v" style="color:var(--amber)">${st.name}</span></div>
    <div class="ir"><span class="ir-k">Section</span><span class="ir-v">${seam.sec}</span></div>
    <div class="ir"><span class="ir-k">Offered By</span><span class="ir-v">${CU.name} ¬∑ ${CU.co}</span></div>
  `;
  openModal('m-offer');
}

function confirmOffer(){
  if(!offerTarget)return;
  const{seamId,idx}=offerTarget;
  const seam=getSeam(seamId);const st=seam.stages[idx];
  st.status='offered';st.offeredBy=CU.name;st.offeredByMob=CU.mob;st.offeredByCo=CU.co;
  st.offeredAt=now();st.location=$('of-loc').value.trim();st.drawing=$('of-drw').value.trim();
  st.prodRem=$('of-rem').value.trim();st.inspectedBy='';st.inspectedAt='';st.qeRem='';
  log(`üîµ OFFERED ‚Äî ${seam.num} ¬∑ ${st.name}${st.location?' üìç'+st.location:''} by ${CU.name} (${CU.co})`);
  save();closeModal('m-offer');
  refreshCurrentView();
  toast('Stage offered for inspection','ok');
  sendWA(seamId,idx);
}

function sendWA(seamId,idx){
  const seam=getSeam(seamId);const st=seam.stages[idx];
  const qcList=DB.users.filter(u=>u.role==='quality'&&u.pid===CU.pid&&u.approved);
  if(!qcList.length)return;
  const p=getProj(CU.pid);
  const msg=encodeURIComponent(`üîî *TQIMS Inspection Offer*\nProject: #${p.number} ‚Äî ${p.equipment}\nSection: ${seam.sec}\nSeam: ${seam.num}\nStage: ${st.name}\nLocation: ${st.location||'‚Äî'}\nOffered By: ${CU.name} (${CU.co})\nTime: ${st.offeredAt}\n\nPlease inspect and update TQIMS.`);
  const mob=qcList[0].mob.replace(/\D/g,'');
  if(confirm(`Send WhatsApp notification to QC: ${qcList[0].name} (${qcList[0].mob})?`))
    window.open(`https://wa.me/${mob}?text=${msg}`,'_blank');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INSPECT FLOW
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openInspectModal(seamId,idx){
  const seam=getSeam(seamId);const st=seam.stages[idx];
  inspTarget={seamId,idx};$('ins-rem').value='';
  $('inspect-info').innerHTML=`
    <div class="ir"><span class="ir-k">Seam / Joint</span><span class="ir-v">${seam.num}</span></div>
    <div class="ir"><span class="ir-k">Description</span><span class="ir-v">${seam.desc}</span></div>
    <div class="ir"><span class="ir-k">Stage</span><span class="ir-v" style="color:var(--amber)">${st.name}</span></div>
    <div class="ir"><span class="ir-k">Section</span><span class="ir-v">${seam.sec}</span></div>
    <div class="ir"><span class="ir-k">Offered By</span><span class="ir-v">${st.offeredBy} (${st.offeredByCo})</span></div>
    <div class="ir"><span class="ir-k">Offered At</span><span class="ir-v">${st.offeredAt}</span></div>
    ${st.location?`<div class="ir"><span class="ir-k">Location</span><span class="ir-v">üìç ${st.location}</span></div>`:''}
    ${st.drawing?`<div class="ir"><span class="ir-k">Drawing Ref.</span><span class="ir-v">${st.drawing}</span></div>`:''}
    ${st.prodRem?`<div class="ir"><span class="ir-k">Prod. Remarks</span><span class="ir-v">${st.prodRem}</span></div>`:''}
    <div class="ir"><span class="ir-k">Material</span><span class="ir-v">${seam.mat} ¬∑ ${seam.thk}mm ¬∑ ${seam.type}</span></div>
  `;
  openModal('m-inspect');
}

function submitInspect(result){
  if(!inspTarget)return;
  const{seamId,idx}=inspTarget;
  const seam=getSeam(seamId);const st=seam.stages[idx];
  st.status=result;st.inspectedBy=CU.name;st.inspectedAt=now();st.qeRem=$('ins-rem').value.trim();
  log(`${result==='accepted'?'‚úÖ':'‚ùå'} ${result.toUpperCase()} ‚Äî ${seam.num} ¬∑ ${st.name} by ${CU.name}${st.qeRem?' ‚Äî '+st.qeRem:''}`);
  save();closeModal('m-inspect');
  refreshCurrentView();
  toast(`Stage ${result}`,'ok');
}

function refreshCurrentView(){
  const activePg=document.querySelector('.pg.on');
  if(!activePg)return;
  const id=activePg.id;
  if(id==='pg-dashboard')renderDashboard();
  else if(id==='pg-inspection')renderInspection();
  else if(id==='pg-seam')renderSeamDetailContent(activeSeamId);
  updateBadge();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ADMIN ‚Äî PROJECTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderProjectsPage(){
  $('proj-list').innerHTML=DB.projects.map(p=>`
    <div style="display:flex;align-items:flex-start;justify-content:space-between;padding:10px 0;border-bottom:1px solid rgba(33,38,45,.7);flex-wrap:wrap;gap:8px;">
      <div>
        <div style="font-family:'Barlow Condensed',sans-serif;font-size:15px;font-weight:700;color:var(--blue2);">Project #${p.number} ‚Äî ${p.equipment}</div>
        <div style="font-size:12px;color:var(--text2);margin-top:2px;">${p.client||'‚Äî'} ¬∑ ${p.process||'‚Äî'} ¬∑ ${p.code||'‚Äî'}</div>
        <div style="font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--text3);margin-top:3px;">${p.sections.join(' | ')}</div>
      </div>
      <div style="display:flex;gap:6px;">
        <button class="abtn ab-amber" onclick="editProj('${p.id}')">EDIT</button>
        <button class="abtn ab-red" onclick="delProj('${p.id}')">DEL</button>
      </div>
    </div>`).join('')||empty('No projects yet.');
  populateSelects();
  renderAdminSeams();
}

function confirmAddProj(){
  const num=$('np-num').value.trim(),eq=$('np-eq').value.trim();
  if(!num||!eq){toast('Project number and equipment required','err');return;}
  const secs=$('np-secs').value.split(',').map(s=>s.trim()).filter(Boolean);
  const newProj={id:'p'+Date.now(),number:num,equipment:eq,client:$('np-cl').value.trim(),process:$('np-pr').value.trim(),sections:secs.length?secs:['General'],code:$('np-code').value.trim()};
  DB.pendingActions.push({id:'pa'+Date.now(),type:'add_proj',data:newProj,requestedBy:CU.name,requestedAt:now(),desc:`Add Project: #${num} ‚Äî ${eq}`});
  log(`üìã PENDING APPROVAL ‚Äî Add Project #${num} requested by ${CU.name}`);save();
  closeModal('m-add-proj');renderProjectsPage();
  toast('‚úì Project add request sent to Manager for approval','ok');
}

function editProj(id){
  const p=getProj(id);
  const num=prompt('Project Number:',p.number);if(!num)return;
  const eq=prompt('Equipment Name:',p.equipment)||p.equipment;
  const cl=prompt('Client:',p.client)||p.client;
  const secs=prompt('Sections (comma separated):',p.sections.join(', '));
  const updated={id,number:num,equipment:eq,client:cl,sections:secs?secs.split(',').map(s=>s.trim()).filter(Boolean):p.sections,code:p.code,process:p.process};
  DB.pendingActions.push({id:'pa'+Date.now(),type:'edit_proj',data:updated,requestedBy:CU.name,requestedAt:now(),desc:`Edit Project: #${p.number} ‚Üí #${num} ${eq}`});
  log(`üìã PENDING APPROVAL ‚Äî Edit Project #${p.number} requested by ${CU.name}`);save();
  renderProjectsPage();toast('‚úì Project edit request sent to Manager for approval','ok');
}

function delProj(id){
  if(!confirm('Request deletion of this project? Manager must approve.'))return;
  const p=getProj(id);
  DB.pendingActions.push({id:'pa'+Date.now(),type:'del_proj',data:{id},requestedBy:CU.name,requestedAt:now(),desc:`Delete Project: #${p.number} ‚Äî ${p.equipment}`});
  log(`üìã PENDING APPROVAL ‚Äî Delete Project #${p.number} requested by ${CU.name}`);save();
  renderProjectsPage();toast('‚úì Deletion request sent to Manager for approval','ok');
}

function renderAdminSeams(){
  const pid=$('fp')&&$('fp').value||DB.projects[0]&&DB.projects[0].id;
  const seams=DB.seams.filter(s=>s.pid===pid);
  $('seam-tbody').innerHTML=seams.map(s=>{
    const ss=stageStats(s);
    return`<tr>
      <td>${s.sec}</td>
      <td style="font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--blue2);">${s.num}</td>
      <td>${s.desc}</td>
      <td style="font-size:11px;">${s.type}</td>
      <td style="font-size:11px;">${s.mat}</td>
      <td style="font-family:'JetBrains Mono',monospace;font-size:11px;">${s.thk}</td>
      <td style="font-family:'JetBrains Mono',monospace;font-size:11px;">${s.wps||'‚Äî'}</td>
      <td style="font-family:'JetBrains Mono',monospace;font-size:10px;">${s.stages.length} stages</td>
      <td style="min-width:80px;">
        <div style="font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--cyan);">${ss.a}/${ss.t}</div>
        <div class="pbar"><div class="pfill" style="width:${ss.pct}%"></div></div>
      </td>
      <td>
        <div style="display:flex;gap:4px;flex-wrap:wrap;">
          <button class="abtn ab-amber" onclick="openEditSeam('${s.id}')">EDIT</button>
          <button class="abtn ab-blue" onclick="dupeSeam('${s.id}')" title="Duplicate seam">DUPE</button>
          <button class="abtn ab-red" onclick="delSeam('${s.id}')">DEL</button>
        </div>
      </td>
    </tr>`;
  }).join('')||`<tr><td colspan="10" style="text-align:center;padding:20px;color:var(--text3);">No seams</td></tr>`;
}

function addSeam(){
  const pid=$('ns-proj').value,sec=$('ns-sec').value,num=$('ns-num').value.trim(),desc=$('ns-desc').value.trim();
  if(!num||!desc){toast('Seam number and description required','err');return;}
  const tmplId=$('ns-tmpl').value;
  const tmpl=DB.templates.find(t=>t.id===tmplId);
  const stages=mkStages(tmpl?tmpl.stages.slice():DEFAULT_STAGES.slice());
  const newSeam={id:'s'+Date.now(),pid,sec,num,desc,type:$('ns-type').value,mat:$('ns-mat').value.trim()||'N/A',thk:$('ns-thk').value.trim()||'N/A',wps:$('ns-wps').value.trim()||'‚Äî',stages};
  // Submit for Manager approval
  DB.pendingActions.push({id:'pa'+Date.now(),type:'add_seam',data:newSeam,requestedBy:CU.name,requestedAt:now(),desc:`Add Seam: ${num} ‚Äî ${desc} in ${sec}`});
  log(`üìã PENDING APPROVAL ‚Äî Add Seam: ${num} requested by ${CU.name}`);save();
  ['ns-num','ns-desc','ns-mat','ns-thk','ns-wps'].forEach(id=>$(id).value='');
  renderAdminSeams();
  toast('‚úì Seam add request sent to Manager for approval','ok');
}

function openEditSeam(id){
  const s=getSeam(id);
  $('es-id').value=id;$('es-num').value=s.num;$('es-desc').value=s.desc;
  $('es-mat').value=s.mat;$('es-thk').value=s.thk;$('es-wps').value=s.wps||'';
  const pid=s.pid;const secs=getSections(pid);
  $('es-sec').innerHTML=secs.map(sec=>`<option ${sec===s.sec?'selected':''}>${sec}</option>`).join('');
  $('es-type').value=s.type;
  openModal('m-edit-seam');
}

function saveSeamEdit(){
  const id=$('es-id').value;const s=getSeam(id);
  const updatedData={id,sec:$('es-sec').value,num:$('es-num').value.trim(),desc:$('es-desc').value.trim(),type:$('es-type').value,mat:$('es-mat').value.trim(),thk:$('es-thk').value.trim(),wps:$('es-wps').value.trim()};
  DB.pendingActions.push({id:'pa'+Date.now(),type:'edit_seam',data:updatedData,requestedBy:CU.name,requestedAt:now(),desc:`Edit Seam: ${s.num} ‚Üí ${updatedData.num}`});
  log(`üìã PENDING APPROVAL ‚Äî Edit Seam: ${s.num} requested by ${CU.name}`);save();
  closeModal('m-edit-seam');renderAdminSeams();
  toast('‚úì Seam edit request sent to Manager for approval','ok');
}

function dupeSeam(id){
  const s=getSeam(id);
  const newNum=prompt('New Seam Number for duplicate:',s.num+' (Copy)');
  if(!newNum)return;
  const newSeam={id:'s'+Date.now(),pid:s.pid,sec:s.sec,num:newNum,desc:s.desc,type:s.type,mat:s.mat,thk:s.thk,wps:s.wps,stages:mkStages(s.stages.map(st=>st.name))};
  DB.pendingActions.push({id:'pa'+Date.now(),type:'add_seam',data:newSeam,requestedBy:CU.name,requestedAt:now(),desc:`Duplicate Seam: ${s.num} ‚Üí ${newNum}`});
  log(`üìã PENDING APPROVAL ‚Äî Duplicate Seam: ${newNum} from ${s.num} requested by ${CU.name}`);save();
  renderAdminSeams();toast('‚úì Duplication request sent to Manager for approval','ok');
}

function delSeam(id){
  if(!confirm('Request deletion of this seam? Manager must approve.'))return;
  const s=getSeam(id);
  DB.pendingActions.push({id:'pa'+Date.now(),type:'del_seam',data:{id},requestedBy:CU.name,requestedAt:now(),desc:`Delete Seam: ${s.num} ‚Äî ${s.desc}`});
  log(`üìã PENDING APPROVAL ‚Äî Delete Seam: ${s.num} requested by ${CU.name}`);save();
  renderAdminSeams();toast('‚úì Deletion request sent to Manager for approval','ok');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ADMIN ‚Äî STAGE TEMPLATES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderStagesPage(){
  $('stage-editor-card').style.display='none';
  $('tmpl-list').innerHTML=DB.templates.map(t=>`
    <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid rgba(33,38,45,.7);flex-wrap:wrap;gap:8px;">
      <div>
        <div style="font-weight:600;font-size:14px;">${t.name}</div>
        <div style="font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--text3);margin-top:2px;">${t.stages.length} stages</div>
      </div>
      <div style="display:flex;gap:6px;">
        <button class="abtn ab-blue" onclick="openTmplEditor('${t.id}')">EDIT STAGES</button>
        <button class="abtn ab-amber" onclick="renameTmpl('${t.id}')">RENAME</button>
        <button class="abtn ab-blue" onclick="dupeTmpl('${t.id}')">DUPE</button>
        ${DB.templates.length>1?`<button class="abtn ab-red" onclick="delTmpl('${t.id}')">DEL</button>`:''}
      </div>
    </div>`).join('');
}

function addTemplate(){
  const name=prompt('Template name:','New Inspection Template');
  if(!name)return;
  DB.templates.push({id:'t'+Date.now(),name,stages:DEFAULT_STAGES.slice()});
  save();renderStagesPage();refreshTmplSelect();toast('Template created','ok');
}

function renameTmpl(id){
  const t=DB.templates.find(t=>t.id===id);
  const name=prompt('New name:',t.name);
  if(!name)return;
  t.name=name;save();renderStagesPage();refreshTmplSelect();toast('Renamed','ok');
}

function dupeTmpl(id){
  const t=DB.templates.find(t=>t.id===id);
  const name=prompt('Name for duplicate:',t.name+' (Copy)');
  if(!name)return;
  DB.templates.push({id:'t'+Date.now(),name,stages:t.stages.slice()});
  save();renderStagesPage();refreshTmplSelect();toast('Duplicated','ok');
}

function delTmpl(id){
  if(!confirm('Delete this template?'))return;
  DB.templates=DB.templates.filter(t=>t.id!==id);
  save();renderStagesPage();refreshTmplSelect();toast('Template removed');
}

function openTmplEditor(id){
  editTmplId=id;
  const t=DB.templates.find(t=>t.id===id);
  $('stage-editor-title').textContent=`Editing: ${t.name}`;
  $('stage-editor-card').style.display='block';
  renderStageLines();
}

function closeStageEditor(){
  $('stage-editor-card').style.display='none';editTmplId=null;
}

function renderStageLines(){
  if(!editTmplId)return;
  const t=DB.templates.find(t=>t.id===editTmplId);
  $('stage-lines').innerHTML=t.stages.map((s,i)=>`
    <div class="stage-list-item">
      <span class="sli-handle">‚†ø</span>
      <input style="flex:1;background:transparent;border:none;border-bottom:1px solid var(--border2);color:var(--text);padding:4px 6px;font-family:'Barlow',sans-serif;font-size:13px;" value="${s}" onchange="updateStageName('${t.id}',${i},this.value)">
      <div class="sli-actions">
        ${i>0?`<button class="abtn ab-ghost" style="padding:2px 6px;" onclick="moveStage('${t.id}',${i},-1)">‚Üë</button>`:'<span style="width:28px;"></span>'}
        ${i<t.stages.length-1?`<button class="abtn ab-ghost" style="padding:2px 6px;" onclick="moveStage('${t.id}',${i},1)">‚Üì</button>`:'<span style="width:28px;"></span>'}
        <button class="abtn ab-red" style="padding:2px 8px;" onclick="removeStage('${t.id}',${i})">‚úï</button>
      </div>
    </div>`).join('');
}

function updateStageName(tid,i,val){
  const t=DB.templates.find(t=>t.id===tid);t.stages[i]=val;save();
}

function addStageLine(){
  const t=DB.templates.find(t=>t.id===editTmplId);
  const name=prompt('New stage name:','');
  if(!name)return;
  t.stages.push(name);save();renderStageLines();toast('Stage added','ok');
}

function moveStage(tid,i,dir){
  const t=DB.templates.find(t=>t.id===tid);
  const j=i+dir;if(j<0||j>=t.stages.length)return;
  [t.stages[i],t.stages[j]]=[t.stages[j],t.stages[i]];save();renderStageLines();
}

function removeStage(tid,i){
  const t=DB.templates.find(t=>t.id===tid);
  if(!confirm(`Remove stage "${t.stages[i]}"?`))return;
  t.stages.splice(i,1);save();renderStageLines();toast('Stage removed');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ADMIN ‚Äî USERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderUsers(){
  $('user-tbody').innerHTML=DB.users.map(u=>`<tr>
    <td><strong>${u.name}</strong></td>
    <td style="font-family:'JetBrains Mono',monospace;font-size:11px;">${u.mob}</td>
    <td>${u.co||'‚Äî'}</td>
    <td style="font-size:11px;">${u.desig||'‚Äî'}</td>
    <td><span class="rpill rp-${u.role}" style="font-size:8px;">${u.role}</span></td>
    <td style="font-size:11px;">${getProj(u.pid)?.number||'‚Äî'}</td>
    <td>${u.approved?'<span style="color:var(--green);font-size:11px;">‚úì Active</span>':'<span style="color:var(--amber);font-size:11px;">‚è≥ Pending</span>'}</td>
    <td>
      <div style="display:flex;gap:4px;flex-wrap:wrap;">
        ${!u.approved?`<button class="abtn ab-green" onclick="approveUser('${u.id}')">APPROVE</button>`:''}
        <button class="abtn ab-amber" onclick="changeRole('${u.id}')">ROLE</button>
        ${u.id!=='u0'?`<button class="abtn ab-red" onclick="delUser('${u.id}')">DEL</button>`:''}
      </div>
    </td>
  </tr>`).join('');
}

function adminAddUser(){
  const name=$('au-name').value.trim(),mob=$('au-mob').value.trim(),pw=$('au-pw').value;
  if(!name||!mob||!pw){toast('Name, mobile and password required','err');return;}
  if(DB.users.find(u=>u.mob===mob)){toast('Mobile already registered','err');return;}
  DB.users.push({id:'u'+Date.now(),name,mob,email:'',co:$('au-co').value.trim(),desig:$('au-desig').value.trim(),role:$('au-role').value,pid:$('au-proj').value,pw,approved:true});
  log(`üë§ USER ADDED ‚Äî ${name}`);save();closeModal('m-add-user');renderUsers();toast('User added','ok');
}

function approveUser(id){
  const u=DB.users.find(u=>u.id===id);u.approved=true;
  log(`‚úÖ APPROVED ‚Äî ${u.name}`);save();renderUsers();toast(`${u.name} approved`,'ok');
}

function changeRole(id){
  const u=DB.users.find(u=>u.id===id);
  const r=prompt('New role (admin/production/quality/manager):',u.role);
  if(!r||!['admin','production','quality','manager'].includes(r)){toast('Invalid role','err');return;}
  u.role=r;log(`üîÑ ROLE CHANGED ‚Äî ${u.name} ‚Üí ${r}`);save();renderUsers();toast('Role updated','ok');
}

function delUser(id){
  if(!confirm('Delete this user?'))return;
  const u=DB.users.find(u=>u.id===id);DB.users=DB.users.filter(us=>us.id!==id);
  log(`üóëÔ∏è USER DELETED ‚Äî ${u.name}`);save();renderUsers();toast('User removed');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LOG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderLog(){
  $('log-body').innerHTML=DB.log.length?DB.log.map(l=>`
    <div class="log-row">
      <div class="log-time">${l.t} ¬∑ ${(l.role||'').toUpperCase()} ¬∑ ${l.user}${l.co?' ('+l.co+')':''}</div>
      <div class="log-msg">${l.msg}</div>
    </div>`).join(''):empty('No activity yet.');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PRINT SUMMARY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderSummaryPage(){
  const opts=DB.projects.map(p=>`<option value="${p.id}">Project #${p.number} ‚Äî ${p.equipment}</option>`).join('');
  $('print-proj').innerHTML=opts;
  refreshPrintSecs();
  buildPrintPreview();
}

function buildPrintPreview(){
  const pid=$('print-proj')&&$('print-proj').value||DB.projects[0]?.id;
  const filterSec=$('print-sec')&&$('print-sec').value||'';
  const p=getProj(pid);if(!p){$('print-preview').innerHTML=empty('Select a project');return;}
  const st=overallStats(pid);
  const today=new Date().toLocaleDateString('en-IN',{day:'2-digit',month:'long',year:'numeric'});
  const sections=filterSec?[filterSec]:getSections(pid);

  let html=`<div id="printable">
  <div style="text-align:center;padding-bottom:14px;margin-bottom:16px;border-bottom:2px solid var(--blue);">
    <div style="font-family:'Barlow Condensed',sans-serif;font-size:30px;font-weight:800;letter-spacing:5px;color:var(--blue2);">TQIMS</div>
    <div style="font-size:11px;letter-spacing:2px;color:var(--text2);text-transform:uppercase;">Quality Inspection Management System</div>
    <div style="font-size:12px;color:var(--text3);margin-top:4px;">Inspection Summary Report</div>
  </div>
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:12px;margin-bottom:14px;">
    <div><b>Project No.:</b> ${p.number}</div><div><b>Equipment:</b> ${p.equipment}</div>
    <div><b>Client:</b> ${p.client||'‚Äî'}</div><div><b>Process:</b> ${p.process||'‚Äî'}</div>
    <div><b>Code/Standard:</b> ${p.code||'‚Äî'}</div><div><b>Report Date:</b> ${today}</div>
    <div><b>Total Seams:</b> ${st.seams}</div><div><b>Completion:</b> ${st.p}%</div>
  </div>
  <div style="font-size:12px;margin-bottom:16px;display:flex;gap:16px;flex-wrap:wrap;">
    <span style="color:var(--green)">‚úì Accepted: ${st.a}</span>
    <span style="color:var(--amber)">‚¨Ü Awaiting QC: ${st.o}</span>
    <span style="color:var(--red)">‚úó Rejected: ${st.r}</span>
    <span style="color:var(--text3)">‚óã Pending: ${st.t-st.a-st.o-st.r}</span>
  </div>`;

  sections.forEach(sec=>{
    const seams=getSeams(pid,sec);if(!seams.length)return;
    html+=`<div style="margin-bottom:18px;">
      <div style="font-family:'Barlow Condensed',sans-serif;font-size:15px;font-weight:800;letter-spacing:2px;text-transform:uppercase;color:var(--blue2);border-bottom:1px solid var(--border2);padding-bottom:5px;margin-bottom:10px;">SECTION: ${sec}</div>`;
    seams.forEach(seam=>{
      const ss=stageStats(seam);const ncr=hasNCR(seam);
      html+=`<div style="margin-bottom:12px;border:1px solid var(--border2);overflow:hidden;border-radius:2px;">
        <div style="background:var(--surf2);padding:8px 12px;display:flex;justify-content:space-between;flex-wrap:wrap;gap:4px;">
          <div>
            <div style="font-family:'JetBrains Mono',monospace;font-size:12px;font-weight:600;color:var(--blue2);">${seam.num}${ncr?' <span style="color:var(--red);border:1px solid var(--red);padding:1px 4px;font-size:8px;">NCR</span>':''}</div>
            <div style="font-size:11px;color:var(--text2);">${seam.desc} ¬∑ ${seam.type} ¬∑ ${seam.mat} ¬∑ ${seam.thk}mm ¬∑ WPS: ${seam.wps||'‚Äî'}</div>
          </div>
          <div style="font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--cyan);">${ss.a}/${ss.t} ¬∑ ${ss.pct}%</div>
        </div>
        <table style="width:100%;border-collapse:collapse;font-size:10px;">
          <thead><tr>
            <th style="background:rgba(22,27,34,.8);padding:5px 8px;text-align:left;font-family:'JetBrains Mono',monospace;font-size:8px;letter-spacing:1px;color:var(--text3);">#</th>
            <th style="background:rgba(22,27,34,.8);padding:5px 8px;text-align:left;font-family:'JetBrains Mono',monospace;font-size:8px;letter-spacing:1px;color:var(--text3);">Stage</th>
            <th style="background:rgba(22,27,34,.8);padding:5px 8px;text-align:left;font-family:'JetBrains Mono',monospace;font-size:8px;letter-spacing:1px;color:var(--text3);">Status</th>
            <th style="background:rgba(22,27,34,.8);padding:5px 8px;text-align:left;font-family:'JetBrains Mono',monospace;font-size:8px;letter-spacing:1px;color:var(--text3);">Offered By / Company</th>
            <th style="background:rgba(22,27,34,.8);padding:5px 8px;text-align:left;font-family:'JetBrains Mono',monospace;font-size:8px;letter-spacing:1px;color:var(--text3);">Location</th>
            <th style="background:rgba(22,27,34,.8);padding:5px 8px;text-align:left;font-family:'JetBrains Mono',monospace;font-size:8px;letter-spacing:1px;color:var(--text3);">Inspected By</th>
            <th style="background:rgba(22,27,34,.8);padding:5px 8px;text-align:left;font-family:'JetBrains Mono',monospace;font-size:8px;letter-spacing:1px;color:var(--text3);">QE Remarks</th>
          </tr></thead>
          <tbody>${seam.stages.map((st,i)=>{
            const sc=st.status==='accepted'?'var(--green)':st.status==='rejected'?'var(--red)':st.status==='offered'?'var(--amber)':'var(--text3)';
            return`<tr><td style="padding:4px 8px;border-bottom:1px solid rgba(33,38,45,.5);font-family:'JetBrains Mono',monospace;">${i+1}</td>
              <td style="padding:4px 8px;border-bottom:1px solid rgba(33,38,45,.5);">${st.name}</td>
              <td style="padding:4px 8px;border-bottom:1px solid rgba(33,38,45,.5);color:${sc};font-weight:600;text-transform:uppercase;font-size:9px;">${st.status}</td>
              <td style="padding:4px 8px;border-bottom:1px solid rgba(33,38,45,.5);font-size:10px;">${st.offeredBy?st.offeredBy+'<br><span style="color:var(--text3);font-size:9px;">'+st.offeredByCo+'</span><br><span style="color:var(--text3);font-size:9px;">'+st.offeredAt+'</span>':'‚Äî'}</td>
              <td style="padding:4px 8px;border-bottom:1px solid rgba(33,38,45,.5);">${st.location||'‚Äî'}</td>
              <td style="padding:4px 8px;border-bottom:1px solid rgba(33,38,45,.5);font-size:10px;">${st.inspectedBy?st.inspectedBy+'<br><span style="color:var(--text3);font-size:9px;">'+st.inspectedAt+'</span>':'‚Äî'}</td>
              <td style="padding:4px 8px;border-bottom:1px solid rgba(33,38,45,.5);">${st.qeRem||'‚Äî'}</td>
            </tr>`;
          }).join('')}</tbody>
        </table></div>`;
    });
    html+='</div>';
  });

  // Signature block
  html+=`<div style="margin-top:28px;border-top:1px solid var(--border2);padding-top:18px;">
    <div style="font-family:'Barlow Condensed',sans-serif;font-size:13px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--text2);margin-bottom:18px;">AUTHORIZATIONS & SIGNATURES</div>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:20px;">
      ${['Quality Engineer (QE)','CTR Representative','CPY (Company)'].map(r=>`
      <div style="border:1px solid var(--border2);padding:14px;">
        <div style="font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:1px;color:var(--text2);margin-bottom:36px;">${r}</div>
        <div style="border-top:1px solid var(--text3);margin-bottom:6px;"></div>
        <div style="font-size:10px;color:var(--text3);">Name: ________________________</div>
        <div style="font-size:10px;color:var(--text3);margin-top:4px;">Date: _________________________</div>
      </div>`).join('')}
    </div>
  </div>
  <div style="margin-top:16px;text-align:center;font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--text3);border-top:1px solid var(--border2);padding-top:10px;">
    TQIMS ¬∑ Quality Inspection Management System ¬∑ Designed by Ujval Dharawaparmar ¬∑ Generated: ${today}
  </div></div>`;

  $('print-preview').innerHTML=html;
}

function doPrint(){
  buildPrintPreview();
  setTimeout(()=>{
    const c=$('printable');if(!c)return;
    const w=window.open('','_blank');
    w.document.write(`<!DOCTYPE html><html><head><title>TQIMS Report</title>
    <style>*{box-sizing:border-box;margin:0;padding:0;}body{font-family:Arial,sans-serif;background:#fff;color:#111;padding:12mm;font-size:10pt;}@media print{@page{size:A4;margin:10mm;}body{padding:0;}}</style>
    </head><body>`);
    // Write a clean light-theme version
    const clone=c.innerHTML
      .replace(/var\(--blue2\)/g,'#1f6feb').replace(/var\(--blue\)/g,'#1f6feb')
      .replace(/var\(--cyan\)/g,'#0891b2').replace(/var\(--green\)/g,'#059669')
      .replace(/var\(--red\)/g,'#dc2626').replace(/var\(--amber\)/g,'#d97706')
      .replace(/var\(--text\)/g,'#111').replace(/var\(--text2\)/g,'#374151')
      .replace(/var\(--text3\)/g,'#6b7280').replace(/var\(--border2\)/g,'#d1d5db')
      .replace(/var\(--border\)/g,'#e5e7eb').replace(/var\(--surf2\)/g,'#f3f4f6')
      .replace(/var\(--surf\)/g,'#fff').replace(/rgba\(22,27,34,\.8\)/g,'#f3f4f6')
      .replace(/rgba\(33,38,45,.*/g,'#e5e7eb)').replace(/rgba\(22,27,34.*?\)/g,'#f3f4f6');
    w.document.write(clone);
    w.document.write('</body></html>');w.document.close();w.focus();
    setTimeout(()=>w.print(),600);
  },200);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PROFILE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderProfile(){
  if(!CU)return;
  const p=getProj(CU.pid);
  $('profile-rows').innerHTML=`
    <div class="ir"><span class="ir-k">Full Name</span><span class="ir-v">${CU.name}</span></div>
    <div class="ir"><span class="ir-k">Mobile</span><span class="ir-v">${CU.mob}</span></div>
    <div class="ir"><span class="ir-k">Email</span><span class="ir-v">${CU.email||'‚Äî'}</span></div>
    <div class="ir"><span class="ir-k">Company</span><span class="ir-v">${CU.co||'‚Äî'}</span></div>
    <div class="ir"><span class="ir-k">Designation</span><span class="ir-v">${CU.desig||'‚Äî'}</span></div>
    <div class="ir"><span class="ir-k">Role</span><span class="ir-v"><span class="rpill rp-${CU.role}">${CU.role.toUpperCase()}</span></span></div>
    <div class="ir"><span class="ir-k">Project</span><span class="ir-v">${p?`#${p.number} ‚Äî ${p.equipment}`:'‚Äî'}</span></div>
  `;
  $('cp-cur').value='';$('cp-new').value='';$('cp-cnf').value='';$('cp-msg').innerHTML='';
  $('secret-key-card').style.display=CU.role==='admin'?'block':'none';
  if(CU.role==='admin'){$('sk-cur').value='';$('sk-new').value='';$('sk-cnf').value='';$('sk-msg').innerHTML='';}
}

function changePassword(){
  const cur=$('cp-cur').value,nw=$('cp-new').value,cnf=$('cp-cnf').value;
  if(!cur||!nw||!cnf){$('cp-msg').innerHTML='<div class="msg msg-err">Fill all fields.</div>';return;}
  if(cur!==CU.pw){$('cp-msg').innerHTML='<div class="msg msg-err">Current password incorrect.</div>';return;}
  if(nw.length<6){$('cp-msg').innerHTML='<div class="msg msg-err">Min 6 characters.</div>';return;}
  if(nw!==cnf){$('cp-msg').innerHTML='<div class="msg msg-err">New passwords do not match.</div>';return;}
  const u=DB.users.find(u=>u.id===CU.id);u.pw=nw;CU.pw=nw;
  log(`üîí PASSWORD CHANGED ‚Äî ${CU.name}`);save();
  $('cp-msg').innerHTML='<div class="msg msg-ok">‚úì Password updated!</div>';
  $('cp-cur').value='';$('cp-new').value='';$('cp-cnf').value='';
  toast('Password changed','ok');
}

function changeSecretKey(){
  const cur=$('sk-cur').value,nw=$('sk-new').value,cnf=$('sk-cnf').value;
  if(!cur||!nw||!cnf){$('sk-msg').innerHTML='<div class="msg msg-err">Fill all fields.</div>';return;}
  if(cur!==DB.secretKey){$('sk-msg').innerHTML='<div class="msg msg-err">Current key incorrect.</div>';return;}
  if(nw.length<8){$('sk-msg').innerHTML='<div class="msg msg-err">Min 8 characters.</div>';return;}
  if(nw!==cnf){$('sk-msg').innerHTML='<div class="msg msg-err">Keys do not match.</div>';return;}
  DB.secretKey=nw;log(`üîë SECRET KEY CHANGED by ${CU.name}`);save();
  $('sk-msg').innerHTML='<div class="msg msg-ok">‚úì Secret key updated!</div>';
  $('sk-cur').value='';$('sk-new').value='';$('sk-cnf').value='';
  toast('Secret key updated','ok');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MANAGER APPROVALS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateApprovalBadge(){
  const count=DB.pendingActions.length;
  const nb=$('nb-approvals');
  if(nb){nb.style.display=count>0?'inline':'none';nb.textContent=count;}
}

function renderApprovals(){
  updateApprovalBadge();
  if(!DB.pendingActions.length){
    $('approvals-body').innerHTML=`<div style="text-align:center;padding:40px;font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--green);">‚úì No pending approvals. All up to date.</div>`;
    return;
  }
  $('approvals-body').innerHTML=`
    <div class="chead"><div class="ctitle">Pending Requests (${DB.pendingActions.length})</div></div>
    ${DB.pendingActions.map(a=>`
      <div style="display:flex;align-items:flex-start;justify-content:space-between;padding:14px 0;border-bottom:1px solid rgba(33,38,45,.7);flex-wrap:wrap;gap:10px;">
        <div style="flex:1;min-width:200px;">
          <div style="font-weight:600;font-size:13px;margin-bottom:3px;">${a.desc}</div>
          <div style="font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--text3);">Requested by: ${a.requestedBy} ¬∑ ${a.requestedAt}</div>
          <div style="margin-top:5px;">
            ${a.type==='add_seam'||a.type==='edit_seam'?`<span class="chip ch-off" style="font-size:8px;">SEAM CHANGE</span>`:
              a.type==='del_seam'?`<span class="chip ch-rej" style="font-size:8px;">DELETE SEAM</span>`:
              a.type==='add_proj'?`<span class="chip ch-off" style="font-size:8px;">NEW PROJECT</span>`:
              a.type==='edit_proj'?`<span class="chip ch-off" style="font-size:8px;">EDIT PROJECT</span>`:
              `<span class="chip ch-rej" style="font-size:8px;">DELETE PROJECT</span>`}
          </div>
        </div>
        <div style="display:flex;gap:8px;align-items:center;">
          <button class="abtn ab-red" onclick="rejectAction('${a.id}')">‚úó REJECT</button>
          <button class="abtn ab-green" onclick="approveAction('${a.id}')">‚úì APPROVE</button>
        </div>
      </div>`).join('')}
  `;
}

function approveAction(id){
  const a=DB.pendingActions.find(x=>x.id===id);
  if(!a)return;
  if(a.type==='add_seam'){DB.seams.push(a.data);log(`‚úÖ APPROVED & ADDED ‚Äî ${a.desc} (approved by ${CU.name})`);}
  else if(a.type==='edit_seam'){const s=getSeam(a.data.id);if(s){Object.assign(s,a.data);}log(`‚úÖ APPROVED & EDITED ‚Äî ${a.desc} (approved by ${CU.name})`);}
  else if(a.type==='del_seam'){DB.seams=DB.seams.filter(s=>s.id!==a.data.id);log(`‚úÖ APPROVED & DELETED ‚Äî ${a.desc} (approved by ${CU.name})`);}
  else if(a.type==='add_proj'){DB.projects.push(a.data);log(`‚úÖ APPROVED & ADDED ‚Äî ${a.desc} (approved by ${CU.name})`);}
  else if(a.type==='edit_proj'){const p=getProj(a.data.id);if(p){Object.assign(p,a.data);}log(`‚úÖ APPROVED & EDITED ‚Äî ${a.desc} (approved by ${CU.name})`);}
  else if(a.type==='del_proj'){DB.projects=DB.projects.filter(p=>p.id!==a.data.id);DB.seams=DB.seams.filter(s=>s.pid!==a.data.id);log(`‚úÖ APPROVED & DELETED ‚Äî ${a.desc} (approved by ${CU.name})`);}
  DB.pendingActions=DB.pendingActions.filter(x=>x.id!==id);
  save();populateSelects();renderApprovals();updateApprovalBadge();
  toast('Approved & applied','ok');
}

function rejectAction(id){
  const a=DB.pendingActions.find(x=>x.id===id);if(!a)return;
  log(`‚ùå REJECTED ‚Äî ${a.desc} (rejected by ${CU.name})`);
  DB.pendingActions=DB.pendingActions.filter(x=>x.id!==id);
  save();renderApprovals();updateApprovalBadge();
  toast('Request rejected');
}
(function init(){
  $('scr-auth').classList.add('on');
  showTab('login');
})();
</script>
</body>
</html>
